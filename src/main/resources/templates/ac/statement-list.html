<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
  <meta charset="UTF-8">
  <title>ì „í‘œ í†µí•©ê´€ë¦¬</title>

  <style>
    /* í™”ë©´ êµ¬ì„±ì— ë§ì¶° í•„ìš” ì‹œ ìˆ«ìë§Œ ì¡°ì • */
    #employee-table { height: calc(100vh - 260px); }
    .select-badge { font-size:.9rem; }
    .btn-type .btn { min-width:70px; }
    .input-with-icon { display:flex; gap:6px; align-items:center; }
    .input-with-icon .form-control { width: 220px; }
  </style>
</head>

<body layout:fragment="content">
  <div id="layoutSidenav_content">
    <main>
      <div class="container_fluid px-4">

        <div class="d-flex align-items-center justify-content-between mt-4 mb-2">
          <h1 class="mb-0">ì „í‘œ ê´€ë¦¬</h1>
          <span class="badge text-bg-info select-badge">ì„ íƒ <span id="sel-count">0</span>ê±´</span>
        </div>

        <!-- ìƒë‹¨ ì•¡ì…˜ -->
        <div class="d-flex align-items-center flex-wrap gap-2 mb-3">
          <a class="btn btn-outline-primary" th:href="@{/statements/sales/new}">ë§¤ì¶œì „í‘œ ë“±ë¡</a>
          <a class="btn btn-outline-primary" th:href="@{/statements/buy/new}">ë§¤ì…ì „í‘œ ë“±ë¡</a>

          <!-- ì „í‘œ ìœ í˜• í† ê¸€ -->
          <div class="btn-group btn-type ms-2" role="group" aria-label="type-filter">
            <button type="button" class="btn btn-primary" data-type="ALL">ì „ì²´</button>
            <button type="button" class="btn btn-outline-primary" data-type="SALES">ë§¤ì¶œ</button>
            <button type="button" class="btn btn-outline-primary" data-type="BUY">ë§¤ì…</button>
            <button type="button" class="btn btn-outline-primary" data-type="MONEY">ìˆ˜ê¸ˆ</button>
            <button type="button" class="btn btn-outline-primary" data-type="PAYMENT">ì§€ê¸‰</button>
          </div>

          <div class="ms-auto d-flex align-items-center gap-2">
            <button id="btn-print" class="btn btn-secondary">ì¸ì‡„</button>
            <button id="btn-export" class="btn btn-dark">Excel</button>
          </div>
        </div>

        <!-- ê²€ìƒ‰ ë°”: ê±°ë˜ì²˜ëª…/ì „í‘œë²ˆí˜¸ëŠ” ê³µí†µ ëª¨ë‹¬ë¡œ ì„ íƒ -->
        <div class="d-flex align-items-end flex-wrap gap-3 mb-2">
          <div>
            <label class="form-label">ê±°ë˜ì²˜ëª…</label>
            <div class="input-with-icon">
              <input id="partnerName" type="text" class="form-control" placeholder="ì„ íƒ ë˜ëŠ” ì…ë ¥" readonly>
              <button id="btn-find-partner" type="button" class="btn btn-outline-secondary" title="ê±°ë˜ì²˜ ì°¾ê¸°">ğŸ”</button>
            </div>
          </div>

          <div>
            <label class="form-label">ì „í‘œë²ˆí˜¸</label>
            <div class="input-with-icon">
              <input id="voucherNo" type="text" class="form-control" placeholder="ì„ íƒ ë˜ëŠ” ì…ë ¥" readonly>
              <button id="btn-find-voucher" type="button" class="btn btn-outline-secondary" title="ì „í‘œ ì°¾ê¸°">ğŸ”</button>
            </div>
          </div>

          <div>
            <label class="form-label">From</label>
            <input id="fromDate" type="date" class="form-control w-auto">
          </div>

          <div>
            <label class="form-label">To</label>
            <input id="toDate" type="date" class="form-control w-auto">
          </div>

          <div class="d-flex gap-2">
            <button id="btn-search" class="btn btn-warning">ê²€ìƒ‰</button>
            <button id="btn-reset" class="btn btn-outline-secondary">ì´ˆê¸°í™”</button>
          </div>
        </div>

        <!-- ë©”ì¸ í…Œì´ë¸” -->
        <div id="employee-table"></div>

      </div>
    </main>
  </div>
  <!-- ê³µí†µ ëª¨ë‹¬ fragment + ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ -->
  <div th:replace="~{common/modal :: commonModal}"></div>
  <script th:src="@{/main/js/modal.js}"></script>

  <!-- SheetJS (Excel) -->
  <script src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js"></script>

  <!-- í˜ì´ì§€ ì „ìš© ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
  /* ---------------- utils ---------------- */
  function toast(msg, ms=1800){
    const t=document.createElement('div');
    t.style.cssText='position:fixed;right:24px;bottom:24px;background:#333;color:#fff;padding:10px 14px;border-radius:8px;opacity:.95;z-index:1055;font-size:.95rem;';
    t.textContent=msg; document.body.appendChild(t);
    setTimeout(()=>t.remove(), ms);
  }

  function paramsFor(page0, size){
    return {
      type:       currentType,
      partner:    document.getElementById('partnerName').value || '',
      voucherNo:  document.getElementById('voucherNo').value || '',
      fromDate:   document.getElementById('fromDate').value || '',
      toDate:     document.getElementById('toDate').value || '',
      page:       page0 ?? 0,                 // Spring Page (0-base)
      size:       size ?? mainTable?.getPageSize() ?? 20,
    };
  }

  /* ---------------- ë©”ì¸ í…Œì´ë¸” ---------------- */
  let currentType = 'ALL';

  // âœ… ì´ë¦„ ì¶©ëŒ ë°©ì§€: table -> mainTable
  const mainTable = new Tabulator("#employee-table", {
    layout: "fitColumns",
    pagination: true,
    paginationMode: "remote",
    paginationSize: 20,
    paginationSizeSelector: [20,50,100],

    columns: [
      {
        titleFormatter:"rowSelection",
        formatter:"rowSelection",
        titleFormatterParams:{rowRange:"active"},
        headerSort:false, width:55, hozAlign:"center", headerHozAlign:"center"
      },
      { title:"ì „í‘œì¼ì", field:"voucherDate", hozAlign:"center",
        formatter:(cell)=>{
          const v=cell.getValue(); if(!v) return "";
          const d=new Date(v); return isNaN(d)? v : d.toISOString().slice(0,10);
        }
      },
      { title:"ì „í‘œë²ˆí˜¸", field:"voucherNo", hozAlign:"center", width:130 },
      { title:"ìœ í˜•", field:"type", hozAlign:"center", width:100,
        formatter:(cell)=>{
          const map={SALES:"ë§¤ì¶œ", BUY:"ë§¤ì…", MONEY:"ìˆ˜ê¸ˆ", PAYMENT:"ì§€ê¸‰"};
          const t=cell.getValue(); return `<span class="badge bg-secondary">${map[t] ?? t ?? 'ê¸°íƒ€'}</span>`;
        }
      },
      { title:"ê±°ë˜ì²˜ëª…", field:"partnerName", minWidth:180 },
      { title:"ì´ì•¡", field:"amountTotal", hozAlign:"right", minWidth:110,
        formatter:(cell)=> Number(cell.getValue()??0).toLocaleString()
      },
      { title:"ì ìš”", field:"remark", minWidth:220 },
    ],

    ajaxURL: "/api/statements",
    ajaxConfig: "GET",
    ajaxContentType: "json",

    ajaxURLGenerator: (url, config, params) => {
      const page0 = (params.page ?? 1) - 1;
      const q = new URLSearchParams(paramsFor(page0, params.size)).toString();
      return url + "?" + q;
    },

    ajaxResponse: (url, params, resp) => {
      return {
        data: resp?.content ?? [],
        last_page: Math.max(1, resp?.totalPages ?? 1),
      };
    },

    rowSelected: updateSelCount,
    rowDeselected: updateSelCount,
  });

  function updateSelCount(){
    document.getElementById('sel-count').textContent = mainTable.getSelectedRows().length;
  }

  mainTable.on("tableBuilt", () => requestAnimationFrame(()=>mainTable.redraw(true)));
  window.addEventListener('resize', () => mainTable.redraw(true));

  /* ---------------- ìœ í˜• í† ê¸€ ---------------- */
  document.querySelectorAll('.btn-type .btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.btn-type .btn').forEach(b=>{
        b.classList.remove('btn-primary'); b.classList.add('btn-outline-primary');
      });
      btn.classList.remove('btn-outline-primary'); btn.classList.add('btn-primary');

      currentType = btn.getAttribute('data-type') || 'ALL';
      mainTable.setPage(1);
      mainTable.replaceData();
    });
  });

  /* ---------------- ê²€ìƒ‰/ì´ˆê¸°í™” ---------------- */
  document.getElementById('btn-search').addEventListener('click', ()=>{
    mainTable.setPage(1);
    mainTable.replaceData();
  });

  document.getElementById('btn-reset').addEventListener?.('click', ()=>{
    document.getElementById('partnerName').value='';
    document.getElementById('voucherNo').value='';
    document.getElementById('fromDate').value='';
    document.getElementById('toDate').value='';
    currentType='ALL';
    document.querySelectorAll('.btn-type .btn').forEach(b=>{
      b.classList.remove('btn-primary'); b.classList.add('btn-outline-primary');
      if(b.getAttribute('data-type')==='ALL'){
        b.classList.remove('btn-outline-primary'); b.classList.add('btn-primary');
      }
    });
    mainTable.setPage(1);
    mainTable.replaceData();
  });

  /* ---------------- ì¸ì‡„ ---------------- */
  const TYPE_LABEL = { SALES:"ì™¸ìƒë§¤ì¶œê¸ˆ", BUY:"ì œí’ˆë§¤ì¶œ", MONEY:"ë¶€ê°€ì„¸ì˜ˆìˆ˜ê¸ˆ", PAYMENT:"ì§€ê¸‰" };
  const isDebit = (type) => type === "BUY" || type === "PAYMENT";

  function buildVoucherHTML(row){
    const now=new Date();
    const today=now.toISOString().slice(0,10);
    const time=now.toTimeString().slice(0,8);
    const typeKo=TYPE_LABEL[row.type] ?? (row.type ?? "");
    const debit = isDebit(row.type) ? Number(row.amountTotal||0) : 0;
    const credit= isDebit(row.type) ? 0 : Number(row.amountTotal||0);

    return `
    <section class="voucher">
      <div class="v-head">
        <div class="title">ì „ í‘œ</div>
        <table class="approve">
          <tr><th class="stamp" rowspan="2">ê²°ì¬</th><th>ë‹´ë‹¹</th><th>ëŒ€ë¦¬</th><th>ê³¼ì¥</th></tr>
          <tr><td height="60"></td><td></td><td></td></tr>
        </table>
      </div>

      <table class="meta">
        <tr>
          <td>íšŒì‚¬ëª… : (ì£¼)êµ¬ë…í•‘ ì´ì•Œí•‘</td>
          <td class="right">ì‘ì„±ì : SYSTEM</td>
          <td class="right">ì „í‘œë²ˆí˜¸ : ${row.voucherNo ?? ""}</td>
        </tr>
        <tr>
          <td>ê±°ë˜ì²˜ : ${row.partnerName ?? ""}</td>
          <td class="right" colspan="2">ì „í‘œì¼ì : ${row.voucherDate ? row.voucherDate.toString().slice(0,10) : ""}</td>
        </tr>
      </table>

      <table class="lines">
        <thead>
          <tr><th style="width:28%">ê³„ì •ëª…</th><th style="width:34%">ì ìš”</th><th style="width:19%">ì°¨ë³€</th><th style="width:19%">ëŒ€ë³€</th></tr>
        </thead>
        <tbody>
          <tr>
            <td>${typeKo}</td>
            <td>${row.remark ?? ""}</td>
            <td class="num">${debit.toLocaleString()}</td>
            <td class="num">${credit.toLocaleString()}</td>
          </tr>
          <tr><td colspan="4" style="height:180px"></td></tr>
        </tbody>
        <tfoot>
          <tr>
            <th class="left" colspan="2">í•©ê³„ &nbsp;&nbsp; ë§¤ì¶œ/ë§¤ì… : ${row.partnerName ?? ""}</th>
            <th class="num">${debit.toLocaleString()}</th>
            <th class="num">${credit.toLocaleString()}</th>
          </tr>
        </tfoot>
      </table>

      <div class="foot">
        <span>[ 1 / 1 ]</span>
        <span class="right">${today} ${time}</span>
      </div>
    </section>
    <div class="page-break"></div>`;
  }

  document.getElementById('btn-print').addEventListener('click', ()=>{
    const rows = mainTable.getSelectedRows();
    if(rows.length===0){ toast('ì¸ì‡„í•  í–‰ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }

    const html = rows.map(r=>buildVoucherHTML(r.getData())).join("");
    const win = window.open('', '_blank', 'width=1200,height=900');
    win.document.write(`<!DOCTYPE html>
      <html><head><title>ì „í‘œ ì¸ì‡„</title>
        <style>
          *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",Arial,sans-serif;}
          body{margin:16px;}
          .voucher{border:1px solid #bbb; padding:14px; border-radius:6px;}
          .v-head{display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;}
          .title{font-size:28px; font-weight:700; letter-spacing:6px; padding:10px 6px;}
          .approve{border-collapse:collapse; width:280px;}
          .approve th,.approve td{border:1px solid #333; text-align:center; padding:6px 8px;}
          .approve .stamp{width:46px}
          .meta{width:100%; border-collapse:collapse; margin:6px 0 10px;}
          .meta td{border:0; padding:4px 2px;}
          .meta .right{text-align:right;}
          .lines{width:100%; border-collapse:collapse; table-layout:fixed;}
          .lines th,.lines td{border:1px solid #777; padding:8px 10px; text-align:center;}
          .lines th{background:#f2f2f5;}
          .lines td.left,.lines th.left{text-align:left;}
          .lines td.num,.lines th.num{text-align:right;}
          tfoot th{background:#fafafa;}
          .foot{display:flex; justify-content:space-between; font-size:12px; margin-top:8px; color:#444;}
          .right{text-align:right;}
          .page-break{page-break-after:always; height:24px;}
          @media print{ body{margin:0; padding:12mm;} .voucher{break-inside:avoid; page-break-inside:avoid;} .page-break{height:0;} }
        </style>
      </head><body>${html}</body></html>`);
    win.document.close(); win.focus(); win.print();
  });

  /* ---------------- Excel (ì„ íƒí–‰) ---------------- */
  document.getElementById('btn-export').addEventListener('click', ()=>{
    const rows = mainTable.getSelectedRows();
    if(rows.length===0){ toast('ë‚´ë³´ë‚¼ í–‰ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }

    const mapType={SALES:"ë§¤ì¶œ", BUY:"ë§¤ì…", MONEY:"ìˆ˜ê¸ˆ", PAYMENT:"ì§€ê¸‰"};
    const data = rows.map(r=>{
      const d=r.getData();
      return {
        ì „í‘œì¼ì: d.voucherDate ? new Date(d.voucherDate).toISOString().slice(0,10) : '',
        ì „í‘œë²ˆí˜¸: d.voucherNo ?? '',
        ìœ í˜•:     mapType[d.type] ?? (d.type??''),
        ê±°ë˜ì²˜ëª…: d.partnerName ?? '',
        ì´ì•¡:     Number(d.amountTotal||0),
        ì ìš”:     d.remark ?? '',
      };
    });

    const wb=XLSX.utils.book_new();
    const ws=XLSX.utils.json_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, "ì„ íƒì „í‘œ");
    const today=new Date().toISOString().slice(0,10).replaceAll('-','');
    XLSX.writeFile(wb, `statements_selected_${today}.xlsx`);
  });


  // ğŸ” ê±°ë˜ì²˜ ì°¾ê¸°
  document.getElementById('btn-find-partner').addEventListener('click', ()=>{
    openModal('partner', (row)=>{
      document.getElementById('partnerName').value = row.partnerName ?? '';
      mainTable.setPage(1); mainTable.replaceData();
    });

    // ëª¨ë‹¬ í…Œì´ë¸” ì¸ìŠ¤í„´ìŠ¤ íšë“ (window.table ì‚¬ìš© X)
    setTimeout(()=>{
      const modalTable = Tabulator.findTable("#commonModalTable")[0];
      if (!modalTable) return;
      try {
        modalTable.updateColumnDefinition("partnerCode", { headerFilter:"input" });
        modalTable.updateColumnDefinition("partnerName", { headerFilter:"input" });
        modalTable.updateColumnDefinition("picName",     { headerFilter:"input" });

        modalTable.off("rowDblClick");
        modalTable.on("rowDblClick", (e,row)=>{
          const data = row.getData();
          document.getElementById('partnerName').value = data.partnerName ?? '';
          bootstrap.Modal.getInstance(document.getElementById("commonModal"))?.hide();
          mainTable.setPage(1); mainTable.replaceData();
        });
      } catch(e) { /* noop */ }
    }, 60);
  });

  // ğŸ” ì „í‘œ ì°¾ê¸°
  document.getElementById('btn-find-voucher').addEventListener('click', ()=>{
    openModal('voucher', (row)=>{
      document.getElementById('voucherNo').value = row.voucherNo ?? '';
      mainTable.setPage(1); mainTable.replaceData();
    });

    setTimeout(()=>{
      const modalTable = Tabulator.findTable("#commonModalTable")[0];
      if (!modalTable) return;
      try {
        modalTable.updateColumnDefinition("voucherNo",   { headerFilter:"input" });
        modalTable.updateColumnDefinition("partnerName", { headerFilter:"input" });
        modalTable.updateColumnDefinition("remark",      { headerFilter:"input" });

        modalTable.off("rowDblClick");
        modalTable.on("rowDblClick", (e,row)=>{
          const data = row.getData();
          document.getElementById('voucherNo').value = data.voucherNo ?? '';
          bootstrap.Modal.getInstance(document.getElementById("commonModal"))?.hide();
          mainTable.setPage(1); mainTable.replaceData();
        });
      } catch(e) { /* noop */ }
    }, 60);
  });
</script>

</body>
</html>
