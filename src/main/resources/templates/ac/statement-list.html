<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <meta charset="UTF-8" />

  <style>
    .btn-type .btn { min-width: 70px; }
    .toast-min{position:fixed;right:24px;bottom:24px;background:#333;color:#fff;padding:10px 14px;border-radius:8px;opacity:.95;z-index:2000}

    /* 전표 등록 모달 폼 */
    .vf-box{background:#f4f5f7;border-radius:8px;padding:14px;border:1px solid #ddd}
    .vf-label{font-weight:600}
    .vf-hr{border-top:1px dashed #d7d7d7;margin:6px 0 10px}
    .vf-num{text-align:right}

    /* 겹 모달 스택 */
    .modal.stack-top { z-index: 1065; }
    .modal-backdrop.stack-top { z-index: 1060; }

    /* 전표번호 로딩 */
    .vf-loading{ opacity:.6 }

    /* 테이블 로딩 오버레이 */
    .table-wrap { position: relative; }
    .loading-overlay {
      position:absolute; inset:0; display:none;
      align-items:center; justify-content:center;
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(1px);
      z-index: 50;
    }
    .loading-overlay.show { display:flex; }
    .loading-box {
      display:flex; align-items:center; gap:10px;
      padding:10px 14px; border-radius:10px;
      background:#fff; border:1px solid #e4e6eb; box-shadow:0 4px 18px rgba(0,0,0,.08);
      font-weight:600; color:#333;
    }

    /* 인풋 안쪽 아이콘 버튼 */
    .input-with-icon { position: relative; display: inline-block; width: 100%; }
    .input-with-icon .form-control { padding-right: 40px; width: 100%; }
    .input-with-icon .icon-btn{
      position:absolute; right:6px; top:50%; transform:translateY(-50%);
      border:0; background:transparent; padding:0; margin:0;
      width:28px; height:28px; display:inline-flex; align-items:center; justify-content:center;
      cursor:pointer; border-radius:6px;
      z-index:2;
    }
    .input-with-icon .icon-btn:focus{ outline:2px solid #86b7fe; outline-offset:2px; }
    .input-with-icon .icon-btn .fa-solid{ font-size:16px; color:#6c757d; }
    .input-with-icon .icon-btn:hover .fa-solid{ color:#333; }

    /* 상단 검색 필드 폭 (모달은 100%) */
    .top-field { width: 280px; max-width: 36vw; }

    /* 모달 백드롭 톤 */
    .modal-backdrop { background-color: #000 !important; }
    .modal-backdrop.show { opacity: .35 !important; }
    .modal-backdrop.stack-top { background-color: #000 !important; opacity: .35 !important; }

    /* 상단 검색바: 라벨을 인풋 위로 */
    .top-field-wrap{ display: flex; flex-direction: column; }
    .top-field-wrap .form-label{ margin-bottom: 7px; }

    /* ===== Tabulator 헤더(칼럼 제목)만 가운데 정렬 ===== */
    .tabulator .tabulator-header .tabulator-col .tabulator-col-content .tabulator-col-title{
      width:100%;
      text-align:center;
      display:block;
    }
    .tabulator .tabulator-header .tabulator-col{
      text-align:center;
    }

    /* 간단한 invalid 표시 (테두리만) */
    .is-invalid{border-color:#dc3545 !important}

    /* ★ invalid 느낌표 아이콘 제거 & 패딩 보정 (돋보기 겹침 방지) */
    .form-control.is-invalid,
    .was-validated .form-control:invalid,
    .form-select.is-invalid,
    .was-validated .form-select:invalid{
      background-image: none !important;   /* 느낌표 아이콘 제거 */
      padding-right: .75rem !important;     /* 기본 패딩 복원 */
    }
    /* input-with-icon에서는 돋보기 공간 유지 */
    .input-with-icon .form-control.is-invalid,
    .input-with-icon .was-validated .form-control:invalid{
      padding-right: 40px !important;
    }
  </style>
</head>

<body layout:fragment="content">
  <div id="layoutSidenav_content">
    <main>
      <div class="container_fluid px-4">

        <div class="d-flex align-items-center justify-content-between mt-4 mb-2">
          <h1 class="mb-0">전표 관리</h1>
        </div>

        <!-- 상단 액션 -->
        <div class="d-flex align-items-center flex-wrap gap-2 mb-3">
          <button type="button" class="btn btn-outline-primary open-voucher-form" data-type="SALES">매출전표 등록</button>
          <button type="button" class="btn btn-outline-primary open-voucher-form" data-type="BUY">매입전표 등록</button>
          <a class="btn btn-outline-primary" th:href="@{/register}">일반전표 등록</a>

          <div class="btn-group btn-type ms-2" role="group" aria-label="type-filter">
            <button type="button" class="btn btn-primary" data-type="ALL">
              전체 <span class="badge rounded-pill bg-secondary ms-1" id="count-ALL">0</span>
            </button>
            <button type="button" class="btn btn-outline-primary" data-type="SALES">
              매출 <span class="badge rounded-pill bg-secondary ms-1" id="count-SALES">0</span>
            </button>
            <button type="button" class="btn btn-outline-primary" data-type="BUY">
              매입 <span class="badge rounded-pill bg-secondary ms-1" id="count-BUY">0</span>
            </button>
            <button type="button" class="btn btn-outline-primary" data-type="MONEY">
              수금 <span class="badge rounded-pill bg-secondary ms-1" id="count-MONEY">0</span>
            </button>
            <button type="button" class="btn btn-outline-primary" data-type="PAYMENT">
              지급 <span class="badge rounded-pill bg-secondary ms-1" id="count-PAYMENT">0</span>
            </button>
          </div>

          <div class="ms-auto d-flex align-items-center gap-2">
            <button id="btn-print" class="btn btn-secondary">인쇄</button>
            <button id="btn-export" class="btn btn-dark">Excel</button>
          </div>
        </div>

        <!-- 검색 바 -->
        <div class="d-flex align-items-end flex-wrap gap-3 mb-2">
          <div class="top-field-wrap">
            <label class="form-label" for="partnerName">거래처명</label>
            <div class="input-with-icon top-field">
              <input id="partnerName" type="text" class="form-control" placeholder="조회 후 등록" readonly>
              <button id="icon-find-partner" type="button" class="icon-btn" aria-label="거래처 검색">
                <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
              </button>
            </div>
          </div>

          <div class="top-field-wrap">
            <label class="form-label" for="voucherNo">전표번호</label>
            <div class="input-with-icon top-field">
              <input id="voucherNo" type="text" class="form-control">
              <button id="btn-find-voucher" type="button" class="icon-btn" aria-label="전표 검색" style="display:none">
                <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
              </button>
            </div>
          </div>

          <div>
            <label class="form-label" for="fromDate">전표일자</label>
            <input id="fromDate" type="date" class="form-control w-auto">
          </div>
          <div>
            <label class="form-label" for="toDate"> </label>
            <input id="toDate" type="date" class="form-control w-auto">
          </div>

          <div class="d-flex gap-2">
            <button id="btn-search" class="btn btn-warning">검색</button>
            <button id="btn-reset" class="btn btn-outline-secondary">초기화</button>
            <button id="btn-refresh" class="btn btn-outline-secondary">새로고침</button>
          </div>
        </div>

        <!-- 메인 테이블 + 로딩 오버레이 -->
        <div class="table-wrap">
          <div id="employee-table"></div>
          <div id="tbl-loading" class="loading-overlay" aria-hidden="true">
            <div class="loading-box">
              <div class="spinner-border" role="status" aria-label="loading"></div>
              <span>데이터 로딩 중…</span>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- 공통 모달(fragment) + 공통 스크립트 -->
  <div th:replace="~{common/modal :: commonModal}"></div>
  <script th:src="@{/main/js/modal.js}" defer></script>

  <!-- ▼▼▼ 전표 등록 모달 ▼▼▼ -->
  <div class="modal fade" id="voucherFormModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header py-2">
          <h5 class="modal-title"><span id="vf-title">전표 등록</span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="vf-box">
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label vf-label" id="lbl-voucherDate" for="vf-voucherDate">전표일자</label>
                <div class="input-group"><input id="vf-voucherDate" type="date" class="form-control"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label vf-label" for="vf-voucherNo">전표번호</label>
                <input id="vf-voucherNo" type="text" class="form-control" placeholder="자동발번" readonly>
                <input id="vf-resvId" type="hidden">
              </div>

              <div class="col-6">
                <label class="form-label vf-label" id="lbl-saleCode" for="vf-saleCode">판매코드 *</label>
                <div class="input-with-icon">
                  <input id="vf-saleCode" type="text" class="form-control" placeholder="">
                  <button id="vf-icon-find-saleCode" type="button" class="icon-btn" aria-label="판매/구매코드 찾기">
                    <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
                  </button>
                </div>
              </div>

              <div class="col-6">
                <label class="form-label vf-label" for="vf-partnerName">거래처 *</label>
                <div class="input-with-icon">
                  <input id="vf-partnerName" type="text" class="form-control" placeholder="">
                  <button id="vf-icon-find-partner" type="button" class="icon-btn" aria-label="거래처 찾기">
                    <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
                  </button>
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label vf-label" id="lbl-saleDate" for="vf-saleDate">판매일자</label>
                <div class="input-group"><input id="vf-saleDate" type="date" class="form-control"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label vf-label" for="vf-empName">담당자</label>
                <div class="input-with-icon">
                  <input id="vf-empName" type="text" class="form-control" placeholder="" readonly>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label vf-label" for="vf-writeDate">작성일자</label>
                <div class="input-group"><input id="vf-writeDate" type="date" class="form-control"></div>
              </div>
            </div>

            <div class="vf-hr"></div>

            <div class="row g-2">
              <div class="col-12">
                <label class="form-label vf-label" for="vf-taxType">부가세유형</label>
                <select id="vf-taxType" class="form-select">
                  <option value="TAXABLE">과세(10%)</option>
                  <option value="ZERO">영세(0%)</option>
                  <option value="EXEMPT">면세(0%)</option>
                </select>
              </div>

              <div class="col-12">
                <label class="form-label vf-label" for="vf-supply">공급가액 *</label>
                <input id="vf-supply" type="text" class="form-control vf-num" value="0">
              </div>
              <div class="col-12">
                <label class="form-label vf-label" for="vf-vat">부가세</label>
                <input id="vf-vat" type="text" class="form-control vf-num" value="0" readonly>
              </div>
              <div class="col-12">
                <label class="form-label vf-label" for="vf-total">총 금액 *</label>
                <input id="vf-total" type="text" class="form-control vf-num" value="0">
              </div>
              <div class="col-12">
                <label class="form-label vf-label" for="vf-remark">적요</label>
                <input id="vf-remark" type="text" class="form-control" placeholder="">
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer py-2">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
          <button id="vf-save" type="button" class="btn btn-primary">저장</button>
        </div>
      </div>
    </div>
  </div>
  <!-- ▲▲▲ 전표 등록 모달 끝 ▲▲▲ -->

  <!-- SheetJS -->
  <script src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js" defer></script>

  <!-- 페이지 스크립트 -->
  <script>
  window.addEventListener('DOMContentLoaded', () => {
    /* ---------- 유틸 ---------- */
    function toast(msg, ms=1600){ const t=document.createElement('div'); t.className='toast-min'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(), ms); }
    const fmt   = n => Number(n||0).toLocaleString();
    const unfmt = s => Number(String(s||'').replace(/[^\d.-]/g,''))||0;

    function ymdLocal(d){
      const tz = d.getTimezoneOffset() * 60000;
      return new Date(d.getTime() - tz).toISOString().slice(0,10);
    }

    /* 부가세 계산 */
    const FRACTION = { TAXABLE:{num:10,den:100}, ZERO:{num:0,den:100}, EXEMPT:{num:0,den:100} };
    const normType = (t)=>{ const x=String(t||'').toUpperCase(); return (x in FRACTION)?x:'TAXABLE'; };
    function computeFromSupply(supply,taxType){ const {num,den}=FRACTION[normType(taxType)]; if(num===0) return {supply,vat:0,total:supply}; const vat=Math.round(supply*num/den); return {supply,vat,total:supply+vat}; }
    function computeFromTotal(total,taxType){ const {num,den}=FRACTION[normType(taxType)]; if(num===0) return {supply:total,vat:0,total}; const vat=Math.round(total*num/den); return {supply:total-vat,vat,total}; }

    const lastCalc = { mode:'SUPPLY', supply:0, vat:0, total:0, taxType:'TAXABLE' };

    const $overlay=document.getElementById('tbl-loading');
    const showLoading=()=>$overlay?.classList.add('show');
    const hideLoading=()=>$overlay?.classList.remove('show');

    /* ===== 겹치는 모달 스택 & 백드롭 유지 ===== */
    document.addEventListener('show.bs.modal', (ev)=>{
      const el = ev.target;
      const opened = document.querySelectorAll('.modal.show').length;
      const z = 1065 + opened*20;
      el.classList.add('stack-top');
      el.style.zIndex = z;
      setTimeout(()=>{
        const bds=[...document.querySelectorAll('.modal-backdrop')];
        const last=bds[bds.length-1];
        if(last){ last.classList.add('stack-top'); last.style.zIndex = z-5; }
      });
    });

    document.addEventListener('hidden.bs.modal', ()=>{
      const openModals = document.querySelectorAll('.modal.show');
      if (openModals.length > 0) {
        document.body.classList.add('modal-open');
        const bds=[...document.querySelectorAll('.modal-backdrop')];
        while (bds.length > 1) { bds.shift().remove(); }
      } else {
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('padding-right');
        document.querySelectorAll('.modal-backdrop').forEach(b=>b.remove());
      }
    });

    /* ---------- 세션 사용자 "이름"만 추출 ---------- */
    function extractDisplayName(me){
      try{
        if (typeof me === 'string') me = { raw: me };

        const directCandidates = [
          me?.employeeName, me?.realName, me?.displayName, me?.name,
          me?.user?.name, me?.profile?.name, me?.principal?.name,
          me?.account?.name, me?.raw, me?.username, me?.userId, me?.employeeCode
        ].filter(Boolean).map(String);

        const tokens = [];
        const pushTokens = (s)=>{
          String(s).split(/[|:,/>\-]+/).forEach(t=>{
            const trimmed = t.replace(/\(.*?\)|\[.*?]|<.*?>/g,'').trim();
            if (trimmed) tokens.push(trimmed);
          });
        };
        directCandidates.forEach(pushTokens);

        const BAD_KEYWORDS = ['관리자','admin','ADMIN','ROLE','권한','팀','부','과장','차장','대리','사원','user','영업','개발','기획','재무','인사'];
        const CODE_REGEXES = [
          /^[A-Z]{1}\d{3,}$/u,
          /^EMP\d{2,}$/u,
          /^[A-Z0-9_-]{3,20}$/u
        ];
        const isBad = (t)=> BAD_KEYWORDS.some(k=>t.includes(k)) || CODE_REGEXES.some(r=>r.test(t));

        const isKoreanName = (t)=> /^[가-힣]{2,4}$/.test(t);
        const isEnglishName = (t)=> /^[A-Za-z][A-Za-z .'-]{1,39}$/.test(t) && !/\d/.test(t);

        const kor = tokens.find(t=>isKoreanName(t) && !isBad(t));
        if (kor) return kor;

        const eng = tokens.find(t=>isEnglishName(t) && !isBad(t));
        if (eng) return eng;

        const lax = tokens.find(t=>!isBad(t) && t.length>=2 && t.length<=10);
        return lax || '';
      }catch(_){ return ''; }
    }

    function looksLikeCode(s){
      const v=String(s||'').trim();
      return /^[A-Z]{1}\d{3,}$/.test(v) || /^EMP\d{2,}$/.test(v);
    }

    let currentUserName='';
    fetch('/api/me',{credentials:'same-origin'})
      .then(async r=>{
        const ct=(r.headers.get('content-type')||'').toLowerCase();
        if (ct.includes('application/json')) return r.json();
        return r.text().then(txt=>({ raw: txt }));
      })
      .then(j=>{
        const name = extractDisplayName(j) || '';
        currentUserName = name;

        const $empInput = document.getElementById('vf-empName');
        if ($empInput) {
          if (!$empInput.value || looksLikeCode($empInput.value)) {
            if (name) $empInput.value = name;
          }
        }
      })
      .catch(()=>{ /* no-op */ });

    /* ---------- 목록 테이블 ---------- */
    let currentType='ALL';

    function paramsFor(){
      return {
        type: currentType,
        keyword:  document.getElementById('partnerName').value || '',
        voucherNo:document.getElementById('voucherNo').value || '',
        fromDate: document.getElementById('fromDate').value || '',
        toDate:   document.getElementById('toDate').value || '',
      };
    }

    async function fetchPageJson(url){
      const res=await fetch(url,{method:'GET',headers:{'Accept':'application/json'}});
      const ctyp=(res.headers.get('content-type')||'').toLowerCase();
      const text=await res.text();
      if(!res.ok || !ctyp.includes('application/json')){ console.error('[STATEMENTS] bad response',res.status,text); throw new Error(`Bad response ${res.status}`); }
      return text?JSON.parse(text):{};
    }

    function parseVoucherNo(v){
      const m = /^(\d{2})(\d{2})-(\d{4})$/.exec(String(v||'').trim());
      if(!m) return null;
      return { y: parseInt(m[1],10), m: parseInt(m[2],10), s: parseInt(m[3],10) };
    }
    function compareVoucherAsc(a,b){
      const A=parseVoucherNo(a), B=parseVoucherNo(b);
      if(!A && !B) return 0;
      if(!A) return 1;
      if(!B) return -1;
      if(A.y!==B.y) return A.y - B.y;
      if(A.m!==B.m) return A.m - B.m;
      if(A.s!==B.s) return A.s - B.s;
      return 0;
    }

    function deriveTotalCount(js){
      if (Array.isArray(js)) return js.length;
      if (js && typeof js === 'object'){
        if (typeof js.totalElements === 'number') return js.totalElements;
        if (Array.isArray(js.content)) return js.content.length;
      }
      return 0;
    }

    function setTypeBadges(totals){
      ['ALL','SALES','BUY','MONEY','PAYMENT'].forEach(k=>{
        const el = document.getElementById(`count-${k}`);
        if (el) el.textContent = (totals[k] ?? 0).toLocaleString();
      });
    }

    let allSelected=false;
    let lastSorters = [{ field:'voucherNo', dir:'desc' }];

    let lastAllRows = [];  // 전체(ALL) 기준으로 마지막 조회 데이터 유지

    function groupCounts(rows){
      const totals = { ALL: 0, SALES: 0, BUY: 0, MONEY: 0, PAYMENT: 0 };
      if (!Array.isArray(rows)) return totals;
      totals.ALL = rows.length;
      for (const r of rows) {
        const t = String(r?.type || '').toUpperCase();
        if (t in totals) totals[t] += 1;
      }
      return totals;
    }

    function refreshTypeCounts(){
      // 마지막 ALL 데이터로 칩 갱신
      const totals = groupCounts(lastAllRows);
      setTypeBadges(totals);
    }
    
    const mainTable=new Tabulator("#employee-table",{
      layout:"fitColumns",
      pagination:true, paginationMode:"local",
      paginationSize:19,
      initialSort:[{ column:"voucherNo", dir:"desc" }],
      selectable:true, selectableRangeMode:"drag",
      columns:[
        { titleFormatter:"rowSelection", formatter:"rowSelection",
          titleFormatterParams:{rowRange:"active"},
          headerSort:false,width:55,hozAlign:"center",headerHozAlign:"center",
          headerClick:()=>{ if(!allSelected){ mainTable.selectRow("visible"); } else { mainTable.deselectRow(); } allSelected=!allSelected; }
        },
        { title:"전표번호", field:"voucherNo", hozAlign:"center", width:130, headerHozAlign:"center",
          sorter:(a,b)=>compareVoucherAsc(a,b)
        },
        { title:"유형", field:"type", hozAlign:"center", width:100, headerHozAlign:"center",
          formatter:(c)=>{ const t=c.getValue(); const map={SALES:{label:"매출",cls:"bg-primary"}, BUY:{label:"매입",cls:"bg-success"}, MONEY:{label:"수금",cls:"bg-info"}, PAYMENT:{label:"지급",cls:"bg-warning"}}; const m=map[t]||{label:t||"기타",cls:"bg-secondary"}; return `<span class="badge ${m.cls}">${m.label}</span>`; }
        },
        {title:"거래처명",field:"partnerName",minWidth:180, headerHozAlign:"center"},
        {title:"총액",field:"amountTotal",hozAlign:"right",minWidth:110, headerHozAlign:"center",formatter:(c)=>fmt(c.getValue())},
        {title:"적요",field:"remark",minWidth:220, headerHozAlign:"center"},
        {title:"전표일자",field:"voucherDate",hozAlign:"center",width:120, headerHozAlign:"center",
          formatter:(c)=>{const v=c.getValue();if(!v) return "";const d=new Date(v);return isNaN(d)?String(v).slice(0,10):d.toISOString().slice(0,10);}
        },
        {title:"제품명", field:"productName", visible:false, headerHozAlign:"center"},
      ],
    });

    mainTable.on("dataSorted", (sorters) => {
      if (Array.isArray(sorters) && sorters.length){
        lastSorters = sorters.map(s => {
          const field = s.field || (s.column && s.column.getField && s.column.getField()) || 'voucherNo';
          return { field, dir: s.dir || 'asc' };
        });
      }
    });

    mainTable.on("tableBuilt",()=>requestAnimationFrame(()=>mainTable.redraw(true)));
    window.addEventListener('resize',()=>mainTable.redraw(true));
	
    const FETCH_PAGE_SIZE = 500;
    
    
    async function loadAllData(){
    	  showLoading();
    	  try{
    	    const base=paramsFor();

    	    // ★ 집계/배지용으로는 항상 ALL 기준으로 불러오도록 type 제거
    	    const { type: _ignored, ...baseNoType } = base;

    	    const qs1=new URLSearchParams({...baseNoType, page:0, size:FETCH_PAGE_SIZE});
    	    qs1.append('sort','voucherNo,desc');
    	    const first=await fetchPageJson(`/api/statements?${qs1.toString()}`);

    	    const firstRows = Array.isArray(first) ? first : (first.content ?? []);
    	    const totalPages = Array.isArray(first) ? 1 : Math.max(1, first.totalPages ?? 1);
    	    const sizeUsed   = Array.isArray(first) ? firstRows.length : (first.size ?? FETCH_PAGE_SIZE);

    	    let all=[...firstRows];

    	    for(let p=1; p<totalPages; p++){
    	      const qsp=new URLSearchParams({...baseNoType, page:p, size:sizeUsed});
    	      qsp.append('sort','voucherNo,desc');
    	      const js=await fetchPageJson(`/api/statements?${qsp.toString()}`);
    	      const rows = Array.isArray(js) ? js : (js.content ?? []);
    	      all = all.concat(rows);
    	    }

    	    // 정렬 유지
    	    if (lastSorters && lastSorters.length){
    	      const s = lastSorters[0];
    	      if (s.field === 'voucherNo'){
    	        all.sort((a,b)=> {
    	          const cmp = compareVoucherAsc(a.voucherNo, b.voucherNo);
    	          return s.dir === 'asc' ? cmp : -cmp;
    	        });
    	      } else {
    	        all.sort((a,b)=>{
    	          const av=a[s.field], bv=b[s.field];
    	          if (typeof av === 'number' && typeof bv === 'number') return s.dir==='asc' ? av-bv : bv-av;
    	          return s.dir==='asc' ? String(av??'').localeCompare(String(bv??'')) : String(bv??'').localeCompare(String(av??'')); 
    	        });
    	      }
    	    } else {
    	      all.sort((a,b)=> -compareVoucherAsc(a.voucherNo, b.voucherNo));
    	    }

    	    // ★ 전체 데이터 저장(배지 계산용)
    	    lastAllRows = all;

    	    // ★ 현재 탭 필터링 후 테이블 반영
    	    const visible = (currentType==='ALL') ? all : all.filter(r => String(r.type||'').toUpperCase() === currentType);
    	    await mainTable.setData(visible);

    	    if (lastSorters && lastSorters.length){
    	      mainTable.setSort(lastSorters.map(s => ({ column:s.field, dir:s.dir })));
    	    } else {
    	      mainTable.setSort([{column:'voucherNo', dir:'desc'}]);
    	    }
    	    mainTable.setPage(1);

    	    // ★ 칩 배지 갱신
    	    refreshTypeCounts();

    	  } catch(e){
    	    console.error(e);
    	    toast('데이터 로드 실패: ' + (e.message||''));
    	  } finally {
    	    hideLoading();
    	  }
    	}

    

    loadAllData();

    /* 필터/버튼 핸들러 */
    document.querySelectorAll('.btn-type .btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.btn-type .btn').forEach(b=>{b.classList.remove('btn-primary');b.classList.add('btn-outline-primary');});
        btn.classList.remove('btn-outline-primary'); btn.classList.add('btn-primary');
        currentType = btn.getAttribute('data-type')||'ALL';
        loadAllData();
      });
    });

    document.getElementById('btn-search').addEventListener('click',()=>{ loadAllData(); });
    document.getElementById('btn-reset').addEventListener('click',()=>{
      ['partnerName','voucherNo','fromDate','toDate'].forEach(id=>document.getElementById(id).value='');
      currentType='ALL';
      document.querySelectorAll('.btn-type .btn').forEach(b=>{
        b.classList.remove('btn-primary');b.classList.add('btn-outline-primary');
        if(b.dataset.type==='ALL'){b.classList.remove('btn-outline-primary');b.classList.add('btn-primary');}
      });
      loadAllData();
    });

    /* ---------- 모달/검색 훅: 상단 거래처 ---------- */
    const $partnerNameTop     = document.getElementById('partnerName');
    const $iconFindPartnerTop = document.getElementById('icon-find-partner');

    function openPartnerPickerTop(){
      if (typeof window.openModal === 'function') {
        window.openModal('partner', (row) => {
          if ($partnerNameTop) $partnerNameTop.value = row?.partnerName || row?.supplierName || '';
        });
      } else {
        toast('검색 모달 스크립트가 로드되지 않았습니다 (modal.js 확인).');
      }
    }
    $iconFindPartnerTop?.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); openPartnerPickerTop(); });
    $iconFindPartnerTop?.addEventListener('keydown', (e)=>{ if (e.key==='Enter' || e.key===' ') { e.preventDefault(); openPartnerPickerTop(); } });
    $partnerNameTop?.addEventListener('keydown', (e)=>{ if (e.key==='Enter') openPartnerPickerTop(); });

    /* ---------- 새로고침 ---------- */
    const $refresh=document.getElementById('btn-refresh');
    $refresh?.addEventListener('click', async ()=>{
      if($refresh.disabled) return;
      const orig=$refresh.innerHTML;
      $refresh.disabled=true;
      $refresh.innerHTML=`새로고침 <span class="spinner-border spinner-border-sm ms-1" role="status" aria-label="loading"></span>`;
      showLoading();
      try{ await loadAllData(); } finally {
        hideLoading(); $refresh.disabled=false; $refresh.innerHTML=orig;
      }
    });

    /* ---------- Excel ---------- */
    function yyyymmdd(){ const d=new Date(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${d.getFullYear()}${m}${day}`; }
    document.getElementById('btn-export')?.addEventListener('click', () => {
      const filename = `statements_${yyyymmdd()}.xlsx`;
      try {
        if (typeof mainTable.download === 'function') {
          mainTable.download("xlsx", filename, { sheetName: "Statements" });
          return;
        }
      } catch(e) { console.warn('[EXPORT] Tabulator download fallback', e); }
      try {
        const data = mainTable.getData(true);
        const rows = data.map(r => ({
          전표번호: r.voucherNo || '',
          유형: r.type || '',
          거래처명: r.partnerName || '',
          총액: r.amountTotal || 0,
          적요: r.remark || '',
          전표일자: r.voucherDate ? String(r.voucherDate).slice(0,10) : ''
        }));
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(rows);
        XLSX.utils.book_append_sheet(wb, ws, "Statements");
        XLSX.writeFile(wb, filename);
      } catch(e) { console.error('[EXPORT] failed', e); toast('엑셀 내보내기 실패'); }
    });

    /* ---------- 전표 양식 인쇄 ---------- */
    function buildVoucherHTML(rows){
      const now = new Date();
      const nowStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${now.toLocaleTimeString()}`;
      const css = `
        <style>
          @page { size: A4; margin: 12mm; }
          @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
          body { font-family: 'Malgun Gothic', system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif; color:#222; }
          .page { page-break-after: always; }
          .title { text-align:center; font-size:28px; font-weight:700; letter-spacing:4px; margin-bottom:8px; }
          .head { display:flex; justify-content:space-between; margin:6px 0 10px; font-size:12px; }
          .grid { width:100%; border-collapse:collapse; font-size:12px; }
          .grid th, .grid td { border:1px solid #bdbdbd; padding:6px 8px; }
          .grid thead th { background:#efefef; }
          .sum { font-weight:700; }
          .r { text-align:right; }
          .c { text-align:center; }
          .note { font-size:11px; color:#666; margin-top:8px; }
          .small { font-size:11px; }
          .stamp { border:1px solid #bdbdbd; width:280px; margin-left:auto; margin-bottom:6px; }
          .stamp table { width:100%; border-collapse:collapse; }
          .stamp th, .stamp td { border:1px solid #bdbdbd; text-align:center; padding:4px 0; font-size:12px; }
        </style>
      `;
      const pages = rows.map((r, idx)=>{
        const type = (r.type || '').toUpperCase();
        const company = '㈜구독핑 이알핑';
        const writer = currentUserName || 'guest';
        const vno = r.voucherNo || '';
        const total   = Number(r.amountTotal || r.total || 0);
        let supply    = Number(r.amountSupply || 0);
        let vat       = Number(r.amountVat || 0);

        const taxType = normType(r.taxCode || 'TAXABLE');

        if (!supply && !vat && total){
          const parts = computeFromTotal(total, taxType);
          supply = parts.supply; vat = parts.vat;
        } else if (supply && !vat){
          const parts = computeFromSupply(supply, taxType);
          vat = parts.vat;
        } else if (!supply && vat){
          const parts = computeFromTotal(total || (vat*10), taxType);
          supply = parts.supply; vat = parts.vat;
        }

        const itemName = r.productName || r.remark || r.partnerName || '';

        let lines = [];
        if (type === 'SALES') {
          lines = [
            { acct:'외상매출금',   desc:itemName, debit: total,  credit: 0 },
            { acct:'제품매출',     desc:itemName, debit: 0,      credit: supply },
            { acct:'부가세예수금', desc:itemName, debit: 0,      credit: vat },
          ];
        } else if (type === 'BUY') {
          lines = [
            { acct:'상품',         desc:itemName, debit: supply, credit: 0 },
            { acct:'부가세대급금', desc:itemName, debit: vat,    credit: 0 },
            { acct:'외상매입금',   desc:itemName, debit: 0,      credit: total },
          ];
        } else {
          lines = [{ acct:'기타', desc:itemName, debit: total, credit: 0 }];
        }
        const debitSum  = lines.reduce((s,x)=>s + (x.debit||0), 0);
        const creditSum = lines.reduce((s,x)=>s + (x.credit||0),0);
        const foot = (type==='SALES')
          ? `매출 : 세금계산서 / ${r.partnerName||''} / ${fmt(supply)} , ${fmt(vat)}`
          : `매입 : 세금계산서 / ${r.partnerName||''} / ${fmt(supply)} , ${fmt(vat)}`;

        const bodyRows = lines.map(x=>(
          `<tr>
            <td class="c">${x.acct}</td>
            <td>${x.desc||''}</td>
            <td class="r">${x.debit?fmt(x.debit):''}</td>
            <td class="r">${x.credit?fmt(x.credit):''}</td>
          </tr>`
        )).join('');
        const empty = Array.from({length:Math.max(0,7 - lines.length)}).map(()=>(`<tr><td>&nbsp;</td><td></td><td></td><td></td></tr>`)).join('');

        return `
          <div class="page">
            <div class="title">전 표</div>
            <div class="stamp">
              <table>
                <tr><th rowspan="2" style="width:50px;">결<br>재</th><th>담당</th><th>대리</th><th>과장</th></tr>
                <tr><td style="height:50px;"></td><td></td><td></td></tr>
              </table>
            </div>
            <div class="head">
              <div>회사명 : ${company}</div>
              <div>작성자 : ${writer}</div>
              <div>전표번호 : ${vno}</div>
            </div>
            <table class="grid">
              <thead>
                <tr><th class="c" style="width:120px;">계정명</th><th class="c">적요</th><th class="c" style="width:140px;">차변</th><th class="c" style="width:140px;">대변</th></tr>
              </thead>
              <tbody>
                ${bodyRows}
                ${empty}
                <tr class="sum"><td class="c">합계</td><td class="small">${foot}</td><td class="r">${fmt(debitSum)}</td><td class="r">${fmt(creditSum)}</td></tr>
              </tbody>
            </table>
            <div class="note">[ ${idx+1} / ${rows.length} ]</div>
            <div class="note r">${nowStr}</div>
          </div>
        `;
      }).join('');
      return `<!doctype html><html><head><meta charset="utf-8"><title>전표 인쇄</title>${css}</head><body>${pages}</body></html>`;
    }

    document.getElementById('btn-print')?.addEventListener('click', () => {
      const selected = mainTable.getSelectedData();
      if (!selected || selected.length === 0){
        toast('인쇄할 전표를 체크박스로 선택하세요.');
        return;
      }

      const html = buildVoucherHTML(selected);

      const iframe = document.createElement('iframe');
      iframe.style.position = 'fixed';
      iframe.style.right = '0';
      iframe.style.bottom = '0';
      iframe.style.width = '0';
      iframe.style.height = '0';
      iframe.style.border = '0';
      iframe.style.visibility = 'hidden';
      document.body.appendChild(iframe);

      const cleanup = () => { try { iframe.remove(); } catch(_) {} };
      const doPrint = () => { try { iframe.contentWindow.focus(); iframe.contentWindow.print(); } catch(_) {} };

      iframe.onload = () => setTimeout(doPrint, 50);
      iframe.srcdoc = html;

      setTimeout(() => {
        const doc = iframe.contentDocument || iframe.contentWindow?.document;
        const empty = !doc || !doc.body || !doc.body.childNodes.length;
        if (empty) {
          try {
            const d = iframe.contentWindow.document;
            d.open(); d.write(html); d.close();
            setTimeout(doPrint, 50);
          } catch(_) {}
        }
      }, 120);

      iframe.contentWindow.onafterprint = cleanup;
      iframe.contentWindow.addEventListener?.('beforeunload', cleanup);
    });


    /* ---------- 전표 등록 모달 ---------- */
    const vfEl    = document.getElementById('voucherFormModal');
    const vfModal = (window.bootstrap?.Modal && vfEl) ? new bootstrap.Modal(vfEl) : null;
    const q = (sel) => vfEl ? vfEl.querySelector(sel) : null;

    let _vnoInFlight = false;

    async function fetchNextVoucherNo(type, dateStr){
      const $vno = document.getElementById('vf-voucherNo'); if(!$vno) return;
      if (_vnoInFlight) return;
      _vnoInFlight = true;
      try{
        $vno.classList.add('vf-loading'); $vno.value = '전표번호 확인중...';
        const qs = new URLSearchParams({ type, ...(dateStr?{date:dateStr}:{}) });
        const res  = await fetch(`/api/vouchers/preview?${qs.toString()}`, { method:'GET' });
        const text = await res.text(); if(!res.ok) throw new Error(text||'preview failed');
        const j = text ? JSON.parse(text) : {};
        $vno.value = j?.voucherNo || '';
      }catch(e){
        console.error(e);
        $vno.value = '';
      }finally{
        $vno.classList.remove('vf-loading');
        _vnoInFlight = false;
      }
    }

    function resetField(el){
      if(!el) return null;
      const clone = el.cloneNode(true);
      el.replaceWith(clone);
      return clone;
    }

    function rewireNumericFields(){
      const $taxSel0 = q('#vf-taxType');
      const $sup0    = q('#vf-supply');
      const $vat0    = q('#vf-vat');
      const $tot0    = q('#vf-total');

      const $taxSel = resetField($taxSel0);
      const $supply = resetField($sup0);
      const $vat    = resetField($vat0);
      const $total  = resetField($tot0);
      if (!($taxSel && $supply && $vat && $total)) return;

      const syncView = (p) => {
        lastCalc.supply = p.supply; lastCalc.vat = p.vat; lastCalc.total = p.total; lastCalc.taxType = $taxSel.value;
        $supply.value = fmt(p.supply);
        $vat.value    = fmt(p.vat);
        $total.value  = fmt(p.total);
      };

      $supply.addEventListener('input', (e) => {
        e.stopImmediatePropagation();
        const raw = unfmt($supply.value);
        const p = computeFromSupply(raw, $taxSel.value);
        lastCalc.mode = 'SUPPLY';
        syncView(p);
      }, { capture:true });

      $supply.addEventListener('focus', (e) => {
        e.stopImmediatePropagation();
        const raw = unfmt($supply.value);
        $supply.value = raw ? String(raw) : '';
        setTimeout(() => { try { $supply.setSelectionRange($supply.value.length, $supply.value.length); } catch(_){} }, 0);
      }, { capture:true });

      $supply.addEventListener('blur', (e) => {
        e.stopImmediatePropagation();
        const raw = unfmt($supply.value);
        const p = computeFromSupply(raw, $taxSel.value);
        lastCalc.mode = 'SUPPLY';
        syncView(p);
      }, { capture:true });

      $total.addEventListener('input', (e) => {
        e.stopImmediatePropagation();
        const raw = unfmt($total.value);
        const p = computeFromTotal(raw, $taxSel.value);
        lastCalc.mode = 'TOTAL';
        syncView(p);
      }, { capture:true });

      $total.addEventListener('focus', (e) => {
        e.stopImmediatePropagation();
        const raw = unfmt($total.value);
        $total.value = raw ? String(raw) : '';
        setTimeout(() => { try { $total.setSelectionRange($total.value.length, $total.value.length); } catch(_){} }, 0);
      }, { capture:true });

      $total.addEventListener('blur', (e) => {
        e.stopImmediatePropagation();
        const raw = unfmt($total.value);
        const p = computeFromTotal(raw, $taxSel.value);
        lastCalc.mode = 'TOTAL';
        syncView(p);
      }, { capture:true });

      $taxSel.addEventListener('change', (e) => {
        e.stopImmediatePropagation();
        const p = (lastCalc.mode === 'TOTAL')
          ? computeFromTotal(lastCalc.total, $taxSel.value)
          : computeFromSupply(lastCalc.supply, $taxSel.value);
        syncView(p);
      }, { capture:true });

      ['wheel','mousewheel'].forEach(evt=>{
        [$supply, $total].forEach($el=>{
          $el.addEventListener(evt, (e)=> {
            if (document.activeElement === $el) { e.preventDefault(); e.stopImmediatePropagation(); }
          }, { passive:false, capture:true });
        });
      });
      [$supply, $total].forEach($el=>{
        $el.addEventListener('keydown', (e) => {
          if (['ArrowUp','ArrowDown','PageUp','PageDown'].includes(e.key)) { e.preventDefault(); e.stopImmediatePropagation(); }
        }, { capture:true });
      });

      syncView(computeFromTotal(0, $taxSel.value));
      lastCalc.mode = 'TOTAL';

      return { $taxSel, $supply, $vat, $total, syncView };
    }

    document.querySelectorAll('.open-voucher-form').forEach(btn=>{
      btn.addEventListener('click',()=>{ openVoucherForm(btn.dataset.type === 'BUY' ? 'BUY' : 'SALES'); });
    });

    let vfBindings = null;

    function openVoucherForm(type){
      if(!vfEl || !vfModal){ toast('전표 등록 모달을 로드할 수 없습니다.'); return; }
      const $title=q('#vf-title'), $voucherDt=q('#vf-voucherDate'), $saleDt=q('#vf-saleDate'), $writeDt=q('#vf-writeDate'),
            $voucherNo=q('#vf-voucherNo'), $saleCode=q('#vf-saleCode'), $partner=q('#vf-partnerName'),
            $emp=q('#vf-empName'), $taxSel=q('#vf-taxType'), $remark=q('#vf-remark'),
            $lblSaleCode=q('#lbl-saleCode'), $lblSaleDate=q('#lbl-saleDate'), $lblVoucherDate=q('#lbl-voucherDate');

      if (type==='BUY') {
        $title.textContent='매입전표 등록';
        if($lblSaleCode) $lblSaleCode.textContent='구매코드 *';
        if($lblSaleDate) $lblSaleDate.textContent='구매일자';
        if($lblVoucherDate) $lblVoucherDate.textContent='전표일자';
      } else {
        $title.textContent='매출전표 등록';
        if($lblSaleCode) $lblSaleCode.textContent='판매코드 *';
        if($lblSaleDate) $lblSaleDate.textContent='판매일자';
        if($lblVoucherDate) $lblVoucherDate.textContent='전표일자';
      }

      const today=new Date().toISOString().slice(0,10);
      if($voucherDt) $voucherDt.value=today; if($saleDt) $saleDt.value=today; if($writeDt) $writeDt.value=today;
      if($voucherNo) $voucherNo.value='';
      const $resv = q('#vf-resvId'); if($resv) $resv.value='';
      fetchNextVoucherNo(type, today);

      if($saleCode) $saleCode.value=''; if($partner) $partner.value=''; if($remark) $remark.value='';
      if($emp){
        if (currentUserName) {
          if (!$emp.value || looksLikeCode($emp.value)) $emp.value = currentUserName;
        } else {
          if (looksLikeCode($emp.value)) $emp.value = '';
        }
      }
      if($taxSel) $taxSel.value='TAXABLE';

      vfBindings = rewireNumericFields();

      if($voucherDt){ $voucherDt.onchange=()=> fetchNextVoucherNo(type, $voucherDt.value||''); }

      /* 모달 내부 아이콘 버튼 훅 */
      const $vfIconFindPartner = document.getElementById('vf-icon-find-partner');
      const $vfIconFindSale    = document.getElementById('vf-icon-find-saleCode');

      function openPartnerPickerInModal(){
        const targetType = (type==='BUY') ? 'supplier' : 'partner';
        if (typeof window.openModal === 'function') {
          window.openModal(targetType,(row)=>{ if($partner) $partner.value = row?.partnerName || row?.supplierName || ''; });
        } else {
          toast('공통 모달 스크립트를 불러오지 못했어요.');
        }
      }
      function openCodePickerInModal(){
        const modalType=(type==='BUY')?'buy':'sales';
        if (typeof window.openModal !== 'function') { toast('검색 모달 스크립트를 불러오지 못했어요.'); return; }
        window.openModal(modalType,(row)=>{
          if($saleCode) $saleCode.value=(type==='BUY') ? (row?.buyCode??'') : (row?.salesCode??'');
          const pickedPartner = row?.partnerName || row?.supplierName || row?.correspondent || row?.customerName || row?.partner || row?.clientName || row?.buyerName || '';
          if ($partner && pickedPartner) $partner.value = pickedPartner;
          const pickedDate = (type==='BUY') ? (row?.purchaseDate || row?.buyDate) : (row?.salesDate);
          if ($saleDt && pickedDate) { const d=new Date(pickedDate); $saleDt.value=isNaN(d)?String(pickedDate).slice(0,10):d.toISOString().slice(0,10); }
          if ($taxSel && row?.taxCode) { const tc=String(row.taxCode).toUpperCase(); if (['TAXABLE','ZERO','EXEMPT'].includes(tc)) $taxSel.value=tc; }
          const pickedTotal = [row?.amountTotal,row?.salesAmount,row?.buyAmountTotal,row?.amount,row?.total].map(unfmt).find(v=>v>0)||0;
          if (vfBindings) {
            const { syncView } = vfBindings;
            const p = computeFromTotal(pickedTotal, $taxSel.value);
            lastCalc.mode = 'TOTAL';
            syncView(p);
            if (!pickedTotal) toast('선택한 코드에 총금액 정보가 없어 금액을 0으로 설정했어요.');
          }
        });
      }

      $vfIconFindPartner?.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); openPartnerPickerInModal(); });
      $vfIconFindPartner?.addEventListener('keydown', (e)=>{ if (e.key==='Enter' || e.key===' ') { e.preventDefault(); openPartnerPickerInModal(); } });

      $vfIconFindSale?.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); openCodePickerInModal(); });
      $vfIconFindSale?.addEventListener('keydown', (e)=>{ if (e.key==='Enter' || e.key===' ') { e.preventDefault(); openCodePickerInModal(); } });

      vfModal.show();
    }
    /* ---------- 전표 등록 모달 끝 ---------- */

    // ★ 유효성 검사 (VAT 제외)
    function clearInvalid(...els){
      els.forEach(el=>{
        el?.classList?.remove('is-invalid');
        el?.removeAttribute?.('aria-invalid');
        el?.removeAttribute?.('data-error');
      });
    }
    function markInvalid(el, msg){
      if(!el) return;
      el.classList.add('is-invalid');
      el.setAttribute('aria-invalid','true');
      if(msg) el.setAttribute('data-error', msg);
    }
    function validateForm(){
      const errs = [];
      const $voucherDate = document.getElementById('vf-voucherDate');
      const $saleDate    = document.getElementById('vf-saleDate');
      const $partner     = document.getElementById('vf-partnerName');
      const $saleCode    = document.getElementById('vf-saleCode');
      const $typeBtn     = document.getElementById('vf-title');
      const $supply      = document.getElementById('vf-supply');
      const $total       = document.getElementById('vf-total');
      const $taxType     = document.getElementById('vf-taxType');

      clearInvalid($voucherDate,$saleDate,$partner,$saleCode,$supply,$total,$taxType);

      const titleTxt = ($typeBtn?.textContent||'').toUpperCase();
      const isBuy = titleTxt.includes('매입'); // 저장 로직의 isBuy 판별과 동일

      // 1) 날짜 필수
      if (!($voucherDate?.value)) { errs.push({el:$voucherDate, msg:'전표일자를 입력하세요.'}); }
      if (!($saleDate?.value))    { errs.push({el:$saleDate,    msg:(isBuy?'구매일자':'판매일자')+'를 입력하세요.'}); }

      // 2) 거래처 필수
      if (!($partner?.value?.trim())) { errs.push({el:$partner, msg:'거래처를 선택하세요.'}); }

      // 3) 코드 필수 (매출/매입 모두)
      if (!($saleCode?.value?.trim())) {
        errs.push({el:$saleCode, msg:(isBuy?'구매코드':'판매코드')+'를 선택하세요.'});
      }

      // 4) 금액 검증 (★ VAT 제외: 공급가액/총액 중 하나만 양수면 통과)
      const supplyVal = unfmt($supply?.value);
      const totalVal  = unfmt($total?.value);
      const validAmount = (Number.isFinite(supplyVal) && supplyVal>0) || (Number.isFinite(totalVal) && totalVal>0);
      if (!validAmount) {
        errs.push({el:$supply, msg:'공급가액 또는 총금액 중 하나는 0보다 커야 합니다.'});
        errs.push({el:$total,  msg:'공급가액 또는 총금액 중 하나는 0보다 커야 합니다.'});
      }

      // 5) 부가세유형 값 유효 (포맷만 확인)
      const taxVal = ($taxType?.value||'').toUpperCase();
      if (!['TAXABLE','ZERO','EXEMPT'].includes(taxVal)) {
        errs.push({el:$taxType, msg:'부가세유형이 올바르지 않습니다.'});
      }

      if (errs.length){
        // 첫 에러에 포커스, 표시
        errs.forEach(e=>markInvalid(e.el, e.msg));
        const first = errs[0];
        first?.el?.focus?.();
        toast('입력값을 확인하세요: ' + (first?.msg||'필수항목 누락'));
        return false;
      }
      return true;
    }

    // 입력 시 invalid 해제
    ['vf-voucherDate','vf-saleDate','vf-partnerName','vf-saleCode','vf-supply','vf-total','vf-taxType']
      .forEach(id=>{
        const el = document.getElementById(id);
        el?.addEventListener('input', ()=>clearInvalid(el));
        el?.addEventListener('change', ()=>clearInvalid(el));
      });

    // 저장 버튼
    const $saveBtn = document.getElementById('vf-save');
    $saveBtn?.addEventListener('click', async () => {
      // ★ 저장 전 유효성 검사 (VAT 제외)
      if (!validateForm()) return;

      const isBuy = document.getElementById('vf-title').textContent.includes('매입');

      // ★ 담당자 이름 값 확보
      const empNameInput = document.getElementById('vf-empName')?.value || '';
      const employeeName = currentUserName || empNameInput || null;

      const body = isBuy
        ? {
            reservationId: (document.getElementById('vf-resvId')?.value || null),
            voucherDate: document.getElementById('vf-voucherDate').value || null,
            buyCode: document.getElementById('vf-saleCode').value || null,
            partnerName: document.getElementById('vf-partnerName').value || null,
            employee: employeeName,
            employeeName: employeeName,
            taxCode: document.getElementById('vf-taxType').value || 'TAXABLE',
            amountSupply: unfmt(document.getElementById('vf-supply').value),
            amountVat:    unfmt(document.getElementById('vf-vat').value),   // 존재하지만 검증은 안 함
            amountTotal:  unfmt(document.getElementById('vf-total').value),
            remark: document.getElementById('vf-remark').value || null,
          }
        : {
            reservationId: (document.getElementById('vf-resvId')?.value || null),
            voucherDate: document.getElementById('vf-voucherDate').value || null,
            salesCode: document.getElementById('vf-saleCode').value || null,
            partnerName: document.getElementById('vf-partnerName').value || null,
            employee: employeeName,
            employeeName: employeeName,
            taxCode: document.getElementById('vf-taxType').value || 'TAXABLE',
            amountSupply: unfmt(document.getElementById('vf-supply').value),
            amountVat:    unfmt(document.getElementById('vf-vat').value),   // 존재하지만 검증은 안 함
            amountTotal:  unfmt(document.getElementById('vf-total').value),
            remark: document.getElementById('vf-remark').value || null,
          };

      const url = isBuy ? '/api/statements/buy' : '/api/statements/sales';
      const csrfToken  = document.querySelector('meta[name="_csrf"]')?.content;
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';

      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(csrfToken ? { [csrfHeader]: csrfToken } : {})
          },
          body: JSON.stringify(body),
        });
        const text = await res.text();
        if (res.status === 403) { throw new Error('403 Forbidden - CSRF 토큰 누락/만료. 새로고침 후 다시 시도하거나 로그인 상태를 확인하세요.'); }
        if (!res.ok) throw new Error(text || 'save failed');

        const { voucherNo } = text ? JSON.parse(text) : {};
        if (voucherNo) document.getElementById('vf-voucherNo').value = voucherNo;

        toast(`저장되었습니다${voucherNo ? `: ${voucherNo}` : ''}`);
        (window.bootstrap?.Modal.getInstance(document.getElementById('voucherFormModal')))?.hide?.();
        document.getElementById('btn-refresh')?.click();
      } catch (e) { console.error(e); toast('저장 실패: ' + (e.message || '')); }
    });
  });
  </script>

</body>
</html>
