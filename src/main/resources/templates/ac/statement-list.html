<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
  <meta charset="UTF-8" />
  <title>ì „í‘œ í†µí•©ê´€ë¦¬</title>

  <style>
    #employee-table { height: calc(100vh - 260px); }
    .btn-type .btn { min-width: 70px; }
    .input-with-icon { display:flex; gap:6px; align-items:center; }
    .input-with-icon .form-control { width:220px; }
    .toast-min{position:fixed;right:24px;bottom:24px;background:#333;color:#fff;padding:10px 14px;border-radius:8px;opacity:.95;z-index:2000}

    /* ì „í‘œ ë“±ë¡ ëª¨ë‹¬ í¼ */
    .vf-box{background:#f4f5f7;border-radius:8px;padding:14px;border:1px solid #ddd}
    .vf-label{font-weight:600}
    .vf-hr{border-top:1px dashed #d7d7d7;margin:6px 0 10px}
    .vf-num{text-align:right}

    /* ê²¹ ëª¨ë‹¬ */
    .modal.stack-top { z-index: 1065; }
    .modal-backdrop.stack-top { z-index: 1060; }

    /* ì „í‘œë²ˆí˜¸ í•„ë“œì— ë¡œë”© í‘œì‹œìš© */
    .vf-loading{ opacity:.6 }

    /* ===== ë¡œë”© ì˜¤ë²„ë ˆì´ ===== */
    .table-wrap { position: relative; }
    .loading-overlay {
      position:absolute; inset:0; display:none;
      align-items:center; justify-content:center;
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(1px);
      z-index: 50;
    }
    .loading-overlay.show { display:flex; }
    .loading-box {
      display:flex; align-items:center; gap:10px;
      padding:10px 14px; border-radius:10px;
      background:#fff; border:1px solid #e4e6eb; box-shadow:0 4px 18px rgba(0,0,0,.08);
      font-weight:600; color:#333;
    }
  </style>
</head>

<body layout:fragment="content">
  <div id="layoutSidenav_content">
    <main>
      <div class="container_fluid px-4">

        <div class="d-flex align-items-center justify-content-between mt-4 mb-2">
          <h1 class="mb-0">ì „í‘œ ê´€ë¦¬</h1>
        </div>

        <!-- ìƒë‹¨ ì•¡ì…˜ -->
        <div class="d-flex align-items-center flex-wrap gap-2 mb-3">
          <button type="button" class="btn btn-outline-primary open-voucher-form" data-type="SALES">ë§¤ì¶œì „í‘œ ë“±ë¡</button>
          <button type="button" class="btn btn-outline-primary open-voucher-form" data-type="BUY">ë§¤ì…ì „í‘œ ë“±ë¡</button>

          <div class="btn-group btn-type ms-2" role="group" aria-label="type-filter">
            <button type="button" class="btn btn-primary" data-type="ALL">ì „ì²´</button>
            <button type="button" class="btn btn-outline-primary" data-type="SALES">ë§¤ì¶œ</button>
            <button type="button" class="btn btn-outline-primary" data-type="BUY">ë§¤ì…</button>
            <button type="button" class="btn btn-outline-primary" data-type="MONEY">ìˆ˜ê¸ˆ</button>
            <button type="button" class="btn btn-outline-primary" data-type="PAYMENT">ì§€ê¸‰</button>
          </div>

          <div class="ms-auto d-flex align-items-center gap-2">
            <button id="btn-print" class="btn btn-secondary">ì¸ì‡„</button>
            <button id="btn-export" class="btn btn-dark">Excel</button>
          </div>
        </div>

        <!-- ê²€ìƒ‰ ë°” -->
        <div class="d-flex align-items-end flex-wrap gap-3 mb-2">
          <div>
            <label class="form-label">ê±°ë˜ì²˜ëª…</label>
            <div class="input-with-icon">
              <input id="partnerName" type="text" class="form-control" placeholder="ì¡°íšŒ í›„ ë“±ë¡" readonly>
              <button id="btn-find-partner" type="button" class="btn btn-primary">ê²€ìƒ‰</button>
            </div>
          </div>

          <div>
            <label class="form-label">ì „í‘œë²ˆí˜¸</label>
            <div class="input-with-icon">
              <input id="voucherNo" type="text" class="form-control">
              <button hidden id="btn-find-voucher" type="button" class="btn btn-primary">ê²€ìƒ‰</button>
            </div>
          </div>

          <div>
            <label class="form-label"></label>
            <input id="fromDate" type="date" class="form-control w-auto">
          </div>
          <div>
            <label class="form-label"></label>
            <input id="toDate" type="date" class="form-control w-auto">
          </div>

          <div class="d-flex gap-2">
            <button id="btn-search" class="btn btn-warning">ê²€ìƒ‰</button>
            <button id="btn-reset" class="btn btn-outline-secondary">ì´ˆê¸°í™”</button>
            <!-- âœ… ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ -->
            <button id="btn-refresh" class="btn btn-outline-secondary">ìƒˆë¡œê³ ì¹¨</button>
          </div>
        </div>

        <!-- ë©”ì¸ í…Œì´ë¸” + ë¡œë”© ì˜¤ë²„ë ˆì´ -->
        <div class="table-wrap">
          <div id="employee-table"></div>
          <div id="tbl-loading" class="loading-overlay" aria-hidden="true">
            <div class="loading-box">
              <div class="spinner-border" role="status" aria-label="loading"></div>
              <span>ë°ì´í„° ë¡œë”© ì¤‘â€¦</span>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- ê³µí†µ ëª¨ë‹¬(fragment) + ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ -->
  <div th:replace="~{common/modal :: commonModal}"></div>
  <script th:src="@{/main/js/modal.js}" defer></script>

  <!-- SheetJS -->
  <script src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js" defer></script>

  <!-- â–¼ ì „í‘œ ë“±ë¡ ëª¨ë‹¬ -->
  <div class="modal fade" id="voucherFormModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header py-2">
          <h5 class="modal-title"><span id="vf-title">ì „í‘œ ë“±ë¡</span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="vf-box">
            <div class="row g-2">
              <!-- ì „í‘œì¼ì -->
              <div class="col-md-6">
                <label class="form-label vf-label">ì „í‘œì¼ì</label>
                <div class="input-group">
                  <input id="vf-voucherDate" type="date" class="form-control">
                </div>
              </div>

              <!-- ì „í‘œë²ˆí˜¸(ì„œë²„ ì˜ˆì¸¡ê°’ í‘œì‹œ) -->
              <div class="col-md-6">
                <label class="form-label vf-label">ì „í‘œë²ˆí˜¸</label>
                <input id="vf-voucherNo" type="text" class="form-control" placeholder="ìë™ë°œë²ˆ" readonly>
              </div>

              <!-- íŒë§¤/ë§¤ì… ì½”ë“œ -->
              <div class="col-md-6">
                <label class="form-label vf-label">íŒë§¤ì½”ë“œ</label>
                <div class="input-group">
                  <input id="vf-saleCode" type="text" class="form-control" placeholder="">
                  <button id="vf-find-saleCode" class="btn btn-outline-secondary" type="button">ğŸ”</button>
                </div>
              </div>

              <!-- ê±°ë˜ì²˜ -->
              <div class="col-md-6">
                <label class="form-label vf-label">ê±°ë˜ì²˜</label>
                <div class="input-group">
                  <input id="vf-partnerName" type="text" class="form-control" placeholder="">
                  <button id="vf-find-partner" class="btn btn-outline-secondary" type="button">ğŸ”</button>
                </div>
              </div>

              <!-- íŒë§¤ì¼ì -->
              <div class="col-md-6">
                <label class="form-label vf-label">íŒë§¤ì¼ì</label>
                <div class="input-group">
                  <input id="vf-saleDate" type="date" class="form-control">
                </div>
              </div>

              <!-- ë‹´ë‹¹ì -->
              <div class="col-md-6">
                <label class="form-label vf-label">ë‹´ë‹¹ì</label>
                <div class="input-group">
                  <input id="vf-empName" type="text" class="form-control" placeholder="" readonly>
                  <button hidden id="vf-find-emp" class="btn btn-outline-secondary" type="button">ğŸ”</button>
                </div>
              </div>

              <!-- ì‘ì„±ì¼ì -->
              <div class="col-md-6">
                <label class="form-label vf-label">ì‘ì„±ì¼ì</label>
                <div class="input-group">
                  <input id="vf-writeDate" type="date" class="form-control">
                </div>
              </div>
            </div>

            <div class="vf-hr"></div>

            <div class="row g-2">
              <div class="col-12">
                <label class="form-label vf-label">ë¶€ê°€ì„¸ìœ í˜•</label>
                <select id="vf-taxType" class="form-select">
                  <option value="TAXABLE">ê³¼ì„¸(10%)</option>
                  <option value="ZERO">ì˜ì„¸(0%)</option>
                  <option value="EXEMPT">ë©´ì„¸(0%)</option>
                </select>
              </div>

              <div class="col-12">
                <label class="form-label vf-label">ê³µê¸‰ê°€ì•¡</label>
                <input id="vf-supply" type="text" class="form-control vf-num" value="0">
              </div>
              <div class="col-12">
                <label class="form-label vf-label">ë¶€ê°€ì„¸</label>
                <input id="vf-vat" type="text" class="form-control vf-num" value="0" readonly>
              </div>
              <div class="col-12">
                <label class="form-label vf-label">ì´ ê¸ˆì•¡</label>
                <input id="vf-total" type="text" class="form-control vf-num" value="0" readonly>
              </div>
              <div class="col-12">
                <label class="form-label vf-label">ì ìš”</label>
                <input id="vf-remark" type="text" class="form-control" placeholder="">
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer py-2">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
          <button id="vf-save" type="button" class="btn btn-primary">ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>

  <!-- í˜ì´ì§€ ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
  window.addEventListener('DOMContentLoaded', () => {
    /* ---------- ìœ í‹¸ ---------- */
    function toast(msg, ms=1600){
      const t=document.createElement('div');
      t.className='toast-min';
      t.textContent=msg;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), ms);
    }
    const fmt   = n => Number(n||0).toLocaleString();
    const unfmt = s => Number(String(s||'').replace(/[^\d.-]/g,''))||0;

    /* ë¡œë”© ì˜¤ë²„ë ˆì´ ì œì–´ */
    const $overlay = document.getElementById('tbl-loading');
    const showLoading = () => $overlay?.classList.add('show');
    const hideLoading = () => $overlay?.classList.remove('show');

    /* ê²¹ ëª¨ë‹¬ */
    const cmEl = document.getElementById('commonModal');
    if (cmEl) {
      cmEl.addEventListener('show.bs.modal', () => {
        const opened = document.querySelectorAll('.modal.show').length;
        const z = 1065 + opened * 10;
        cmEl.classList.add('stack-top');
        cmEl.style.zIndex = z;
        setTimeout(() => {
          const bds = document.querySelectorAll('.modal-backdrop');
          const last = bds[bds.length - 1];
          if (last) { last.classList.add('stack-top'); last.style.zIndex = z - 5; }
        });
      });
    }

    /* ë¡œê·¸ì¸ ì‚¬ìš©ìëª…(ë‹´ë‹¹ì ìë™ ì„¸íŒ…) */
    let currentUserName = '';
    fetch('/api/me', { credentials: 'same-origin' })
      .then(r => r.ok ? r.json() : {} )
      .then(j => { currentUserName = j?.name || ''; })
      .catch(()=>{});

    /* ---------- ëª©ë¡ í…Œì´ë¸” ---------- */
    let currentType='ALL';

    function paramsFor(page0, size){
      return {
        type:       currentType,
        keyword:    document.getElementById('partnerName').value || '',
        voucherNo:  document.getElementById('voucherNo').value || '',
        fromDate:   document.getElementById('fromDate').value || '',
        toDate:     document.getElementById('toDate').value || '',
        page:       page0 ?? 0,
        size:       size ?? mainTable?.getPageSize() ?? 20,
      };
    }

    // ì•ˆì „ JSON ìš”ì²­
    async function fetchPageJson(url) {
      const res  = await fetch(url, { method: 'GET', headers: { 'Accept':'application/json' }});
      const ctyp = (res.headers.get('content-type') || '').toLowerCase();
      const text = await res.text();
      if (!res.ok || !ctyp.includes('application/json')) {
        console.error('[STATEMENTS] bad response', res.status, text);
        throw new Error(`Bad response ${res.status}`);
      }
      return text ? JSON.parse(text) : {};
    }

    const mainTable = new Tabulator("#employee-table",{
      layout:"fitColumns",
      pagination:true, paginationMode:"remote",
      paginationSize:20, paginationSizeSelector:[20,50,100],
      columns:[
        {titleFormatter:"rowSelection",formatter:"rowSelection",titleFormatterParams:{rowRange:"active"},headerSort:false,width:55,hozAlign:"center",headerHozAlign:"center"},
        {title:"ì „í‘œë²ˆí˜¸",field:"voucherNo",hozAlign:"center",width:130},
        {
          title:"ìœ í˜•", field:"type", hozAlign:"center", width:100,
          formatter:(c)=>{
            const t = c.getValue();
            const map = {
              SALES:{label:"ë§¤ì¶œ",cls:"bg-primary"},
              BUY:{label:"ë§¤ì…",cls:"bg-success"},
              MONEY:{label:"ìˆ˜ê¸ˆ",cls:"bg-info"},
              PAYMENT:{label:"ì§€ê¸‰",cls:"bg-warning"},
            };
            const m = map[t] || {label:t||"ê¸°íƒ€",cls:"bg-secondary"};
            return `<span class="badge ${m.cls}">${m.label}</span>`;
          }
        },
        {title:"ê±°ë˜ì²˜ëª…",field:"partnerName",minWidth:180},
        {title:"ì´ì•¡",field:"amountTotal",hozAlign:"right",minWidth:110,formatter:(c)=>fmt(c.getValue())},
        {title:"ì ìš”",field:"remark",minWidth:220},
        {title:"ì „í‘œì¼ì",field:"voucherDate",hozAlign:"center",width:120,
          formatter:(c)=>{const v=c.getValue();if(!v) return "";const d=new Date(v);return isNaN(d)?String(v).slice(0,10):d.toISOString().slice(0,10);}
        },
      ],
      ajaxURL: "/api/statements",
      ajaxRequestFunc: async (_url, _config, params) => {
        showLoading();                               // ì˜¤ë²„ë ˆì´ ON
        try {
          const page0 = (params?.page ?? 1) - 1;
          const query = paramsFor(page0, params?.size);
          const fullUrl = `/api/statements?${new URLSearchParams(query).toString()}`;
          console.log("[STATEMENTS] GET", fullUrl);

          const json = await fetchPageJson(fullUrl);
          const rows = Array.isArray(json) ? json : (json.content ?? []);
          const last = Array.isArray(json)
            ? 1
            : Math.max(1, json.totalPages ?? Math.ceil((json.totalElements || 0) / (json.size || query.size)));
          return { data: rows, last_page: last };
        } finally {
          hideLoading();                              // ì˜¤ë²„ë ˆì´ OFF (ì„±ê³µ/ì‹¤íŒ¨ ë¬´ê´€)
        }
      },
      ajaxError(error){
        console.error("[STATEMENTS] ajax error:", error);
        toast("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: " + (error?.message || ''));
      },
    });

    mainTable.on("tableBuilt",()=>requestAnimationFrame(()=>mainTable.redraw(true)));
    window.addEventListener('resize',()=>mainTable.redraw(true));

    // íƒ­ ì „í™˜
    document.querySelectorAll('.btn-type .btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.btn-type .btn').forEach(b=>{b.classList.remove('btn-primary');b.classList.add('btn-outline-primary');});
        btn.classList.remove('btn-outline-primary'); btn.classList.add('btn-primary');
        currentType = btn.getAttribute('data-type')||'ALL';
        mainTable.setPage(1);
      });
    });

    // ê²€ìƒ‰/ì´ˆê¸°í™”
    document.getElementById('btn-search').addEventListener('click',()=> mainTable.setPage(1));
    document.getElementById('btn-reset').addEventListener('click',()=>{
      ['partnerName','voucherNo','fromDate','toDate'].forEach(id=>document.getElementById(id).value='');
      currentType='ALL';
      document.querySelectorAll('.btn-type .btn').forEach(b=>{
        b.classList.remove('btn-primary');b.classList.add('btn-outline-primary');
        if(b.dataset.type==='ALL'){b.classList.remove('btn-outline-primary');b.classList.add('btn-primary');}
      });
      mainTable.setPage(1);
    });

    // âœ… ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼: ë²„íŠ¼ ìŠ¤í”¼ë„ˆ + ì˜¤ë²„ë ˆì´
    const $refresh = document.getElementById('btn-refresh');
    $refresh?.addEventListener('click', async ()=>{
      if ($refresh.disabled) return;
      const orig = $refresh.innerHTML;
      $refresh.disabled = true;
      $refresh.innerHTML = `ìƒˆë¡œê³ ì¹¨ <span class="spinner-border spinner-border-sm ms-1" role="status" aria-label="loading"></span>`;
      showLoading();
      try {
        await mainTable.replaceData();               // ë‚´ë¶€ì—ì„œ ajaxRequestFunc í˜¸ì¶œ
      } finally {
        hideLoading();
        $refresh.disabled = false;
        $refresh.innerHTML = orig;
      }
    });

    /* ---------- ì „í‘œ ë“±ë¡ ëª¨ë‹¬(ì €ì¥ ì—°ë™) ---------- */
    const vfEl    = document.getElementById('voucherFormModal');
    const vfModal = (window.bootstrap?.Modal && vfEl) ? new bootstrap.Modal(vfEl) : null;
    const q = (sel) => vfEl ? vfEl.querySelector(sel) : null;

    let currentVoucherType = 'SALES';

    async function fetchNextVoucherNo(type, dateStr){
      const $vno = q('#vf-voucherNo');
      if(!$vno){ console.warn('[voucher] #vf-voucherNo not found'); return; }
      try{
        $vno.classList.add('vf-loading');
        $vno.value = 'ë°œë²ˆ ì¡°íšŒì¤‘...';
        const qs = new URLSearchParams({ type, ...(dateStr?{date:dateStr}:{}) });
        const res = await fetch(`/api/vouchers/next?${qs.toString()}`, { method:'GET' });
        const text = await res.text();
        if(!res.ok) throw new Error(text||'fetch failed');
        const j = text ? JSON.parse(text) : {};
        $vno.value = j?.voucherNo || '';
      }catch(e){
        console.error(e);
        $vno.value = '';
        toast('ì „í‘œë²ˆí˜¸ ì¡°íšŒ ì‹¤íŒ¨');
      }finally{
        $vno.classList.remove('vf-loading');
      }
    }

    document.querySelectorAll('.open-voucher-form').forEach(btn=>{
      btn.addEventListener('click',()=>{
        currentVoucherType = btn.dataset.type === 'BUY' ? 'BUY' : 'SALES';
        openVoucherForm(currentVoucherType);
      });
    });

    function openVoucherForm(type){
      if(!vfEl){ toast('ì „í‘œ ë“±ë¡ ëª¨ë‹¬ DOM(#voucherFormModal)ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); return; }
      if(!vfModal){ toast('ë¶€íŠ¸ìŠ¤íŠ¸ë© ëª¨ë‹¬ ìŠ¤í¬ë¦½íŠ¸ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); return; }

      const $title      = q('#vf-title');
      const $voucherDt  = q('#vf-voucherDate');
      const $saleDt     = q('#vf-saleDate');
      const $writeDt    = q('#vf-writeDate');
      const $voucherNo  = q('#vf-voucherNo');
      const $saleCode   = q('#vf-saleCode');
      const $partner    = q('#vf-partnerName');
      const $emp        = q('#vf-empName');
      const $taxSel     = q('#vf-taxType');
      const $remark     = q('#vf-remark');
      const $findPartnerBtn = q('#vf-find-partner');
      const $findSaleBtn    = q('#vf-find-saleCode');
      const $findEmpBtn     = q('#vf-find-emp');

      if(!$title || !$voucherDt || !$voucherNo){
        console.warn('[voucher] modal essential elements missing', { $title, $voucherDt, $voucherNo });
        toast('ì „í‘œ ë“±ë¡ ëª¨ë‹¬ êµ¬ì„±ìš”ì†Œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        return;
      }

      $title.textContent = (type==='BUY' ? 'ë§¤ì…ì „í‘œ ë“±ë¡' : 'ë§¤ì¶œì „í‘œ ë“±ë¡');

      const today = new Date().toISOString().slice(0,10);
      if($voucherDt) $voucherDt.value = today;
      if($saleDt)    $saleDt.value    = today;
      if($writeDt)   $writeDt.value   = today;

      $voucherNo.value = '';
      fetchNextVoucherNo(type, today);

      if($saleCode) $saleCode.value = '';
      if($partner)  $partner.value  = '';
      if($remark)   $remark.value   = '';
      if($emp)      $emp.value      = (typeof currentUserName === 'string' ? currentUserName : '');

      if($taxSel)   $taxSel.value   = 'TAXABLE';
      setAmounts(0, 'TAXABLE');

      if($voucherDt){
        $voucherDt.onchange = ()=> fetchNextVoucherNo(type, $voucherDt.value || '');
      }

      if($findPartnerBtn){
        $findPartnerBtn.onclick = ()=> openModal('partner',(row)=>{ if($partner) $partner.value = row?.partnerName ?? ''; });
      }
      if($findSaleBtn){
        $findSaleBtn.onclick = ()=> openModal('sales',(row)=>{ if($saleCode) $saleCode.value = row?.salesCode ?? ''; });
      }
      if($findEmpBtn){
        $findEmpBtn.onclick = ()=> toast('ë‹´ë‹¹ìëŠ” ë¡œê·¸ì¸ ì‚¬ìš©ìë¡œ ìë™ ì…ë ¥ë©ë‹ˆë‹¤.');
      }

      vfModal.show();
    }

    // ê¸ˆì•¡ ê³„ì‚°
    const $supply = document.getElementById('vf-supply');
    const $vat    = document.getElementById('vf-vat');
    const $total  = document.getElementById('vf-total');
    const $taxSel = document.getElementById('vf-taxType');

    function setAmounts(supply, taxType){
      const rate = (taxType==='TAXABLE') ? 0.1 : 0.0;
      const vat  = Math.round(supply * rate);
      const tot  = supply + vat;
      $supply.value = fmt(supply);
      $vat.value    = fmt(vat);
      $total.value  = fmt(tot);
    }
    $supply.addEventListener('input', ()=> setAmounts(unfmt($supply.value), $taxSel.value));
    $supply.addEventListener('blur',  ()=> setAmounts(unfmt($supply.value), $taxSel.value));
    $taxSel.addEventListener('change',()=> setAmounts(unfmt($supply.value), $taxSel.value));

    // ì €ì¥
    document.getElementById('vf-save').addEventListener('click', async () => {
      const type = document.getElementById('vf-title').textContent.includes('ë§¤ì…') ? 'BUY' : 'SALES';

      const body = (type === 'BUY')
        ? {
            voucherDate: document.getElementById('vf-voucherDate').value || null,
            buyCode: document.getElementById('vf-saleCode').value || null,
            partnerName: document.getElementById('vf-partnerName').value || null,
            employee: document.getElementById('vf-empName').value || null,
            taxCode: document.getElementById('vf-taxType').value || 'TAXABLE',
            amountSupply: unfmt(document.getElementById('vf-supply').value),
            amountVat:    unfmt(document.getElementById('vf-vat').value),
            amountTotal:  unfmt(document.getElementById('vf-total').value),
            remark: document.getElementById('vf-remark').value || null,
          }
        : {
            voucherDate: document.getElementById('vf-voucherDate').value || null,
            salesCode: document.getElementById('vf-saleCode').value || null,
            partnerName: document.getElementById('vf-partnerName').value || null,
            employee: document.getElementById('vf-empName').value || null,
            taxCode: document.getElementById('vf-taxType').value || 'TAXABLE',
            amountSupply: unfmt(document.getElementById('vf-supply').value),
            amountVat:    unfmt(document.getElementById('vf-vat').value),
            amountTotal:  unfmt(document.getElementById('vf-total').value),
            remark: document.getElementById('vf-remark').value || null,
          };

      const url = (type === 'BUY') ? '/api/statements/buy' : '/api/statements/sales';

      const csrfToken  = document.querySelector('meta[name="_csrf"]')?.content;
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';

      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(csrfToken ? { [csrfHeader]: csrfToken } : {})
          },
          body: JSON.stringify(body),
        });
        const text = await res.text();
        console.log("[SAVE]", url, "status:", res.status, "body:", text);
        if (res.status === 403) {
          throw new Error('403 Forbidden - CSRF í† í° ëˆ„ë½/ë§Œë£Œ. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        }
        if (!res.ok) throw new Error(text || 'save failed');

        const { voucherNo } = text ? JSON.parse(text) : {};
        if (voucherNo) document.getElementById('vf-voucherNo').value = voucherNo;

        toast(`ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤${voucherNo ? `: ${voucherNo}` : ''}`);
        vfModal?.hide();

        // ì €ì¥ í›„ ëª©ë¡ ì¦‰ì‹œ ì¬ì¡°íšŒ
        document.getElementById('btn-refresh')?.click();
      } catch (e) {
        console.error(e); toast('ì €ì¥ ì‹¤íŒ¨: ' + (e.message || ''));
      }
    });
  });
  </script>

</body>
</html>
