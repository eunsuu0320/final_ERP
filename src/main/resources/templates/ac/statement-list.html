<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
  <meta charset="UTF-8" />
  <title>ì „í‘œ í†µí•©ê´€ë¦¬</title>

  <!-- Tabulator (í•„ìˆ˜) -->
  <link href="https://unpkg.com/tabulator-tables@5.6.2/dist/css/tabulator.min.css" rel="stylesheet">
  <script src="https://unpkg.com/tabulator-tables@5.6.2/dist/js/tabulator.min.js" defer></script>

  <!-- Bootstrap JS (ëª¨ë‹¬ ë™ì‘ìš©; ë ˆì´ì•„ì›ƒì— ì´ë¯¸ ìˆìœ¼ë©´ ì¤‘ë³µ ë¬´ë°©) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

  <style>
    #employee-table { height: calc(100vh - 260px); }
    .btn-type .btn { min-width:70px; }
    .input-with-icon { display:flex; gap:6px; align-items:center; }
    .input-with-icon .form-control { width:220px; }
    .toast-min{position:fixed;right:24px;bottom:24px;background:#333;color:#fff;padding:10px 14px;border-radius:8px;opacity:.95;z-index:2000}

    /* ì „í‘œ ë“±ë¡ ëª¨ë‹¬ í¼ */
    .vf-box{background:#f4f5f7;border-radius:8px;padding:14px;border:1px solid #ddd}
    .vf-label{font-weight:600}
    .vf-hr{border-top:1px dashed #d7d7d7;margin:6px 0 10px}
    .vf-num{text-align:right}
  </style>
</head>

<body layout:fragment="content">
  <div id="layoutSidenav_content">
    <main>
      <div class="container_fluid px-4">

        <div class="d-flex align-items-center justify-content-between mt-4 mb-2">
          <h1 class="mb-0">ì „í‘œ ê´€ë¦¬</h1>
        </div>

        <!-- ìƒë‹¨ ì•¡ì…˜ -->
        <div class="d-flex align-items-center flex-wrap gap-2 mb-3">
          <!-- ëª¨ë‹¬ ì—´ê¸° ë²„íŠ¼ -->
          <button type="button" class="btn btn-outline-primary open-voucher-form" data-type="SALES">ë§¤ì¶œì „í‘œ ë“±ë¡</button>
          <button type="button" class="btn btn-outline-primary open-voucher-form" data-type="BUY">ë§¤ì…ì „í‘œ ë“±ë¡</button>

          <!-- ì „í‘œ ìœ í˜• í† ê¸€ -->
          <div class="btn-group btn-type ms-2" role="group" aria-label="type-filter">
            <button type="button" class="btn btn-primary" data-type="ALL">ì „ì²´</button>
            <button type="button" class="btn btn-outline-primary" data-type="SALES">ë§¤ì¶œ</button>
            <button type="button" class="btn btn-outline-primary" data-type="BUY">ë§¤ì…</button>
            <button type="button" class="btn btn-outline-primary" data-type="MONEY">ìˆ˜ê¸ˆ</button>
            <button type="button" class="btn btn-outline-primary" data-type="PAYMENT">ì§€ê¸‰</button>
          </div>

          <div class="ms-auto d-flex align-items-center gap-2">
            <button id="btn-print" class="btn btn-secondary">ì¸ì‡„</button>
            <button id="btn-export" class="btn btn-dark">Excel</button>
          </div>
        </div>

        <!-- ê²€ìƒ‰ ë°” -->
        <div class="d-flex align-items-end flex-wrap gap-3 mb-2">
          <div>
            <label class="form-label">ê±°ë˜ì²˜ëª…</label>
            <div class="input-with-icon">
              <input id="partnerName" type="text" class="form-control" placeholder="ì¡°íšŒ í›„ ë“±ë¡" readonly>
              <button id="btn-find-partner" type="button" class="btn btn-primary">ê²€ìƒ‰</button>
            </div>
          </div>

          <div>
            <label class="form-label">ì „í‘œë²ˆí˜¸</label>
            <div class="input-with-icon">
              <input id="voucherNo" type="text" class="form-control" placeholder="ì¡°íšŒ í›„ ë“±ë¡">
            </div>
          </div>

          <div>
            <label class="form-label"></label>
            <input id="fromDate" type="date" class="form-control w-auto">
          </div>
          <div>
            <label class="form-label"></label>
            <input id="toDate" type="date" class="form-control w-auto">
          </div>

          <div class="d-flex gap-2">
            <button id="btn-search" class="btn btn-warning">ê²€ìƒ‰</button>
            <button id="btn-reset" class="btn btn-outline-secondary">ì´ˆê¸°í™”</button>
          </div>
        </div>

        <!-- ë©”ì¸ í…Œì´ë¸” -->
        <div id="employee-table"></div>

      </div>
    </main>
  </div>

  <!-- ê³µí†µ ëª¨ë‹¬(fragment) + ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ -->
  <div th:replace="~{common/modal :: commonModal}"></div>
  <script th:src="@{/main/js/modal.js}" defer></script>

  <!-- SheetJS -->
  <script src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js" defer></script>

  <!-- â–¼ ì „í‘œ ë“±ë¡ ëª¨ë‹¬(ë°ëª¨) -->
  <div class="modal fade" id="voucherFormModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header py-2">
          <h5 class="modal-title"><span id="vf-title">ì „í‘œ ë“±ë¡</span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="vf-box">
            <div class="row g-2">
              <!-- 1. ì „í‘œì¼ì -->
              <div class="col-md-6">
                <label class="form-label vf-label">ì „í‘œì¼ì</label>
                <div class="input-group">
                  <input id="vf-voucherDate" type="date" class="form-control">
                </div>
              </div>

              <!-- 3. ì „í‘œë²ˆí˜¸(ìë™) -->
              <div class="col-md-6">
                <label class="form-label vf-label">ì „í‘œë²ˆí˜¸</label>
                <input id="vf-voucherNo" type="text" class="form-control" placeholder="ìë™ ìƒì„±" readonly>
              </div>

              <!-- 2. íŒë§¤ì½”ë“œ -->
              <div class="col-md-6">
                <label class="form-label vf-label">íŒë§¤ì½”ë“œ</label>
                <div class="input-group">
                  <input id="vf-saleCode" type="text" class="form-control" placeholder="ëª¨ë‹¬ ì—°ë™ ì˜ˆì •(ë°ëª¨)" >
                  <button id="vf-find-saleCode" class="btn btn-outline-secondary" type="button">ğŸ”</button>
                </div>
              </div>

              <!-- ê±°ë˜ì²˜ -->
              <div class="col-md-6">
                <label class="form-label vf-label">ê±°ë˜ì²˜</label>
                <div class="input-group">
                  <input id="vf-partnerName" type="text" class="form-control" placeholder="ëª¨ë‹¬ ì—°ë™ ì˜ˆì •(ë°ëª¨)" >
                  <button id="vf-find-partner" class="btn btn-outline-secondary" type="button">ğŸ”</button>
                </div>
              </div>

              <!-- íŒë§¤ì¼ì -->
              <div class="col-md-6">
                <label class="form-label vf-label">íŒë§¤ì¼ì</label>
                <div class="input-group">
                  <input id="vf-saleDate" type="date" class="form-control">
                </div>
              </div>

              <!-- ë‹´ë‹¹ì -->
              <div class="col-md-6">
                <label class="form-label vf-label">ë‹´ë‹¹ì</label>
                <div class="input-group">
                  <input id="vf-empName" type="text" class="form-control" placeholder="ëª¨ë‹¬ ì—°ë™ ì˜ˆì •(ë°ëª¨)" >
                  <button id="vf-find-emp" class="btn btn-outline-secondary" type="button">ğŸ”</button>
                </div>
              </div>

              <!-- ì‘ì„±ì¼ì -->
              <div class="col-md-6">
                <label class="form-label vf-label">ì‘ì„±ì¼ì</label>
                <div class="input-group">
                  <input id="vf-writeDate" type="date" class="form-control">
                </div>
              </div>
            </div>

            <div class="vf-hr"></div>

            <div class="row g-2">
              <div class="col-12">
                <label class="form-label vf-label">ë¶€ê°€ì„¸ìœ í˜•</label>
                <select id="vf-taxType" class="form-select">
                  <option value="TAXABLE">ê³¼ì„¸(10%)</option>
                  <option value="ZERO">ì˜ì„¸(0%)</option>
                  <option value="EXEMPT">ë©´ì„¸(0%)</option>
                </select>
              </div>

              <div class="col-12">
                <label class="form-label vf-label">ê³µê¸‰ê°€ì•¡</label>
                <input id="vf-supply" type="text" class="form-control vf-num" value="0">
              </div>
              <div class="col-12">
                <label class="form-label vf-label">ë¶€ê°€ì„¸</label>
                <input id="vf-vat" type="text" class="form-control vf-num" value="0" readonly>
              </div>
              <div class="col-12">
                <label class="form-label vf-label">ì´ ê¸ˆì•¡</label>
                <input id="vf-total" type="text" class="form-control vf-num" value="0" readonly>
              </div>
              <div class="col-12">
                <label class="form-label vf-label">ì ìš”</label>
                <input id="vf-remark" type="text" class="form-control" placeholder="">
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer py-2">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
          <button id="vf-save" type="button" class="btn btn-primary">ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>
  <!-- â–² ì „í‘œ ë“±ë¡ ëª¨ë‹¬ -->

  <!-- í˜ì´ì§€ ìŠ¤í¬ë¦½íŠ¸ -->
 <script>
  window.addEventListener('DOMContentLoaded', () => {
    /* ---------- ê³µí†µ ---------- */
    function toast(msg, ms=1600){
      const t=document.createElement('div'); 
      t.className='toast-min'; 
      t.textContent=msg;
      document.body.appendChild(t); 
      setTimeout(()=>t.remove(), ms);
    }
    const fmt = n => Number(n||0).toLocaleString();
    const unfmt = s => Number(String(s||'').replace(/[^\d.-]/g,''))||0;

    // Spring Security CSRF ë©”íƒ€ì—ì„œ í† í°/í—¤ë”ëª… ì½ê¸°(ë ˆì´ì•„ì›ƒì— ì•„ë˜ ë©”íƒ€ê°€ ìˆë‹¤ê³  ê°€ì •)
    // <meta name="_csrf" th:content="${_csrf.token}"/>
    // <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    function getCsrf(){
      const token  = document.querySelector('meta[name="_csrf"]')?.content;
      const header = document.querySelector('meta[name="_csrf_header"]')?.content;
      return { token, header };
    }

    /* ---------- ëª©ë¡ í…Œì´ë¸” ---------- */
    function paramsFor(page0, size){
      return {
        type:       currentType,
        partner:    document.getElementById('partnerName').value || '',
        voucherNo:  document.getElementById('voucherNo').value || '',
        fromDate:   document.getElementById('fromDate').value || '',
        toDate:     document.getElementById('toDate').value || '',
        page:       page0 ?? 0,
        size:       size ?? mainTable?.getPageSize() ?? 20,
      };
    }

    let currentType='ALL';
    const mainTable = new Tabulator("#employee-table",{
      layout:"fitColumns",
      pagination:true, paginationMode:"remote",
      paginationSize:20, paginationSizeSelector:[20,50,100],
      columns:[
        {titleFormatter:"rowSelection",formatter:"rowSelection",titleFormatterParams:{rowRange:"active"},headerSort:false,width:55,hozAlign:"center",headerHozAlign:"center"},
        {title:"ì „í‘œë²ˆí˜¸",field:"voucherNo",hozAlign:"center",width:130},
        {title:"ìœ í˜•",field:"type",hozAlign:"center",width:100,formatter:(c)=>{const m={SALES:"ë§¤ì¶œ",BUY:"ë§¤ì…",MONEY:"ìˆ˜ê¸ˆ",PAYMENT:"ì§€ê¸‰"};const t=c.getValue();return `<span class="badge bg-secondary">${m[t]??t??'ê¸°íƒ€'}</span>`;}},
        {title:"ê±°ë˜ì²˜ëª…",field:"partnerName",minWidth:180},
        {title:"ì´ì•¡",field:"amountTotal",hozAlign:"right",minWidth:110,formatter:(c)=>fmt(c.getValue())},
        {title:"ì ìš”",field:"remark",minWidth:220},
        {title:"ì „í‘œì¼ì",field:"voucherDate",hozAlign:"center",formatter:(c)=>{const v=c.getValue();if(!v) return "";const d=new Date(v);return isNaN(d)?v:d.toISOString().slice(0,10);}},
      ],
      ajaxURL:"/api/statements",
      ajaxConfig:"GET",
      ajaxContentType:"json",
      ajaxURLGenerator:(url,_c,p)=>{const page0=(p.page??1)-1; const q=new URLSearchParams(paramsFor(page0,p.size)).toString(); return url+"?"+q;},
      ajaxResponse:(_u,_p,resp)=>({data:resp?.content??[], last_page:Math.max(1,resp?.totalPages??1)}),
    });
    mainTable.on("tableBuilt",()=>requestAnimationFrame(()=>mainTable.redraw(true)));
    window.addEventListener('resize',()=>mainTable.redraw(true));

    document.querySelectorAll('.btn-type .btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.btn-type .btn').forEach(b=>{b.classList.remove('btn-primary');b.classList.add('btn-outline-primary');});
        btn.classList.remove('btn-outline-primary'); btn.classList.add('btn-primary');
        currentType = btn.getAttribute('data-type')||'ALL';
        mainTable.setPage(1); mainTable.replaceData();
      });
    });
    document.getElementById('btn-search').addEventListener('click',()=>{mainTable.setPage(1); mainTable.replaceData();});
    document.getElementById('btn-reset').addEventListener('click',()=>{
      ['partnerName','voucherNo','fromDate','toDate'].forEach(id=>document.getElementById(id).value='');
      currentType='ALL'; 
      document.querySelectorAll('.btn-type .btn').forEach(b=>{
        b.classList.remove('btn-primary');b.classList.add('btn-outline-primary'); 
        if(b.dataset.type==='ALL'){b.classList.remove('btn-outline-primary');b.classList.add('btn-primary');}
      });
      mainTable.setPage(1); mainTable.replaceData();
    });

    /* ---------- ì¸ì‡„/ì—‘ì…€ ---------- */
    const TYPE_LABEL={SALES:"ì™¸ìƒë§¤ì¶œê¸ˆ",BUY:"ì œí’ˆë§¤ì¶œ",MONEY:"ë¶€ê°€ì„¸ì˜ˆìˆ˜ê¸ˆ",PAYMENT:"ì§€ê¸‰"};
    const isDebit = t => t==="BUY"||t==="PAYMENT";
    function buildVoucherHTML(row){
      const now=new Date(), today=now.toISOString().slice(0,10), time=now.toTimeString().slice(0,8);
      const typeKo=TYPE_LABEL[row.type]??(row.type??"");
      const debit=isDebit(row.type)?Number(row.amountTotal||0):0;
      const credit=isDebit(row.type)?0:Number(row.amountTotal||0);
      return `
      <section class="voucher">
        <div class="v-head" style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
          <div class="title" style="font-size:28px;font-weight:700;letter-spacing:6px;padding:10px 6px">ì „ í‘œ</div>
          <table class="approve" style="border-collapse:collapse;width:280px">
            <tr><th class="stamp" rowspan="2" style="border:1px solid #333;width:46px">ê²°ì¬</th><th style="border:1px solid #333">ë‹´ë‹¹</th><th style="border:1px solid #333">ëŒ€ë¦¬</th><th style="border:1px solid #333">ê³¼ì¥</th></tr>
            <tr><td style="border:1px solid #333;height:60px"></td><td style="border:1px solid #333"></td><td style="border:1px solid #333"></td></tr>
          </table>
        </div>
        <table class="meta" style="width:100%;border-collapse:collapse;margin:6px 0 10px">
          <tr><td>íšŒì‚¬ëª… : (ì£¼)êµ¬ë…í•‘ ì´ì•Œí•‘</td><td style="text-align:right">ì‘ì„±ì : SYSTEM</td><td style="text-align:right">ì „í‘œë²ˆí˜¸ : ${row.voucherNo??""}</td></tr>
          <tr><td>ê±°ë˜ì²˜ : ${row.partnerName??""}</td><td style="text-align:right" colspan="2">ì „í‘œì¼ì : ${row.voucherDate?String(row.voucherDate).slice(0,10):""}</td></tr>
        </table>
        <table class="lines" style="width:100%;border-collapse:collapse;table-layout:fixed">
          <thead><tr><th style="border:1px solid #777;padding:8px 10px;background:#f2f2f5;width:28%">ê³„ì •ëª…</th><th style="border:1px solid #777;padding:8px 10px;background:#f2f2f5;width:34%">ì ìš”</th><th style="border:1px solid #777;padding:8px 10px;background:#f2f2f5;width:19%">ì°¨ë³€</th><th style="border:1px solid #777;padding:8px 10px;background:#f2f2f5;width:19%">ëŒ€ë³€</th></tr></thead>
          <tbody><tr><td style="border:1px solid #777;padding:8px 10px;text-align:center">${typeKo}</td><td style="border:1px solid #777;padding:8px 10px;text-align:center">${row.remark??""}</td><td style="border:1px solid #777;padding:8px 10px;text-align:right">${fmt(debit)}</td><td style="border:1px solid #777;padding:8px 10px;text-align:right">${fmt(credit)}</td></tr><tr><td colspan="4" style="height:180px"></td></tr></tbody>
          <tfoot><tr><th style="border:1px solid #777;padding:8px 10px;text-align:left" colspan="2">í•©ê³„ &nbsp;&nbsp; ë§¤ì¶œ/ë§¤ì… : ${row.partnerName??""}</th><th style="border:1px solid #777;padding:8px 10px;text-align:right">${fmt(debit)}</th><th style="border:1px solid #777;padding:8px 10px;text-align:right">${fmt(credit)}</th></tr></tfoot>
        </table>
        <div class="foot" style="display:flex;justify-content:space-between;font-size:12px;margin-top:8px;color:#444"><span>[ 1 / 1 ]</span><span>${today} ${time}</span></div>
      </section>
      <div class="page-break" style="page-break-after:always;height:24px"></div>`;
    }
    document.getElementById('btn-print').addEventListener('click',()=>{
      const rows=mainTable.getSelectedRows(); if(!rows.length) return toast('ì¸ì‡„í•  í–‰ì„ ì„ íƒí•˜ì„¸ìš”.');
      const html=rows.map(r=>buildVoucherHTML(r.getData())).join("");
      const w=window.open('','_blank','width=1200,height=900');
      w.document.write(`<!doctype html><html><head><title>ì „í‘œ ì¸ì‡„</title><style>*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",Arial,sans-serif}body{margin:16px}</style></head><body>${html}</body></html>`); 
      w.document.close(); w.focus(); w.print();
    });
    document.getElementById('btn-export').addEventListener('click',()=>{
      const rows=mainTable.getSelectedRows(); if(!rows.length) return toast('ë‚´ë³´ë‚¼ í–‰ì„ ì„ íƒí•˜ì„¸ìš”.');
      const map={SALES:"ë§¤ì¶œ",BUY:"ë§¤ì…",MONEY:"ìˆ˜ê¸ˆ",PAYMENT:"ì§€ê¸‰"};
      const data=rows.map(r=>{const d=r.getData();return{ì „í‘œì¼ì:d.voucherDate?new Date(d.voucherDate).toISOString().slice(0,10):'',ì „í‘œë²ˆí˜¸:d.voucherNo??'',ìœ í˜•:map[d.type]??(d.type??''),ê±°ë˜ì²˜ëª…:d.partnerName??'',ì´ì•¡:Number(d.amountTotal||0),ì ìš”:d.remark??''}});
      const wb=XLSX.utils.book_new(), ws=XLSX.utils.json_to_sheet(data); 
      XLSX.utils.book_append_sheet(wb,ws,"ì„ íƒì „í‘œ");
      const today=new Date().toISOString().slice(0,10).replaceAll('-',''); 
      XLSX.writeFile(wb,`statements_selected_${today}.xlsx`);
    });

    /* ---------- ê³µí†µ ëª¨ë‹¬(ê²€ìƒ‰) ë²„íŠ¼ ---------- */
    document.getElementById('btn-find-partner').addEventListener('click',()=>{
      openModal('partner',(row)=>{document.getElementById('partnerName').value=row.partnerName??''; mainTable.setPage(1); mainTable.replaceData();});
    });
    document.getElementById('btn-find-voucher').addEventListener('click',()=>{
      openModal('voucher',(row)=>{document.getElementById('voucherNo').value=row.voucherNo??''; mainTable.setPage(1); mainTable.replaceData();});
    });

    /* ---------- ì „í‘œ ë“±ë¡ ëª¨ë‹¬(ì €ì¥ ì—°ë™) ---------- */
    const vfEl    = document.getElementById('voucherFormModal');
    const vfModal = (window.bootstrap?.Modal && vfEl) ? new bootstrap.Modal(vfEl) : null;
    let currentVoucherType = 'SALES'; // ëª¨ë‹¬ ì˜¤í”ˆí•œ ë²„íŠ¼ íƒ€ì… ê¸°ì–µ

    // ë²„íŠ¼ í´ë¦­ìœ¼ë¡œ ëª¨ë‹¬ ì—´ê¸°
    document.querySelectorAll('.open-voucher-form').forEach(btn=>{
      btn.addEventListener('click',()=>{
        currentVoucherType = btn.dataset.type === 'BUY' ? 'BUY' : 'SALES';
        openVoucherForm(currentVoucherType);
      });
    });

    function openVoucherForm(type){
      if(!vfModal){ toast('ë¶€íŠ¸ìŠ¤íŠ¸ë© ëª¨ë‹¬ ìŠ¤í¬ë¦½íŠ¸ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); return; }

      document.getElementById('vf-title').textContent = (type==='BUY' ? 'ë§¤ì…ì „í‘œ ë“±ë¡' : 'ë§¤ì¶œì „í‘œ ë“±ë¡');

      const today = new Date().toISOString().slice(0,10);
      document.getElementById('vf-voucherDate').value = today;
      document.getElementById('vf-saleDate').value    = today;
      document.getElementById('vf-writeDate').value   = today;

      const yyyy = today.slice(0,4);
      const seq  = String(Math.floor(Math.random()*9000)+1000);
      document.getElementById('vf-voucherNo').value = `${yyyy}-${seq}`;

      ['vf-saleCode','vf-partnerName','vf-empName','vf-remark'].forEach(id=>document.getElementById(id).value='');
      document.getElementById('vf-taxType').value = 'TAXABLE';
      setAmounts(0, 'TAXABLE');

      // ë°ëª¨(ë‹ë³´ê¸°)
      document.getElementById('vf-find-saleCode').onclick = ()=>toast('íŒë§¤ì½”ë“œ ëª¨ë‹¬ ì—°ê²° ì˜ˆì •(ë°ëª¨)');
      document.getElementById('vf-find-partner').onclick  = ()=>toast('ê±°ë˜ì²˜ ëª¨ë‹¬ ì—°ê²° ì˜ˆì •(ë°ëª¨)');
      document.getElementById('vf-find-emp').onclick      = ()=>toast('ë‹´ë‹¹ì ëª¨ë‹¬ ì—°ê²° ì˜ˆì •(ë°ëª¨)');

      vfModal.show();
    }

    // ê¸ˆì•¡ ê³„ì‚°
    const $supply = document.getElementById('vf-supply');
    const $vat    = document.getElementById('vf-vat');
    const $total  = document.getElementById('vf-total');
    const $taxSel = document.getElementById('vf-taxType');

    function setAmounts(supply, taxType){
      const rate = (taxType==='TAXABLE') ? 0.1 : 0.0;
      const vat  = Math.round(supply * rate);
      const tot  = supply + vat;
      $supply.value = fmt(supply);
      $vat.value    = fmt(vat);
      $total.value  = fmt(tot);
    }
    $supply.addEventListener('input', ()=> setAmounts(unfmt($supply.value), $taxSel.value));
    $supply.addEventListener('blur',  ()=> setAmounts(unfmt($supply.value), $taxSel.value));
    $taxSel.addEventListener('change',()=> setAmounts(unfmt($supply.value), $taxSel.value));

 // ì €ì¥(ì‹¤ì œ í˜¸ì¶œ)
    document.getElementById('vf-save').addEventListener('click', async () => {
  const type = document.getElementById('vf-title').textContent.includes('ë§¤ì…') ? 'BUY' : 'SALES';

  const body = (type === 'BUY')
    ? {
        voucherDate: document.getElementById('vf-voucherDate').value || null,
        buyCode: document.getElementById('vf-saleCode').value || null,
        partnerName: document.getElementById('vf-partnerName').value || null,
        employee: document.getElementById('vf-empName').value || null,
        taxCode: document.getElementById('vf-taxType').value || 'TAXABLE',
        amountSupply: unfmt(document.getElementById('vf-supply').value),
        amountVat:    unfmt(document.getElementById('vf-vat').value),
        amountTotal:  unfmt(document.getElementById('vf-total').value),
        remark: document.getElementById('vf-remark').value || null,
      }
    : {
        voucherDate: document.getElementById('vf-voucherDate').value || null,
        salesCode: document.getElementById('vf-saleCode').value || null,
        partnerName: document.getElementById('vf-partnerName').value || null,
        employee: document.getElementById('vf-empName').value || null,
        taxCode: document.getElementById('vf-taxType').value || 'TAXABLE',
        amountSupply: unfmt(document.getElementById('vf-supply').value),
        amountVat:    unfmt(document.getElementById('vf-vat').value),
        amountTotal:  unfmt(document.getElementById('vf-total').value),
        remark: document.getElementById('vf-remark').value || null,
      };

  const url = (type === 'BUY') ? '/api/statements/buy' : '/api/statements/sales';

  const token  = document.querySelector('meta[name="_csrf"]')?.content;
  const header = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';

  try {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', ...(token ? { [header]: token } : {}) },
      body: JSON.stringify(body),
    });
    if (!res.ok) throw new Error(await res.text() || 'save failed');

    const { voucherNo } = await res.json();
    // ëª¨ë‹¬ ì „í‘œë²ˆí˜¸ ì¦‰ì‹œ ê°±ì‹  (ì„œë²„ ë°œë²ˆê°’)
    document.getElementById('vf-voucherNo').value = voucherNo;

    toast(`ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤: ${voucherNo}`);
    vfModal?.hide();
    mainTable.setPage(1);
    mainTable.replaceData();
  } catch (e) {
    console.error(e); toast('ì €ì¥ ì‹¤íŒ¨: ' + (e.message || ''));
  }
    });
  });
</script>

</body>
</html>
