<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/main}">
<head>
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<meta charset="UTF-8" />
<title>일반전표 등록</title>
<style>
.fixed-wrap {
	width: 100%;
	max-width: 1600px;
	margin: 0 auto;
	padding: 0 8px 8px;
}

.toolbar {
	display: flex;
	align-items: center;
	justify-content: space-between;
	gap: 8px;
	margin: 6px 0 10px;
}

.vf-box {
	background: #f4f5f7;
	border-radius: 10px;
	padding: 12px 14px 14px;
	border: 1px solid #ddd;
}

.vf-label {
	font-weight: 600
}

.vf-hr {
	border-top: 1px dashed #d7d7d7;
	margin: 10px 0 10px
}

.vf-num {
	text-align: right
}

.vf-loading {
	opacity: .6
}

.toast-min {
	position: fixed;
	right: 24px;
	bottom: 24px;
	background: #333;
	color: #fff;
	padding: 10px 14px;
	border-radius: 8px;
	opacity: .95;
	z-index: 2000
}

.form-label {
	margin-bottom: .25rem;
}

.row.g-2>[class^="col"] {
	margin-bottom: .4rem;
}

.gx-tight {
	--bs-gutter-x: .9rem;
}

.form-control, .form-select, .btn {
	height: 36px;
	padding: .35rem .6rem;
	font-size: .95rem;
	border-width: 1.5px;
}

.input-group .btn {
	height: 36px;
}

#vf-voucherNo[readonly] {
	background: #fff;
}

.toolbar .btn {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	height: 34px;
	padding: 0 .75rem;
	font-size: .92rem;
}
/* 인풋 내부 아이콘 버튼 */
.input-with-icon {
	position: relative;
	display: inline-block;
	width: 100%;
}

.input-with-icon .form-control {
	padding-right: 40px;
	width: 100%;
}

.input-with-icon .icon-btn {
	position: absolute;
	right: 6px;
	top: 50%;
	transform: translateY(-50%);
	border: 0;
	background: transparent;
	padding: 0;
	margin: 0;
	width: 28px;
	height: 28px;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	cursor: pointer;
	border-radius: 6px;
	z-index: 2;
}

.input-with-icon .icon-btn:focus {
	outline: 2px solid #86b7fe;
	outline-offset: 2px;
}

.input-with-icon .icon-btn .fa-solid {
	font-size: 16px;
	color: #6c757d;
}

.input-with-icon .icon-btn:hover .fa-solid {
	color: #333;
}
</style>
</head>

<body layout:fragment="content">
	<div id="layoutSidenav_content">
		<main>
			<div class="fixed-wrap">
				<!-- ===== 상단 툴바 ===== -->
				<div class="toolbar">
					<h1 class="mb-0">일반전표 등록</h1>
					<div class="d-flex gap-2">
						<a class="btn btn-outline-secondary" th:href="@{/statements}">목록</a>
						<button id="btn-reset" type="button"
							class="btn btn-outline-secondary">초기화</button>
						<button id="vf-save" type="button" class="btn btn-primary">저장</button>
					</div>
				</div>

				<!-- ===== 본문 ===== -->
				<div class="vf-box">
					<div class="row gx-tight g-2 mb-2">
						<div class="col-lg-6">
							<label class="form-label vf-label">전표유형</label> <select
								id="vf-type" class="form-select"></select>
						</div>
					</div>

					<!-- 상단 폼: 한 줄 2개 -->
					<div class="row gx-tight g-2">
						<div class="col-lg-6">
							<label class="form-label vf-label" id="lbl-voucherDate">전표일자</label>
							<input id="vf-voucherDate" type="date" class="form-control">
						</div>
						<div class="col-lg-6">
							<label class="form-label vf-label">전표번호</label> <input
								id="vf-voucherNo" type="text" class="form-control"
								placeholder="자동발번" readonly> <input id="vf-resvId"
								type="hidden">
						</div>

						<div class="col-lg-6">
							<label class="form-label vf-label" id="lbl-saleDate">판매일자</label>
							<input id="vf-saleDate" type="date" class="form-control">
						</div>
						<div class="col-lg-6">
							<label class="form-label vf-label">담당자</label> <input
								id="vf-empName" type="text" class="form-control" readonly>
						</div>

						<div class="col-lg-6">
							<label class="form-label vf-label" id="lbl-saleCode">판매코드</label>
							<div class="input-with-icon">
								<input id="vf-saleCode" type="text" class="form-control"
									placeholder="">
								<button id="vf-find-saleCode" class="icon-btn" type="button"
									aria-label="판매/구매코드 찾기">
									<i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
								</button>
							</div>
						</div>
						<div class="col-lg-6">
							<label class="form-label vf-label">거래처</label>
							<div class="input-with-icon">
								<input id="vf-partnerName" type="text" class="form-control"
									placeholder="">
								<button id="vf-find-partner" class="icon-btn" type="button"
									aria-label="거래처 찾기">
									<i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
								</button>
							</div>
						</div>

					</div>

					<div class="vf-hr"></div>

					<!-- 하단 폼 -->
					<div class="row gx-tight g-2">
						<div class="col-12">
							<label class="form-label vf-label">부가세유형</label> <select
								id="vf-taxType" class="form-select">
								<option value="TAXABLE">과세(10%)</option>
								<option value="ZERO">영세(0%)</option>
								<option value="EXEMPT">면세(0%)</option>
							</select>
						</div>
						<div class="col-12">
							<label class="form-label vf-label">공급가액</label> <input
								id="vf-supply" type="text" class="form-control vf-num" value="0">
						</div>
						<div class="col-12">
							<label class="form-label vf-label">부가세</label> <input id="vf-vat"
								type="text" class="form-control vf-num" value="0" readonly>
						</div>
						<div class="col-12">
							<label class="form-label vf-label">총 금액</label> <input
								id="vf-total" type="text" class="form-control vf-num" value="0">
						</div>
						<div class="col-12">
							<label class="form-label vf-label">적요</label> <input
								id="vf-remark" type="text" class="form-control" placeholder="">
						</div>
					</div>
				</div>
			</div>
		</main>
	</div>

	<!-- 공통 모달(fragment) + 공통 스크립트 -->
	<div th:replace="~{common/modal :: commonModal}"></div>
	<script th:src="@{/main/js/modal.js}" defer></script>

	<script>
  window.addEventListener('DOMContentLoaded', () => {
    const toast=(m,ms=1600)=>{const t=document.createElement('div');t.className='toast-min';t.textContent=m;document.body.appendChild(t);setTimeout(()=>t.remove(),ms);};
    const fmt=n=>Number(n||0).toLocaleString();
    const unfmt=s=>Number(String(s||'').replace(/[^\d.-]/g,''))||0;

    // ===== 세액 계산 =====
    const FRACTION={TAXABLE:{num:10,den:100},ZERO:{num:0,den:100},EXEMPT:{num:0,den:100}};
    const norm=t=>{const x=String(t||'').toUpperCase();return (x in FRACTION)?x:'TAXABLE';};
    const fromSupply=(s,t)=>{const {num,den}=FRACTION[norm(t)]; if(num===0) return {supply:s,vat:0,total:s}; const v=Math.round(s*num/den); return {supply:s,vat:v,total:s+v};};
    const fromTotal =(tot,t)=>{const {num,den}=FRACTION[norm(t)]; if(num===0) return {supply:tot,vat:0,total:tot}; const v=Math.round(tot*num/den); return {supply:tot-v,vat:v,total:tot};};

    // ===== type 표준화(백엔드 풀네임으로 통일) =====
    function normalizeLongType(t){
      const x = String(t||'').toUpperCase();
      if (['SALES','BUY','MONEY','PAYMENT'].includes(x)) return x;
      // 혹시 축약형이 들어오면 풀네임으로 보정
      if (x==='SAL') return 'SALES';
      if (x==='MNY') return 'MONEY';
      if (x==='PMT') return 'PAYMENT';
      return 'SALES';
    }

    // 누적감소 방지용 guard
    const lastCalc={mode:'TOTAL',supply:0,vat:0,total:0,taxType:'TAXABLE',prevSupply:0,prevTotal:0};

    let currentUserName='';
    fetch('/api/me',{credentials:'same-origin'}).then(r=>r.ok?r.json():{}).then(j=>{
      currentUserName=j?.name||''; const $e=document.getElementById('vf-empName'); if($e) $e.value=currentUserName;
    }).catch(()=>{});

    const $type=document.getElementById('vf-type');
    const typeFallback=[{code:'SALES',name:'매출'},{code:'BUY',name:'매입'},{code:'MONEY',name:'수금'},{code:'PAYMENT',name:'지급'}];
    async function initVoucherTypes(){
      let ok=false;
      try{
        const r=await fetch('/api/codes?group=VOUCHER_TYPE',{headers:{'Accept':'application/json'},credentials:'same-origin'});
        if(r.ok){
          const text=await r.text(); const list=text?JSON.parse(text):[]; const items=Array.isArray(list)?list:(list.content||[]);
          if(items.length){
            $type.innerHTML=items.map(it=>`<option value="${it.code||it.value}">${it.name||it.label||it.text}</option>`).join('');
            ok=true;
          }
        }
      }catch(_){}
      if(!ok){ $type.innerHTML=typeFallback.map(it=>`<option value="${it.code}">${it.name}</option>`).join(''); }
      if(!$type.value) $type.value='SALES';
    }

    const labelsByType={
      SALES:{saleCode:'판매코드',saleDate:'판매일자',partnerModal:'partner', saveUrl:'/api/statements/sales'},
      BUY:{saleCode:'구매코드',saleDate:'구매일자',partnerModal:'supplier', saveUrl:'/api/statements/buy'},
      MONEY:{saleCode:'수금코드',saleDate:'수금일자',partnerModal:'partner', saveUrl:'/api/statements/money'},
      PAYMENT:{saleCode:'지급코드',saleDate:'지급일자',partnerModal:'supplier', saveUrl:'/api/statements/payment'},
    };
    function applyTypeLabels(t){
      const m=labelsByType[normalizeLongType(t)]||labelsByType.SALES;
      const setTxt = (id, txt)=>{const el=document.getElementById(id); if(el) el.textContent=txt;};
      setTxt('lbl-saleCode', m.saleCode);
      setTxt('lbl-saleDate', m.saleDate);
      setTxt('lbl-voucherDate','전표일자');
    }

    // ===== 전표번호 프리뷰/예약 (풀네임 사용) =====
    let _vnoInFlight=false;
    async function fetchPreviewVoucherNo(type,dateStr){
      const $vno=document.getElementById('vf-voucherNo'); const $resv=document.getElementById('vf-resvId');
      if(!$vno || _vnoInFlight) return; _vnoInFlight=true;
      try{
        const kind = normalizeLongType(type);
        $vno.classList.add('vf-loading'); $vno.value='전표번호 확인중...'; if($resv) $resv.value='';
        const qs = new URLSearchParams({ type: kind, ...(dateStr ? { date: dateStr } : {}) });
        const res=await fetch(`/api/vouchers/preview?${qs.toString()}`,{
          method:'GET', credentials:'same-origin', headers:{'Accept':'application/json'}
        });
        const text=await res.text();
        if(!res.ok) throw new Error(text||'preview failed');
        const j=text?JSON.parse(text):{};
        $vno.value=j?.voucherNo || '자동발번';
      }catch(e){ $vno.value='자동발번'; }
      finally{ $vno.classList.remove('vf-loading'); _vnoInFlight=false; }
    }

    async function reserveVoucher(type,dateStr){
      const kind = normalizeLongType(type);
      const qs = new URLSearchParams({ type: kind, ...(dateStr ? { date: dateStr } : {}) });
      const res=await fetch(`/api/vouchers/reserve?${qs.toString()}`,{
        method:'GET', credentials:'same-origin', headers:{'Accept':'application/json'}
      });
      const text=await res.text();
      if(!res.ok) throw new Error(text||'reserve failed');
      const j=text?JSON.parse(text):{};
      if(!j.reservationId||!j.voucherNo) throw new Error('예약 실패(필드누락)');
      return j;
    }

    // ===== 금액 필드 바인딩 =====
    function bindNumericFields(){
      const $taxSel=document.getElementById('vf-taxType');
      const $supply=document.getElementById('vf-supply');
      const $vat=document.getElementById('vf-vat');
      const $total=document.getElementById('vf-total');

      const sync=p=>{
        lastCalc.supply=p.supply; lastCalc.vat=p.vat; lastCalc.total=p.total; lastCalc.taxType=$taxSel.value;
        $supply.value=fmt(p.supply); $vat.value=fmt(p.vat); $total.value=fmt(p.total);
      };

      const init = fromTotal(0, $taxSel.value);
      sync(init);
      lastCalc.mode='TOTAL';
      lastCalc.prevSupply = lastCalc.supply;
      lastCalc.prevTotal  = lastCalc.total;

      $supply.addEventListener('input',()=>{
        const val = unfmt($supply.value);
        lastCalc.mode='SUPPLY';
        sync(fromSupply(val,$taxSel.value));
      });

      $total.addEventListener('input',()=>{
        const val = unfmt($total.value);
        lastCalc.mode='TOTAL';
        sync(fromTotal(val,$taxSel.value));
      });

      $supply.addEventListener('blur', ()=>{
        const val = unfmt($supply.value);
        if (val !== lastCalc.prevSupply) {
          lastCalc.mode='SUPPLY';
          const p = fromSupply(val,$taxSel.value);
          sync(p);
          lastCalc.prevSupply = p.supply;
          lastCalc.prevTotal  = p.total;
        } else {
          $supply.value = fmt(lastCalc.prevSupply);
          $vat.value    = fmt(lastCalc.vat);
          $total.value  = fmt(lastCalc.prevTotal);
        }
      });

      $total.addEventListener('blur', ()=>{
        const val = unfmt($total.value);
        if (val !== lastCalc.prevTotal) {
          lastCalc.mode='TOTAL';
          const p = fromTotal(val,$taxSel.value);
          sync(p);
          lastCalc.prevSupply = p.supply;
          lastCalc.prevTotal  = p.total;
        } else {
          $total.value  = fmt(lastCalc.prevTotal);
          $vat.value    = fmt(lastCalc.vat);
          $supply.value = fmt(lastCalc.prevSupply);
        }
      });

      $taxSel.addEventListener('change',()=>{
        const p = (lastCalc.mode==='TOTAL')
          ? fromTotal(lastCalc.total,$taxSel.value)
          : fromSupply(lastCalc.supply,$taxSel.value);
        sync(p);
        lastCalc.prevSupply = p.supply;
        lastCalc.prevTotal  = p.total;
      });
    }

    // ===== 선택 모달 =====
    const $partnerName   =document.getElementById('vf-partnerName');
    const $saleCode      =document.getElementById('vf-saleCode');
    const $saleDate      =document.getElementById('vf-saleDate');

    function openPartnerPicker(){
      if (typeof openModal !== 'function'){ toast('검색 모달 스크립트를 찾을 수 없습니다.'); return; }
      const t = normalizeLongType($type.value||'SALES');
      const modalType = (t==='BUY'||t==='PAYMENT') ? 'supplier' : 'partner';
      openModal(modalType, (row)=>{
        $partnerName.value =
          row?.partnerName || row?.supplierName || row?.customerName || row?.clientName ||
          row?.buyerName || row?.correspondent || row?.PARTNER_NAME || '';
      });
    }

    // (간이) 인보이스 피커
    async function fallbackInvoicePicker(cb){
      try{
        const q = prompt('청구서 검색어(코드/거래처) 입력 (STATUS=회계반영완료만 조회됨):','');
        const params=new URLSearchParams({status:'회계반영완료', ...(q?{q}:{})});
        const res = await fetch(`/api/invoices/lookup?`+params.toString(), {headers:{'Accept':'application/json'},credentials:'same-origin'});
        if(!res.ok) throw new Error(await res.text());
        const list = await res.json();
        if(!Array.isArray(list) || list.length===0){ toast('결과가 없습니다'); return; }
        const lines = list.map((r,i)=>`${i+1}. ${r.invoiceCode} | ${r.partnerName??''} | ${r.dmndAmt?.toLocaleString?.()||''} | ${r.status} | ${String(r.createDate||'').slice(0,10)}`).join('\n');
        const pick = prompt('번호를 입력하세요:\n'+lines, '1');
        const idx = (Number(pick)||1)-1;
        if(list[idx]) cb(list[idx]);
      }catch(e){ toast('조회 실패: '+(e.message||'오류')); }
    }

    function openCodePicker(){
      const t = normalizeLongType($type.value||'SALES');

      // ===== MONEY(수금) → 청구서 조회 =====
      if(t==='MONEY'){
        const onPick = (row) => {
          $saleCode.value = row?.invoiceCode || row?.invoice_unique_code || '';

          const pickedDate = row?.rcptDate || row?.dmndDate || row?.createDate;
          if (pickedDate){
            const d = new Date(pickedDate);
            $saleDate.value = isNaN(d) ? String(pickedDate).slice(0,10) : d.toISOString().slice(0,10);
          }

          const partner = row?.partnerName || row?.partner_name || row?.PARTNER_NAME || '';
          if (partner) $partnerName.value = partner;

          try {
            const amt = Number(row?.dmndAmt || 0); // 총액
            const $taxSel = document.getElementById('vf-taxType');
            if ($taxSel) $taxSel.value = 'TAXABLE';
            const calc = fromTotal(amt, 'TAXABLE');
            document.getElementById('vf-total' ).value = fmt(calc.total);
            document.getElementById('vf-vat'   ).value = fmt(calc.vat);
            document.getElementById('vf-supply').value = fmt(calc.supply);

            lastCalc.mode='TOTAL';
            lastCalc.total = calc.total;
            lastCalc.vat   = calc.vat;
            lastCalc.supply= calc.supply;
            lastCalc.taxType = 'TAXABLE';
            lastCalc.prevSupply = calc.supply;
            lastCalc.prevTotal  = calc.total;
          } catch (_) {}
        };

        if (typeof openModal === 'function'){
          openModal('acinvoice', onPick);
        }else{
          fallbackInvoicePicker(onPick);
        }
        return;
      }

      // ===== SALES / BUY / PAYMENT → 각 코드 조회 =====
      if (typeof openModal !== 'function'){ toast('검색 모달 스크립트를 찾을 수 없습니다.'); return; }
      const modalType = (t==='BUY'||t==='PAYMENT') ? 'buy' : 'sales';

      openModal(modalType, (row)=>{
        // 코드/거래처/날짜
        $saleCode.value = (t==='BUY'||t==='PAYMENT') ? (row?.buyCode??'') : (row?.salesCode??'');
        const pickedPartner =
          row?.partnerName || row?.supplierName || row?.correspondent || row?.customerName ||
          row?.partner || row?.clientName || row?.buyerName || row?.PARTNER_NAME || '';
        if (pickedPartner) $partnerName.value = pickedPartner;

        const pickedDate = (t==='BUY'||t==='PAYMENT') ? (row?.purchaseDate || row?.buyDate) : (row?.salesDate);
        if (pickedDate){
          const d = new Date(pickedDate);
          $saleDate.value = isNaN(d) ? String(pickedDate).slice(0,10) : d.toISOString().slice(0,10);
        }

        // 금액 자동계산
        try {
          let totalAmt =
            (t==='BUY'||t==='PAYMENT')
              ? (row?.amountTotal ?? row?.totalAmount ?? row?.buyTotal ?? 0)
              : (row?.salesAmount ?? row?.amountTotal ?? row?.totalAmount ?? 0);
          totalAmt = Number(totalAmt || 0);

          let tax = (row?.taxCode || row?.tax_type || '').toString().toUpperCase();
          if (!['TAXABLE','ZERO','EXEMPT'].includes(tax)) {
            const rate = Number(row?.taxRate ?? row?.vatRate ?? 10);
            tax = (rate === 0) ? 'ZERO' : 'TAXABLE';
          }

          const $taxSel = document.getElementById('vf-taxType');
          if ($taxSel) $taxSel.value = tax;

          const calc = fromTotal(totalAmt, tax);
          document.getElementById('vf-total' ).value = fmt(calc.total);
          document.getElementById('vf-vat'   ).value = fmt(calc.vat);
          document.getElementById('vf-supply').value = fmt(calc.supply);

          lastCalc.mode='TOTAL';
          lastCalc.total = calc.total;
          lastCalc.vat   = calc.vat;
          lastCalc.supply= calc.supply;
          lastCalc.taxType = tax;
          lastCalc.prevSupply = calc.supply;
          lastCalc.prevTotal  = calc.total;
        } catch(_) {}
      });
    }

    document.getElementById('vf-find-partner')?.addEventListener('click', openPartnerPicker);
    document.getElementById('vf-find-saleCode')?.addEventListener('click', openCodePicker);

    const setVal=(id,val)=>{const el=document.getElementById(id); if(el) el.value=val;};
    const todayStr=()=> new Date().toISOString().slice(0,10);
    function initDates(){
      const t=todayStr();
      setVal('vf-voucherDate', t);
      setVal('vf-saleDate',    t);
    }

    async function resetForm(){
      setVal('vf-saleCode',''); setVal('vf-partnerName','');
      setVal('vf-empName', (typeof currentUserName==='string'?currentUserName:'')); setVal('vf-remark','');
      setVal('vf-taxType','TAXABLE'); setVal('vf-resvId','');
      initDates();
      const p=fromTotal(0,'TAXABLE');
      setVal('vf-supply', fmt(p.supply)); setVal('vf-vat', fmt(p.vat)); setVal('vf-total', fmt(p.total));
      lastCalc.mode='TOTAL';
      lastCalc.supply=p.supply; lastCalc.vat=p.vat; lastCalc.total=p.total; lastCalc.taxType='TAXABLE';
      lastCalc.prevSupply=p.supply; lastCalc.prevTotal=p.total;

      await fetchPreviewVoucherNo($type.value, document.getElementById('vf-voucherDate').value);
    }
    document.getElementById('btn-reset')?.addEventListener('click', resetForm);

    // ===== 저장 =====
    document.getElementById('vf-save')?.addEventListener('click', async (e)=>{
      e?.preventDefault?.();
      const $btn=e.currentTarget; if($btn.disabled) return;
      const orig=$btn.textContent; $btn.disabled=true; $btn.textContent='저장 중...';

      const t=normalizeLongType($type.value||'SALES');
      const map=labelsByType[t]||labelsByType.SALES;
      const voucherDate=document.getElementById('vf-voucherDate').value||null;

      try{
        const {reservationId,voucherNo}=await reserveVoucher(t,voucherDate);
        setVal('vf-resvId', reservationId);
        if(voucherNo) setVal('vf-voucherNo', voucherNo);
      }catch(err){
        toast('예약 실패: '+(err.message||'')); $btn.disabled=false; $btn.textContent=orig; return;
      }

      const body={
        reservationId:document.getElementById('vf-resvId')?.value||null,
        voucherDate,
        partnerName:document.getElementById('vf-partnerName').value||null,
        employee:document.getElementById('vf-empName').value||null,
        taxCode:document.getElementById('vf-taxType').value||'TAXABLE',
        amountSupply:unfmt(document.getElementById('vf-supply').value),
        amountVat:unfmt(document.getElementById('vf-vat').value),
        amountTotal:unfmt(document.getElementById('vf-total').value),
        remark:document.getElementById('vf-remark').value||null,
      };
      if(t==='BUY'||t==='PAYMENT'){
        body.buyCode=document.getElementById('vf-saleCode').value||null;
      }else if(t==='MONEY'){
        const v=document.getElementById('vf-saleCode').value||null;
        body.invoiceCode=v; // 백엔드가 invoiceCode 기대
        body.moneyCode=v;   // 혹시 moneyCode 받도록 되어있으면 이것도
      }else{
        body.salesCode=document.getElementById('vf-saleCode').value||null;
      }

      const url=map.saveUrl;
      const csrfToken=document.querySelector('meta[name="_csrf"]')?.content;
      const csrfHeader=document.querySelector('meta[name="_csrf_header"]')?.content||'X-CSRF-TOKEN';
      const headers={'Content-Type':'application/json'};
      if (csrfToken) headers[csrfHeader]=csrfToken;

      try{
        const res=await fetch(url,{
          method:'POST',
          credentials:'same-origin',
          headers,
          body:JSON.stringify(body)
        });
        const text=await res.text();
        if(res.status===403) throw new Error('403 Forbidden - CSRF 토큰 누락/만료.');
        if(!res.ok) throw new Error(text||'save failed');
        const {voucherNo}=text?JSON.parse(text):{}; if(voucherNo) setVal('vf-voucherNo', voucherNo);
        toast(`저장되었습니다${voucherNo?`: ${voucherNo}`:''}`);
      }catch(e){ toast('저장 실패: '+(e.message||'')); }
      finally{ $btn.disabled=false; $btn.textContent=orig; }
    });

    // ===== 부트스트랩 =====
    (async function bootstrap(){
      await initVoucherTypes();
      initDates();
      applyTypeLabels($type.value);
      await fetchPreviewVoucherNo($type.value, document.getElementById('vf-voucherDate').value);
      bindNumericFields();

      // 전표유형 변경 시 전체 초기화 + 번호 미리보기
      $type.addEventListener('change', async ()=>{
        applyTypeLabels($type.value);
        await resetForm();
        await fetchPreviewVoucherNo($type.value, document.getElementById('vf-voucherDate').value);
      });

      document.getElementById('vf-voucherDate').addEventListener('change', ()=>
        fetchPreviewVoucherNo($type.value, document.getElementById('vf-voucherDate').value||'')
      );
    })();
  });
  </script>
</body>
</html>
