<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
  <meta charset="UTF-8" />
  <title>ì¼ë°˜ì „í‘œ ë“±ë¡</title>
  <style>
    /* ===== ë ˆì´ì•„ì›ƒ ===== */
    .fixed-wrap{ width:100%; max-width:1600px; margin:0 auto; padding:0 8px 8px; }
    .toolbar{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin:6px 0 10px; }
    .toolbar h1{ margin:0; font-weight:700; font-size:28px; }
    .vf-box{ background:#f4f5f7; border-radius:10px; padding:12px 14px 14px; border:1px solid #ddd; }
    .vf-label{font-weight:600}
    .vf-hr{border-top:1px dashed #d7d7d7;margin:10px 0 10px}
    .vf-num{text-align:right}
    .vf-loading{ opacity:.6 }

    .toast-min{position:fixed;right:24px;bottom:24px;background:#333;color:#fff;padding:10px 14px;border-radius:8px;opacity:.95;z-index:2000}

    .form-label{ margin-bottom:.25rem; }
    .row.g-2 > [class^="col"]{ margin-bottom:.4rem; }
    .gx-tight { --bs-gutter-x: .9rem; }

    /* ===== ì»´íŒ©íŠ¸ ì‚¬ì´ì¦ˆ(ì„¸ë¡œ ê³µê°„ ì ˆì•½) ===== */
    .form-control, .form-select, .btn { height: 36px; padding: .35rem .6rem; font-size: .95rem; border-width: 1.5px; }
    .input-group .btn{ height:36px; }
    #vf-voucherNo[readonly]{ background:#fff; }

    /* ìƒë‹¨ íˆ´ë°” ë²„íŠ¼ ìˆ˜ì§ ê°€ìš´ë° ì •ë ¬ */
    .toolbar .btn{ display:inline-flex; align-items:center; justify-content:center; height:34px; padding:0 .75rem; font-size:.92rem; }
  </style>
</head>

<body layout:fragment="content">
  <div id="layoutSidenav_content">
    <main>
      <div class="fixed-wrap">
        <!-- ===== ìƒë‹¨ íˆ´ë°” ===== -->
        <div class="toolbar">
          <h1 class="mb-0">ì¼ë°˜ì „í‘œ ë“±ë¡</h1>
          <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" th:href="@{/statements}">ëª©ë¡</a>
            <button id="btn-reset" type="button" class="btn btn-outline-secondary">ì´ˆê¸°í™”</button>
            <button id="vf-save" type="button" class="btn btn-primary">ì €ì¥</button>
          </div>
        </div>

        <!-- ===== ë³¸ë¬¸ ===== -->
        <div class="vf-box">
          <div class="row gx-tight g-2 mb-2">
            <div class="col-lg-6">
              <label class="form-label vf-label">ì „í‘œìœ í˜•</label>
              <select id="vf-type" class="form-select"></select>
            </div>
          </div>

          <!-- ìƒë‹¨ í¼: í•œ ì¤„ 2ê°œ -->
          <div class="row gx-tight g-2">
            <div class="col-lg-6">
              <label class="form-label vf-label" id="lbl-voucherDate">ì „í‘œì¼ì</label>
              <input id="vf-voucherDate" type="date" class="form-control">
            </div>
            <div class="col-lg-6">
              <label class="form-label vf-label">ì „í‘œë²ˆí˜¸</label>
              <input id="vf-voucherNo" type="text" class="form-control" placeholder="ìë™ë°œë²ˆ" readonly>
              <input id="vf-resvId" type="hidden">
            </div>

            <div class="col-lg-6">
              <label class="form-label vf-label" id="lbl-saleDate">íŒë§¤ì¼ì</label>
              <input id="vf-saleDate" type="date" class="form-control">
            </div>
            <div class="col-lg-6">
              <label class="form-label vf-label">ë‹´ë‹¹ì</label>
              <input id="vf-empName" type="text" class="form-control" readonly>
            </div>

            <div class="col-lg-6">
              <label class="form-label vf-label" id="lbl-saleCode">íŒë§¤ì½”ë“œ</label>
              <div class="input-group">
                <input id="vf-saleCode" type="text" class="form-control" placeholder="">
                <button id="vf-find-saleCode" class="btn btn-outline-secondary" type="button">ğŸ”</button>
              </div>
            </div>
            <div class="col-lg-6">
              <label class="form-label vf-label">ê±°ë˜ì²˜</label>
              <div class="input-group">
                <input id="vf-partnerName" type="text" class="form-control" placeholder="">
                <button id="vf-find-partner" class="btn btn-outline-secondary" type="button">ğŸ”</button>
              </div>
            </div>
          </div>

          <div class="vf-hr"></div>

          <!-- í•˜ë‹¨ í¼: ìš”ì²­ëŒ€ë¡œ ê° í•­ëª©ì„ í•œ ì¤„ì”© -->
          <div class="row gx-tight g-2">
            <div class="col-12">
              <label class="form-label vf-label">ë¶€ê°€ì„¸ìœ í˜•</label>
              <select id="vf-taxType" class="form-select">
                <option value="TAXABLE">ê³¼ì„¸(10%)</option>
                <option value="ZERO">ì˜ì„¸(0%)</option>
                <option value="EXEMPT">ë©´ì„¸(0%)</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label vf-label">ê³µê¸‰ê°€ì•¡</label>
              <input id="vf-supply" type="text" class="form-control vf-num" value="0">
            </div>
            <div class="col-12">
              <label class="form-label vf-label">ë¶€ê°€ì„¸</label>
              <input id="vf-vat" type="text" class="form-control vf-num" value="0" readonly>
            </div>
            <div class="col-12">
              <label class="form-label vf-label">ì´ ê¸ˆì•¡</label>
              <input id="vf-total" type="text" class="form-control vf-num" value="0">
            </div>
            <div class="col-12">
              <label class="form-label vf-label">ì ìš”</label>
              <input id="vf-remark" type="text" class="form-control" placeholder="">
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- ê³µí†µ ëª¨ë‹¬(fragment) + ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ -->
  <div th:replace="~{common/modal :: commonModal}"></div>
  <script th:src="@{/main/js/modal.js}" defer></script>

  <script>
  /* ===== ìŠ¤í¬ë¦½íŠ¸ ===== */
  window.addEventListener('DOMContentLoaded', () => {
    const toast=(m,ms=1600)=>{const t=document.createElement('div');t.className='toast-min';t.textContent=m;document.body.appendChild(t);setTimeout(()=>t.remove(),ms);};
    const fmt=n=>Number(n||0).toLocaleString();
    const unfmt=s=>Number(String(s||'').replace(/[^\d.-]/g,''))||0;

    const FRACTION={TAXABLE:{num:10,den:100},ZERO:{num:0,den:100},EXEMPT:{num:0,den:100}};
    const norm=t=>{const x=String(t||'').toUpperCase();return (x in FRACTION)?x:'TAXABLE';};
    const fromSupply=(s,t)=>{const {num,den}=FRACTION[norm(t)]; if(num===0) return {supply:s,vat:0,total:s}; const v=Math.round(s*num/den); return {supply:s,vat:v,total:s+v};};
    const fromTotal =(tot,t)=>{const {num,den}=FRACTION[norm(t)]; if(num===0) return {supply:tot,vat:0,total:tot}; const v=Math.round(tot*num/den); return {supply:tot-v,vat:v,total:tot};};
    const lastCalc={mode:'TOTAL',supply:0,vat:0,total:0,taxType:'TAXABLE'};

    let currentUserName='';
    fetch('/api/me',{credentials:'same-origin'}).then(r=>r.ok?r.json():{}).then(j=>{
      currentUserName=j?.name||''; const $e=document.getElementById('vf-empName'); if($e) $e.value=currentUserName;
    }).catch(()=>{});

    const $type=document.getElementById('vf-type');
    const typeFallback=[{code:'SALES',name:'ë§¤ì¶œ'},{code:'BUY',name:'ë§¤ì…'},{code:'MONEY',name:'ìˆ˜ê¸ˆ'},{code:'PAYMENT',name:'ì§€ê¸‰'}];
    async function initVoucherTypes(){
      let ok=false;
      try{
        const r=await fetch('/api/codes?group=VOUCHER_TYPE',{headers:{'Accept':'application/json'}});
        if(r.ok){
          const text=await r.text(); const list=text?JSON.parse(text):[]; const items=Array.isArray(list)?list:(list.content||[]);
          if(items.length){
            $type.innerHTML=items.map(it=>`<option value="${it.code||it.value}">${it.name||it.label||it.text}</option>`).join('');
            ok=true;
          }
        }
      }catch(_){}
      if(!ok){ $type.innerHTML=typeFallback.map(it=>`<option value="${it.code}">${it.name}</option>`).join(''); }
      if(!$type.value) $type.value='SALES';
    }

    const labelsByType={
      SALES:{saleCode:'íŒë§¤ì½”ë“œ',saleDate:'íŒë§¤ì¼ì',partnerModal:'partner', saveUrl:'/api/statements/sales'},
      BUY:{saleCode:'êµ¬ë§¤ì½”ë“œ',saleDate:'êµ¬ë§¤ì¼ì',partnerModal:'supplier', saveUrl:'/api/statements/buy'},
      MONEY:{saleCode:'ìˆ˜ê¸ˆì½”ë“œ',saleDate:'ìˆ˜ê¸ˆì¼ì',partnerModal:'partner', saveUrl:'/api/statements/money'},
      PAYMENT:{saleCode:'ì§€ê¸‰ì½”ë“œ',saleDate:'ì§€ê¸‰ì¼ì',partnerModal:'supplier', saveUrl:'/api/statements/payment'},
    };
    function applyTypeLabels(t){
      const m=labelsByType[t]||labelsByType.SALES;
      const setTxt = (id, txt)=>{const el=document.getElementById(id); if(el) el.textContent=txt;};
      setTxt('lbl-saleCode', m.saleCode);
      setTxt('lbl-saleDate', m.saleDate);
      setTxt('lbl-voucherDate','ì „í‘œì¼ì');
    }

    let _vnoInFlight=false;
    async function fetchPreviewVoucherNo(type,dateStr){
      const $vno=document.getElementById('vf-voucherNo'); const $resv=document.getElementById('vf-resvId');
      if(!$vno || _vnoInFlight) return; _vnoInFlight=true;
      try{
        $vno.classList.add('vf-loading'); $vno.value='ì „í‘œë²ˆí˜¸ í™•ì¸ì¤‘...'; if($resv) $resv.value='';
        const qs=new URLSearchParams({type,...(dateStr?{date:dateStr}:{})});
        const res=await fetch(`/api/vouchers/preview?${qs.toString()}`,{method:'GET'});
        const text=await res.text();
        if(!res.ok) throw new Error(text||'preview failed');
        const j=text?JSON.parse(text):{};
        $vno.value=j?.voucherNo || 'ìë™ë°œë²ˆ';
      }catch(e){ $vno.value='ìë™ë°œë²ˆ'; }
      finally{ $vno.classList.remove('vf-loading'); _vnoInFlight=false; }
    }

    async function reserveVoucher(type,dateStr){
      const qs=new URLSearchParams({type,...(dateStr?{date:dateStr}:{})});
      const res=await fetch(`/api/vouchers/reserve?${qs.toString()}`,{method:'GET'});
      const text=await res.text();
      if(!res.ok) throw new Error(text||'reserve failed');
      const j=text?JSON.parse(text):{};
      if(!j.reservationId||!j.voucherNo) throw new Error('ì˜ˆì•½ ì‹¤íŒ¨(í•„ë“œëˆ„ë½)');
      return j;
    }

    function bindNumericFields(){
      const $taxSel=document.getElementById('vf-taxType');
      const $supply=document.getElementById('vf-supply');
      const $vat=document.getElementById('vf-vat');
      const $total=document.getElementById('vf-total');
      const sync=p=>{lastCalc.supply=p.supply;lastCalc.vat=p.vat;lastCalc.total=p.total;lastCalc.taxType=$taxSel.value;
        $supply.value=fmt(p.supply); $vat.value=fmt(p.vat); $total.value=fmt(p.total);};
      $supply.addEventListener('input',()=>{const p=fromSupply(unfmt($supply.value),$taxSel.value);lastCalc.mode='SUPPLY';sync(p);});
      $total .addEventListener('input',()=>{const p=fromTotal(unfmt($total.value),$taxSel.value);lastCalc.mode='TOTAL';sync(p);});
      $supply.addEventListener('blur', ()=>{const p=fromSupply(unfmt($supply.value),$taxSel.value);lastCalc.mode='SUPPLY';sync(p);});
      $total .addEventListener('blur', ()=>{const p=fromTotal (unfmt($total.value ),$taxSel.value);lastCalc.mode='TOTAL' ;sync(p);});
      $taxSel.addEventListener('change',()=>{const p=(lastCalc.mode==='TOTAL')?fromTotal(lastCalc.total,$taxSel.value):fromSupply(lastCalc.supply,$taxSel.value);sync(p);});
      sync(fromTotal(0,$taxSel.value)); lastCalc.mode='TOTAL';
    }

    const $findPartnerBtn=document.getElementById('vf-find-partner');
    const $partnerName   =document.getElementById('vf-partnerName');
    const $findSaleBtn   =document.getElementById('vf-find-saleCode');
    const $saleCode      =document.getElementById('vf-saleCode');
    const $saleDate      =document.getElementById('vf-saleDate');

    function openPartnerPicker(){
      if (typeof openModal !== 'function'){ toast('ê²€ìƒ‰ ëª¨ë‹¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      const t = ($type.value||'SALES').toUpperCase();
      const modalType = (t==='BUY'||t==='PAYMENT') ? 'supplier' : 'partner';
      openModal(modalType, (row)=>{
        $partnerName.value = row?.partnerName || row?.supplierName || row?.customerName || row?.clientName || row?.buyerName || row?.correspondent || '';
      });
    }

    // --- (NEW) ì¸ë³´ì´ìŠ¤ í”¼ì»¤ (ê³µí†µ ëª¨ë‹¬ì´ ì—†ìœ¼ë©´ fallback ì‹¤í–‰) ---
    async function fallbackInvoicePicker(cb){
      try{
        const q = prompt('ì²­êµ¬ì„œ ê²€ìƒ‰ì–´(ì½”ë“œ/ê±°ë˜ì²˜) ì…ë ¥ (STATUS=íšŒê³„ë°˜ì˜ì™„ë£Œë§Œ ì¡°íšŒë¨):','');
        const params=new URLSearchParams({status:'íšŒê³„ë°˜ì˜ì™„ë£Œ', ...(q?{q}:{})});
        const res = await fetch(`/api/invoices/lookup?`+params.toString(), {headers:{'Accept':'application/json'}});
        if(!res.ok) throw new Error(await res.text());
        const list = await res.json();
        if(!Array.isArray(list) || list.length===0){ toast('ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤'); return; }
        const lines = list.map((r,i)=>`${i+1}. ${r.invoiceCode} | ${r.partnerName??''} | ${r.dmndAmt?.toLocaleString?.()||''} | ${r.status} | ${String(r.createDate||'').slice(0,10)}`).join('\n');
        const pick = prompt('ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:\n'+lines, '1');
        const idx = (Number(pick)||1)-1;
        if(list[idx]) cb(list[idx]);
      }catch(e){ toast('ì¡°íšŒ ì‹¤íŒ¨: '+(e.message||'ì˜¤ë¥˜')); }
    }

    function openCodePicker(){
      const t = ($type.value||'SALES').toUpperCase();
      // MONEYì¼ ë•ŒëŠ” ì²­êµ¬ì„œ(INVOICE) ì¡°íšŒë¡œ ì „í™˜
      if(t==='MONEY'){
        const onPick = (row)=>{
          // saleCode ì…ë ¥ë€ì—ëŠ” ì²­êµ¬ì„œ ì½”ë“œ ì‚¬ìš©
          $saleCode.value = row?.invoiceCode || row?.invoice_unique_code || row?.invoiceCode?.trim?.() || '';
          // ë‚ ì§œ: ì²­êµ¬ì„œ ì‘ì„±ì¼ì/ìˆ˜ê¸ˆì˜ˆì •ì¼ ì¤‘ í•˜ë‚˜ë¥¼ ê¸°ë³¸ ë°˜ì˜ (ì—†ìœ¼ë©´ create_date)
          const pickedDate = row?.rcptDate || row?.dmndDate || row?.createDate;
          if (pickedDate){
            const d = new Date(pickedDate);
            $saleDate.value = isNaN(d) ? String(pickedDate).slice(0,10) : d.toISOString().slice(0,10);
          }
          // ê±°ë˜ì²˜ëª…ë„ ê°™ì´ ë°˜ì˜
          const partner = row?.partnerName || row?.partner_name || '';
          if (partner) $partnerName.value = partner;
        };

        if (typeof openModal === 'function'){
          // ê³µí†µ ëª¨ë‹¬ì´ 'invoice' íƒ€ì…ì„ ì¸ì‹í•˜ë„ë¡ êµ¬í˜„ë˜ì–´ ìˆë‹¤ë©´ ì´ê²ƒì„ ì‚¬ìš©
          // ëª¨ë‹¬ ë‚´ë¶€ì—ì„œ /api/invoices/lookup?status=íšŒê³„ë°˜ì˜ì™„ë£Œ í˜¸ì¶œí•˜ë„ë¡ êµ¬í˜„ë˜ì–´ ìˆì–´ì•¼ í•¨
        	openModal('acinvoice', onPick);
        }else{
          // ê³µí†µ ëª¨ë‹¬ì´ ì—†ëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ê°„ì´ í”¼ì»¤
          fallbackInvoicePicker(onPick);
        }
        return;
      }

      // ê·¸ ì™¸ ê¸°ì¡´ ë™ì‘
      if (typeof openModal !== 'function'){ toast('ê²€ìƒ‰ ëª¨ë‹¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      const modalType = (t==='BUY'||t==='PAYMENT') ? 'buy' : 'sales';
      openModal(modalType, (row)=>{
        $saleCode.value = (t==='BUY'||t==='PAYMENT') ? (row?.buyCode??'') : (row?.salesCode??'');
        const pickedPartner = row?.partnerName || row?.supplierName || row?.correspondent || row?.customerName || row?.partner || row?.clientName || row?.buyerName || '';
        if (pickedPartner) $partnerName.value = pickedPartner;
        const pickedDate = (t==='BUY'||t==='PAYMENT') ? (row?.purchaseDate || row?.buyDate) : (row?.salesDate);
        if (pickedDate){
          const d = new Date(pickedDate);
          $saleDate.value = isNaN(d) ? String(pickedDate).slice(0,10) : d.toISOString().slice(0,10);
        }
      });
    }

    document.getElementById('vf-find-partner')?.addEventListener('click', openPartnerPicker);
    document.getElementById('vf-find-saleCode')?.addEventListener('click', openCodePicker);

    const setVal=(id,val)=>{const el=document.getElementById(id); if(el) el.value=val;};
    const todayStr=()=> new Date().toISOString().slice(0,10);
    function initDates(){
      const t=todayStr();
      setVal('vf-voucherDate', t);
      setVal('vf-saleDate',    t);
    }

    async function resetForm(){
      setVal('vf-saleCode',''); setVal('vf-partnerName','');
      setVal('vf-empName', (typeof currentUserName==='string'?currentUserName:'')); setVal('vf-remark','');
      setVal('vf-taxType','TAXABLE'); setVal('vf-resvId','');
      initDates();
      const p=fromTotal(0,'TAXABLE');
      setVal('vf-supply', fmt(p.supply)); setVal('vf-vat', fmt(p.vat)); setVal('vf-total', fmt(p.total));
      await fetchPreviewVoucherNo($type.value, document.getElementById('vf-voucherDate').value);
    }
    document.getElementById('btn-reset')?.addEventListener('click', resetForm);

    document.getElementById('vf-save')?.addEventListener('click', async (e)=>{
      e?.preventDefault?.();
      const $btn=e.currentTarget; if($btn.disabled) return;
      const orig=$btn.textContent; $btn.disabled=true; $btn.textContent='ì €ì¥ ì¤‘...';

      const t=($type.value||'SALES').toUpperCase();
      const map=labelsByType[t]||labelsByType.SALES;
      const voucherDate=document.getElementById('vf-voucherDate').value||null;

      try{
        const {reservationId,voucherNo}=await reserveVoucher(t,voucherDate);
        setVal('vf-resvId', reservationId);
        if(voucherNo) setVal('vf-voucherNo', voucherNo);
      }catch(err){
        toast('ì˜ˆì•½ ì‹¤íŒ¨: '+(err.message||'')); $btn.disabled=false; $btn.textContent=orig; return;
      }

      const body={
        reservationId:document.getElementById('vf-resvId')?.value||null,
        voucherDate,
        partnerName:document.getElementById('vf-partnerName').value||null,
        employee:document.getElementById('vf-empName').value||null,
        taxCode:document.getElementById('vf-taxType').value||'TAXABLE',
        amountSupply:unfmt(document.getElementById('vf-supply').value),
        amountVat:unfmt(document.getElementById('vf-vat').value),
        amountTotal:unfmt(document.getElementById('vf-total').value),
        remark:document.getElementById('vf-remark').value||null,
      };
      if(t==='BUY'||t==='PAYMENT') body.buyCode=document.getElementById('vf-saleCode').value||null;
      else if(t==='MONEY') body.invoiceCode=document.getElementById('vf-saleCode').value||null; // â† ìˆ˜ê¸ˆì€ ì²­êµ¬ì„œì½”ë“œ ê¸°ë°˜
      else body.salesCode=document.getElementById('vf-saleCode').value||null;

      const url=map.saveUrl;
      const csrfToken=document.querySelector('meta[name="_csrf"]')?.content;
      const csrfHeader=document.querySelector('meta[name="_csrf_header"]')?.content||'X-CSRF-TOKEN';

      try{
        const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json',...(csrfToken?{[csrfHeader]:csrfToken}:{})},body:JSON.stringify(body)});
        const text=await res.text();
        if(res.status===403) throw new Error('403 Forbidden - CSRF í† í° ëˆ„ë½/ë§Œë£Œ.');
        if(!res.ok) throw new Error(text||'save failed');
        const {voucherNo}=text?JSON.parse(text):{}; if(voucherNo) setVal('vf-voucherNo', voucherNo);
        toast(`ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤${voucherNo?`: ${voucherNo}`:''}`);
      }catch(e){ toast('ì €ì¥ ì‹¤íŒ¨: '+(e.message||'')); }
      finally{ $btn.disabled=false; $btn.textContent=orig; }
    });

    (async function bootstrap(){
      await initVoucherTypes();
      initDates();
      applyTypeLabels($type.value);
      await fetchPreviewVoucherNo($type.value, document.getElementById('vf-voucherDate').value);
      bindNumericFields();

      $type.addEventListener('change', async ()=>{
        applyTypeLabels($type.value);
        await fetchPreviewVoucherNo($type.value, document.getElementById('vf-voucherDate').value);
      });
      document.getElementById('vf-voucherDate').addEventListener('change', ()=>
        fetchPreviewVoucherNo($type.value, document.getElementById('vf-voucherDate').value||'')
      );
    })();
  });
  </script>
</body>
</html>
