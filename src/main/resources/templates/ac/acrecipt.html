<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    /* ===== í˜ì´ì§€ ë ˆì´ì•„ì›ƒ(ëª©ë¡/ê²€ìƒ‰) ===== */
    .wrap{width:100%;max-width:1600px;margin:0 auto;padding:0 8px;}
    .section{margin:12px 0;}
    .btn{height:38px;padding:0 .9rem;}
    .btn-icon{min-width:38px;}
    .actions-right{display:flex;justify-content:flex-end;gap:8px;}

    .table-wrap{
      position:relative;background:#fff;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;
      --grid-h: calc(72vh - 80px);
      box-shadow:0 4px 20px rgba(0,0,0,.04);
    }

    /* ===== Tabulator ìŠ¤íƒ€ì¼ ê°œì„  ===== */
    .tabulator{border:0;}
    .tabulator-header{border-bottom:1px solid #e5e7eb;}
    .tabulator-col{
      background:#fafafa;
      font-weight:700;
      letter-spacing:.2px;
    }
    .tabulator-tableholder{max-height:var(--grid-h);}
    .tabulator-row .tabulator-cell{border-right:1px dashed #f0f0f0;}
    .tabulator-row:last-child .tabulator-cell{border-bottom:0;}

    /* ===== ë¡œë”© ì˜¤ë²„ë ˆì´ ===== */
    .loading-overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,.6);backdrop-filter:blur(1.5px);z-index:50;}
    .loading-overlay.show{display:flex;}
    .loading-box{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:10px;background:#fff;border:1px solid #e5e7eb;box-shadow:0 4px 18px rgba(0,0,0,.08);font-weight:600;color:#333;}
    .toast-min{position:fixed;right:24px;bottom:24px;background:#333;color:#fff;padding:10px 14px;border-radius:8px;opacity:.95;z-index:2000}

    @media print{ body{ -webkit-print-color-adjust:exact; print-color-adjust:exact; } }

    /* ===== ê²€ìƒ‰ë°” ===== */
    .searchline{
      display:flex; align-items:flex-end; gap:12px;
      flex-wrap:nowrap; overflow-x:auto; padding-bottom:2px;
    }
    .form-group{display:flex;flex-direction:column;gap:6px;}
    .form-label{font-size:.95rem;font-weight:600;color:#374151;}
    .input-with-icon{position:relative;display:inline-block;width:220px;}
    .input-with-icon .form-control{width:100%;padding-right:40px;}
    .input-with-icon .icon-btn{
      position:absolute;right:6px;top:50%;transform:translateY(-50%);
      border:0;background:transparent;padding:0;margin:0;
      width:28px;height:28px;display:inline-flex;align-items:center;justify-content:center;
      cursor:pointer;border-radius:6px;z-index:2;
    }
    .input-with-icon .icon-btn .fa-solid{font-size:16px;color:#6b7280;}
    .input-with-icon .icon-btn:hover .fa-solid{color:#111827;}

    .date-row{display:flex;align-items:center;gap:6px;width:100%;}
    .date-row .form-control{width:150px;}
    .push-right{margin-left:auto;}

    @media (max-width: 980px){
      .searchline{flex-wrap:wrap;}
      .push-right{margin-left:0;}
    }
  </style>
</head>

<body layout:fragment="content">
<div id="layoutSidenav_content">
  <main>
    <div class="wrap">
      <!-- ì œëª© -->
      <div class="section">
        <h1 class="mb-0">ê±°ë˜ëª…ì„¸ì„œ</h1>
      </div>

      <!-- ê²€ìƒ‰ -->
      <div class="section">
        <div class="searchline">
          <!-- ê±°ë˜ì²˜ëª… -->
          <div class="form-group">
            <label class="form-label" for="s-partner">ê±°ë˜ì²˜ëª…</label>
            <div class="input-with-icon">
              <input id="s-partner" type="text" class="form-control" placeholder="ê±°ë˜ì²˜ëª…">
              <button id="btn-find-partner" type="button" class="icon-btn" aria-label="ê±°ë˜ì²˜ ê²€ìƒ‰">
                <i class="fa-solid fa-magnifying-glass"></i>
              </button>
            </div>
          </div>
          <!-- í’ˆëª©ëª… -->
          <div class="form-group">
            <label class="form-label" for="s-product">í’ˆëª©ëª…</label>
            <div class="input-with-icon">
              <input id="s-product" type="text" class="form-control" placeholder="í’ˆëª©ëª…">
              <button id="btn-find-product" type="button" class="icon-btn" aria-label="í’ˆëª© ê²€ìƒ‰">
                <i class="fa-solid fa-magnifying-glass"></i>
              </button>
            </div>
          </div>
          <!-- ì¼ì ë²”ìœ„ + ë²„íŠ¼ë“¤ -->
          <div class="form-group" style="flex:1;">
            <label class="form-label">ì¼ì ë²”ìœ„</label>
            <div class="date-row">
              <input id="s-from" type="date" class="form-control">
              <span style="color:#6b7280;">~</span>
              <input id="s-to" type="date" class="form-control">
              <button id="btn-search" type="button" class="btn btn-warning">ê²€ìƒ‰</button>
              <button id="btn-reset"  type="button" class="btn btn-outline-secondary">ì´ˆê¸°í™”</button>
              <div class="push-right"></div>
              <button id="btn-print" type="button" class="btn btn-dark">ì¸ì‡„</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ëª©ë¡ -->
      <div class="section">
        <div class="table-wrap">
          <div id="acrecipt-grid"></div>
          <div id="tbl-loading" class="loading-overlay" aria-hidden="true">
            <div class="loading-box">
              <div class="spinner-border" role="status" aria-label="loading"></div>
              <span>ë°ì´í„° ë¡œë”© ì¤‘â€¦</span>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>
</div>

<!-- ê³µí†µ ëª¨ë‹¬ fragment -->
<div th:replace="common/modal :: commonModal"></div>

<script>
(() => {
  /* ===== ìœ í‹¸ ===== */
  const $  = (s, r=document) => r.querySelector(s);
  const fmt = (n) => Number(n||0).toLocaleString();
  const toast=(m,ms=1600)=>{const t=document.createElement('div');t.className='toast-min';t.textContent=m;document.body.appendChild(t);setTimeout(()=>t.remove(),ms);};

  // ë‚ ì§œ â†’ YYYY-MM-DD
  function toYmd(input){
    if(!input) return "";
    try{
      const d = new Date(input);
      if (!isNaN(d)) {
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const day = String(d.getDate()).padStart(2,'0');
        return `${y}-${m}-${day}`;
      }
      const s = String(input).replace(/[^\d]/g,'');
      if (s.length>=8) return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
      return String(input).slice(0,10);
    }catch(_){ return String(input).slice(0,10); }
  }
  const todayStr=()=>toYmd(new Date());

  function initDates(){ $('#s-from').value = ''; $('#s-to').value = ''; }

  const $overlay = $('#tbl-loading');
  const showLoading = ()=> $overlay?.classList.add('show');
  const hideLoading = ()=> $overlay?.classList.remove('show');

  /* ===== Tabulator ===== */
  let allSelected=false;
  const grid = new Tabulator("#acrecipt-grid", {
    height:"100%",
    layout:"fitColumns",
    pagination:true,
    paginationMode:"local",
    paginationSize:19,
    selectable:true,
    selectableRangeMode:"drag",
    columnDefaults:{ headerHozAlign:"center" },  // í—¤ë” ê°€ìš´ë°
    columns:[
      { titleFormatter:"rowSelection", formatter:"rowSelection",
        width:55, headerSort:false, hozAlign:"center", headerHozAlign:"center",
        titleFormatterParams:{ rowRange:"active" },
        headerClick:()=>{ if(!allSelected){ grid.selectRow("visible"); } else { grid.deselectRow(); } allSelected=!allSelected; }
      },
      { title:"ê±°ë˜ì²˜ëª…", field:"partnerName", minWidth:180, hozAlign:"center" },
      { title:"í’ˆëª©ëª…",   field:"productName", minWidth:220, hozAlign:"center" },
      { title:"ìˆ˜ëŸ‰",     field:"qty",         minWidth:90,  hozAlign:"right", formatter:(c)=>fmt(c.getValue()) },
      { title:"ê³µê¸‰ê°€ì•¡", field:"amountSupply", minWidth:120, hozAlign:"right", formatter:(c)=>fmt(c.getValue()) },
      { title:"ë¶€ê°€ì„¸",   field:"amountVat",    minWidth:110, hozAlign:"right", formatter:(c)=>fmt(c.getValue()) },
      { title:"ì´ ê¸ˆì•¡",  field:"amountTotal",  minWidth:130, hozAlign:"right", formatter:(c)=>fmt(c.getValue()) },
      { title:"ì£¼ë¬¸ì¼ì", field:"salesDate",    width:130,   hozAlign:"center", formatter:(c)=>toYmd(c.getValue()) },
    ],
    initialSort:[{column:"salesDate", dir:"desc"}],
  });

  /* ===== ê²€ìƒ‰ ===== */
  async function search(){
    const partner = $('#s-partner').value?.trim() || '';
    const product = $('#s-product').value?.trim() || '';
    const from    = $('#s-from').value || '';
    const to      = $('#s-to').value || '';

    const qs = new URLSearchParams({ partnerName: partner, productName: product, from, to });

    showLoading();
    let payload;
    try{
      const res  = await fetch(`/api/acrecipt?${qs.toString()}`, { headers:{'Accept':'application/json'} });
      const text = await res.text();
      if(!res.ok) throw new Error(text || 'search failed');
      payload = text ? JSON.parse(text) : [];
    }catch(e){
      console.error('[ACRECIPT] fetch failed', e);
      toast('ì¡°íšŒ ì‹¤íŒ¨: ' + (e.message||'')); payload=[];
    } finally {
      hideLoading();
    }

    if (!Array.isArray(payload)) {
      console.warn('Debug info from server:', payload);
      toast('ì„œë²„ SQL ë§¤ì¹­ ì‹¤íŒ¨. ì½˜ì†”ì˜ ë””ë²„ê·¸ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
      grid.clearData();
      return;
    }

    const rows = (payload||[]).map((r, idx)=>({
      id:            r.id ?? (idx+1),
      partnerName:   r.partnerName || '',
      partnerPhone:  r.partnerPhone || '',
      businessNo:    r.businessNo || '',
      partnerCeo:    r.partnerCeo || '',
      partnerAddress:r.partnerAddress || '',

      productName:   r.productName || '',
      unit:          r.unit || '',
      qty:           Number(r.qty||0)||0,
      amountSupply:  Number(r.amountSupply||0)||0,
      amountVat:     Number(r.amountVat||0)||0,
      amountTotal:   Number(r.amountTotal||0)||0,
      salesDate:     toYmd(r.salesDate || '')
    }));

    await grid.setData(rows);
    grid.setPage(1);
  }

  /* ì´ˆê¸°í™” */
  function resetForm(){
    $('#s-partner').value=''; $('#s-product').value='';
    initDates();
    grid.clearData();
    search();
  }

  /* íšŒì‚¬ì •ë³´(ê³µê¸‰ì) */
  async function fetchCompany(){
    try{
      const r = await fetch('/api/company/profile', { headers:{'Accept':'application/json'} });
      if(!r.ok) throw 0;
      const j = await r.json();
      return {
        name: j?.name || j?.companyName || 'ìš°ë¦¬íšŒì‚¬',
        bizNo: j?.bizNo || j?.businessNumber || '',
        tel:  j?.tel   || j?.phone || '',
        ceo:  j?.ceo   || j?.owner || '',
        addr: j?.address || ''
      };
    }catch(_){
      return { name:'ìš°ë¦¬íšŒì‚¬', bizNo:'', tel:'', ceo:'', addr:'' };
    }
  }

  /* í•œê¸€ ê¸ˆì•¡í‘œê¸° */
  function numberToKoreanFormal(n){
    n = Number(n||0);
    if (!n) return 'ì˜ì›';
    const num = ['','ì¼','ì´','ì‚¼','ì‚¬','ì˜¤','ìœ¡','ì¹ ','íŒ”','êµ¬'];
    const unit1 = ['','ì‹­','ë°±','ì²œ'];
    const unit2 = ['','ë§Œ','ì–µ','ì¡°','ê²½'];
    let s = '', i2 = 0;
    while(n>0){
      let part = n % 10000, chunk = '';
      for(let i=0;i<4;i++){
        const d = part % 10;
        if (d){ const dt = (i>0 && d===1) ? '' : num[d]; chunk = dt + unit1[i] + chunk; }
        part = Math.floor(part/10);
      }
      if (chunk) s = chunk + unit2[i2] + (s? ' '+s:'');
      n = Math.floor(n/10000); i2++;
    }
    return s + 'ì›';
  }

  /* ===== ì¸ì‡„: ê°™ì€ ê±°ë˜ì²˜ë§Œ í—ˆìš© + ê±°ë˜ì²˜ ì •ë³´ ì¶œë ¥ ===== */
  function openPrintWindow(rowsForOnePartner, company){
    const p = rowsForOnePartner[0] || {};
    const partnerInfo = {
      name:  p.partnerName||'',
      bizNo: p.businessNo||'',
      ceo:   p.partnerCeo||'',
      phone: p.partnerPhone||'',
      addr:  p.partnerAddress||''
    };

    const totalSupply = rowsForOnePartner.reduce((a,b)=>a+(+b.amountSupply||0),0);
    const totalVat    = rowsForOnePartner.reduce((a,b)=>a+(+b.amountVat||0),0);
    const total       = totalSupply + totalVat;
    const sumQty      = rowsForOnePartner.reduce((a,b)=>a+(+b.qty||0),0);

    const rowsHtml = rowsForOnePartner.map(r=>{
      const unitPrice = (r.qty ? Math.round((+r.amountSupply||0) / r.qty) : 0);
      const dt = toYmd(r.salesDate);
      const qtyWithUnit = `${Number(r.qty||0).toLocaleString()}${r.unit ? ' ' + r.unit : ''}`;
      return `
        <tr>
          <td class="c">${dt}</td>
          <td class="c">${(r.productName||'')}</td>
          <td class="c">${qtyWithUnit}</td>
          <td class="num">${unitPrice.toLocaleString()}</td>
          <td class="num">${(+r.amountSupply||0).toLocaleString()}</td>
          <td class="num">${(+r.amountVat||0).toLocaleString()}</td>
          <td class="num">${((+r.amountTotal || ((+r.amountSupply||0)+(+r.amountVat||0)))).toLocaleString()}</td>
        </tr>`;
    }).join('');

    const filler = Array(Math.max(0, 9 - rowsForOnePartner.length)).fill(
      '<tr><td>&nbsp;</td><td></td><td></td><td class="num"></td><td class="num"></td><td class="num"></td><td class="num"></td></tr>'
    ).join('');

    const korAmt = numberToKoreanFormal(total).replace(/ì›$/, 'ì› ì •');
    const today = todayStr();

    const html = `<!DOCTYPE html>
  <html lang="ko"><head><meta charset="UTF-8">
  <title>ê±°ë˜ëª…ì„¸ì„œ</title>
  <style>
    @page{ size:A4; margin:10mm 12mm; }
    *{ box-sizing:border-box; }
    body{ font-family:"Malgun Gothic","Apple SD Gothic Neo",sans-serif; color:#000; }
    .sheet{ width:100%; }
    .title{ text-align:center; font-size:28px; font-weight:800; letter-spacing:.5px; margin:2px 0 10px; }

    .top-wrap{ display:grid; grid-template-columns:1.05fr 1fr; gap:8px; }

    .left-box{ border:2px solid #000; padding:8px 10px; display:grid; gap:6px; border-radius:8px; }
    .left-row{ display:grid; grid-template-columns:120px 1fr; gap:0; font-size:13px; }
    .left-label{ background:#f6f7fb; border:1px solid #000; padding:8px; font-weight:700; border-right:none; border-radius:6px 0 0 6px; }
    .left-val{ border:1px solid #000; padding:8px; border-left:none; border-radius:0 6px 6px 0; }

    .supplier-card{ border:2px solid #000; border-radius:8px; overflow:hidden; }
    .supplier-card .card-head{
      background:#f6f7fb; border-bottom:2px solid #000;
      padding:8px 12px; font-weight:800; font-size:16px; text-align:center; letter-spacing:.5px;
    }
    .supplier-card .card-body table{ width:100%; border-collapse:collapse; }
    .supplier-card .card-body td{ border:1px solid #000; padding:8px; font-size:13px; }
    .supplier-card .card-body td.label{ width:120px; background:#fafafa; font-weight:700; }
    .nowrap{ white-space:nowrap; word-break:keep-all; overflow-wrap:normal; }

    .amount-bar{ margin:10px 0 8px; display:grid; grid-template-columns:1fr auto; align-items:center; }
    .amount-left{ border-top:2px solid #000; border-bottom:2px solid #000; padding:8px 10px; font-weight:800; }
    .amount-right{ font-weight:800; }

    table.grid{ width:100%; border-collapse:collapse; border-top:2px solid #000; border-bottom:2px solid #000; }
    .grid th,.grid td{ border:1px solid #000; padding:8px; font-size:13px; text-align:center; }
    .grid th{ background:#f6f7fb; font-weight:800; }
    .num{ text-align:right !important; }

    .sum{ width:100%; border-left:2px solid #000; border-right:2px solid #000; border-bottom:2px solid #000; border-top:none; }
    .sum td{ border-top:1px solid #000; padding:8px; font-weight:800; text-align:center; }
    .sum .num{ text-align:right !important; }
  </style>
  </head>
  <body>
    <div class="sheet">
      <div class="title">ê±°ë˜ëª…ì„¸ì„œ</div>

      <div class="top-wrap">
        <div class="left-box">
          <div class="left-row"><div class="left-label">ê±°ë˜ì²˜ëª…</div><div class="left-val">${partnerInfo.name}</div></div>
          <div class="left-row"><div class="left-label">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</div><div class="left-val">${partnerInfo.bizNo}</div></div>
          <div class="left-row"><div class="left-label">ëŒ€í‘œì</div><div class="left-val">${partnerInfo.ceo}</div></div>
          <div class="left-row"><div class="left-label">ì „í™”</div><div class="left-val">${partnerInfo.phone}</div></div>
          <div class="left-row"><div class="left-label">ì£¼ì†Œ</div><div class="left-val">${partnerInfo.addr}</div></div>
        </div>

        <div class="supplier-card">
          <div class="card-head">ê³µê¸‰ì</div>
          <div class="card-body">
            <table>
              <tr>
                <td class="label">ì¼ë ¨ë²ˆí˜¸</td><td class="val nowrap">${today}-1</td>
                <td class="label">TEL</td><td class="val nowrap">${company.tel}</td>
              </tr>
              <tr>
                <td class="label">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</td><td class="val nowrap">${company.bizNo}</td>
                <td class="label">ì„±ëª…</td><td class="val">${company.ceo}</td>
              </tr>
              <tr>
                <td class="label">ìƒí˜¸</td><td class="val" colspan="3">${company.name}</td>
              </tr>
              <tr>
                <td class="label">ì£¼ì†Œ</td><td class="val" colspan="3">${company.addr}</td>
              </tr>
            </table>
          </div>
        </div>
      </div>

      <div class="amount-bar">
        <div class="amount-left">ê¸ˆ&nbsp;&nbsp;ì•¡ : ${korAmt}</div>
        <div class="amount-right">(ï¿¦${(total).toLocaleString()})</div>
      </div>

      <table class="grid">
        <thead>
          <tr>
            <th style="width:100px;">ì¼ì</th>
            <th>í’ˆëª©ëª…[ê·œê²©]</th>
            <th style="width:120px;">ìˆ˜ëŸ‰</th>
            <th style="width:110px;">ë‹¨ê°€</th>
            <th style="width:130px;">ê³µê¸‰ê°€ì•¡</th>
            <th style="width:110px;">ë¶€ê°€ì„¸</th>
            <th style="width:120px;">ì´ ê¸ˆì•¡</th>
          </tr>
        </thead>
        <tbody>
          ${rowsHtml}${filler}
        </tbody>
      </table>

      <table class="sum">
        <tr>
          <td style="width:80px;">ìˆ˜ëŸ‰</td>
          <td class="num" style="width:120px;">${sumQty.toLocaleString()}</td>
          <td style="width:120px;">ê³µê¸‰ê°€ì•¡</td>
          <td class="num" style="width:140px;">${totalSupply.toLocaleString()}</td>
          <td style="width:60px;">VAT</td>
          <td class="num" style="width:120px;">${totalVat.toLocaleString()}</td>
          <td style="width:80px;">í•©ê³„</td>
          <td class="num" style="width:140px;">${(total).toLocaleString()}</td>
          <td style="width:80px;">ì¸ìˆ˜</td>
          <td class="num" style="width:100px;"></td>
        </tr>
      </table>
    </div>
  </body>
  </html>`;

    // ğŸ”„ ìƒˆ ì°½ ì—†ì´, íˆë“  iframeì—ì„œ ì¸ì‡„
    const iframe = document.createElement("iframe");
    iframe.style.position = "fixed";
    iframe.style.right = "0";
    iframe.style.bottom = "0";
    iframe.style.width = "0";
    iframe.style.height = "0";
    iframe.style.border = "0";
    iframe.style.visibility = "hidden";
    document.body.appendChild(iframe);

    const cleanup = () => { try { iframe.remove(); } catch(_) {} };
    const safetyTimer = setTimeout(cleanup, 15000); // onafterprint ë¯¸ë°œìƒ ëŒ€ë¹„

    const doPrint = () => {
      try {
        const w = iframe.contentWindow;
        if (!w) { clearTimeout(safetyTimer); cleanup(); return; }
        w.onafterprint = () => { clearTimeout(safetyTimer); cleanup(); };
        w.addEventListener?.("beforeunload", () => { clearTimeout(safetyTimer); cleanup(); });
        // ì•½ê°„ì˜ ë Œë”ë§ ì‹œê°„ í›„ í”„ë¦°íŠ¸
        setTimeout(() => { try { w.focus(); w.print(); } catch(_) { cleanup(); } }, 120);
      } catch(_) {
        clearTimeout(safetyTimer); cleanup();
      }
    };

    // ë¬¸ì„œ ì£¼ì…
    const doc = iframe.contentDocument || iframe.contentWindow?.document;
    if (doc) { doc.open(); doc.write(html); doc.close(); doPrint(); }
    else { clearTimeout(safetyTimer); cleanup(); }
  }


  async function onPrint(){
    const selected = grid.getSelectedData() || [];
    if (selected.length===0){ toast('ì¸ì‡„í•  í–‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

    const partners = Array.from(new Set(selected.map(r => (r.partnerName||'').trim())));
    if (partners.length > 1){
      toast('ì„œë¡œ ë‹¤ë¥¸ ê±°ë˜ì²˜ê°€ í•¨ê»˜ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ê°™ì€ ê±°ë˜ì²˜ë§Œ ì„ íƒ í›„ ì¸ì‡„í•´ì£¼ì„¸ìš”.');
      return;
    }
    const company = await fetchCompany();
    openPrintWindow(selected, company);
  }

  /* ê³µí†µ ëª¨ë‹¬ */
  function useCommonModalOrWarn(){
    const has = !!document.getElementById('commonModal');
    if(!has){ toast('ê³µí†µ ëª¨ë‹¬ì´ í˜ì´ì§€ì— í¬í•¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (common/modal :: commonModal)'); }
    return has && typeof openModal === 'function';
  }

  /* ===== ëª¨ë‹¬ ê°œì„ : ê±°ë˜ì²˜=ì‚¬ì›ëª…, í’ˆëª©=ë‹¨ê°€ í‘œì‹œ ===== */
  function pick(obj, fields, def=''){
    for (const f of fields){ if (obj && obj[f] != null && obj[f] !== '') return obj[f]; }
    return def;
  }
  function supportsModalOptions(){
    try { return typeof openModal === 'function' && openModal.length >= 3; } catch(_) { return false; }
  }
  function tryRenameModalHeaderToStaff(){
    setTimeout(()=>{
      const root = document.getElementById('commonModal') || document.body;
      root.querySelectorAll('th, .table th, .modal th').forEach(th=>{
        const txt = (th.textContent||'').trim();
        if (txt === 'ë‹´ë‹¹ì') th.textContent = 'ì‚¬ì›ëª…';
      });
    }, 60);
  }

  function openPartnerPicker(){
    const onSelect = (row)=>{
      document.getElementById('s-partner').value =
        pick(row, ['partnerName','customerName','clientName','buyerName','supplierName'], '');
    };
    if (supportsModalOptions()){
      openModal('partner', onSelect, {
        title: 'ê±°ë˜ì²˜ ì„ íƒ',
        columns: [
          { field: (r)=>pick(r,['partnerName','customerName','clientName','buyerName','supplierName']), title:'ê±°ë˜ì²˜ëª…' },
          { field: (r)=>pick(r,['employeeName','staffName','empName','managerName']),                 title:'ì‚¬ì›ëª…'  },
          { field: (r)=>pick(r,['tel','phone','partnerPhone','contactTel']),                         title:'ì „í™”'    },
          { field: (r)=>pick(r,['businessNo','bizNo']),                                              title:'ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸' }
        ]
      });
    } else {
      openModal('partner', onSelect);
      tryRenameModalHeaderToStaff();
    }
  }

  function openProductPicker(){
    const onSelect = (row)=>{
      document.getElementById('s-product').value =
        pick(row, ['productName','itemName','goodsName','prodName'], '');
    };
    if (supportsModalOptions()){
      openModal('product', onSelect, {
        title: 'í’ˆëª© ì„ íƒ',
        columns: [
          { field: (r)=>pick(r,['productName','itemName','goodsName','prodName']), title:'í’ˆëª©ëª…' },
          { field: (r)=>pick(r,['unit','unitName','uom']),                          title:'ë‹¨ìœ„'  },
          { field: (r)=>Number(pick(r,['unitPrice','price','standardPrice','salePrice'],0))||0,
            title:'ë‹¨ê°€', align:'right', formatter:(v)=>Number(v||0).toLocaleString() }
        ]
      });
    } else {
      openModal('product', onSelect);
    }
  }

  document.getElementById('btn-find-partner')?.addEventListener('click', ()=>{
    if(!useCommonModalOrWarn()) return;
    openPartnerPicker();
  });
  document.getElementById('btn-find-product')?.addEventListener('click', ()=>{
    if(!useCommonModalOrWarn()) return;
    openProductPicker();
  });

  document.getElementById('btn-search').addEventListener('click', (e)=>{ e.preventDefault(); search(); });
  document.getElementById('btn-reset' ).addEventListener('click', (e)=>{ e.preventDefault(); resetForm(); });
  document.getElementById('btn-print' ).addEventListener('click', (e)=>{ e.preventDefault(); onPrint(); });

  /* ì´ˆê¸° ë¡œë“œ */
  initDates();
  search();
})();
</script>
</body>
</html>
