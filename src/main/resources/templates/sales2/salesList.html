<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">

<head>
  <!-- Tabulator CSS -->
  <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
  <!-- Custom CSS -->
  <style>
    .flex-nowrap { flex-wrap: nowrap !important; }

    /* 메인 컨텐츠 패딩 살짝 줄이기 (좁은 화면에서 공간 확보) */
    @media (max-width: 1200px) {
      .container-fluid.px-4 { padding-left: 1rem !important; padding-right: 1rem !important; }
    }

    /* 테이블 카드 박스 */
    .board-card {
      background: #fff;
      border-radius: .5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,.05);
      padding: 12px;
    }

    /* 테이블 래퍼: 좁을 땐 가로 스크롤 허 용 */
    .table-wrapper { overflow-x: auto; }

    /* ✅ 사이드 카드 — 배경색을 더 진하게 변경 */
    .side-card {
      background: #e9ecef; /* 기존 #f8f9fa → 더 진한 회색 */
      border-radius: .5rem;
      padding: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,.05);
    }
     /* 사이드 카드 제목 빨간색 (우선순위 강화) */
	.side-card .d-block.mb-2 { color: #dc3545 !important; }


    /* 헤더의 전체선택 체크박스 정확히 중앙 정렬 */
    #sales-table .tabulator-col.sel-col .tabulator-col-title {
      justify-content: center !important;
    }

    /* 좁은 화면에서 테이블 높이 조금 더 줄여줌 */
    @media (max-width: 992px) {
      .tabulator { min-height: 360px; }
    }

    /* 양쪽 섹션 헤더(제목/드롭박스 라인)의 높이를 동일하게 */
    .section-header {
      display: flex;
      align-items: center;
      gap: 8px;
      min-height: 40px;
      margin-bottom: 12px;
    }
    .section-header .form-select-sm {
      height: calc(1.5em + .5rem + 2px);
    }

    /* === 등록/수정 중 오버레이 === */
    .modal-body.position-relative { position: relative; } /* 오버레이 기준을 위해 */
    .loading-overlay {
      position: absolute;
      inset: 0;
      background: rgba(255,255,255,.75);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1055;           /* 모달 내부 최상단 */
      pointer-events: all;     /* 클릭 차단 */
    }
    .loading-overlay.d-none { display: none; }

  </style>
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<body layout:fragment="content">
<div id="layoutSidenav_content">
  <main>
    <div class="container-fluid px-4">
      <h2 class="mt-4">영업계획목록</h2>

      <!-- ✅ 반응형 그리드: lg 이상에선 9:3, md에선 8:4, sm에선 12:12 -->
      <div class="row g-3 align-items-start">
        <!-- 테이블 영역 -->
        <div class="col-12 col-md-8 col-lg-9 order-1">
          <div class="board-card">
            <div class="d-flex justify-content-end gap-2 mb-2">
              <button id="btn-new" class="btn btn-primary">신규</button>
              <button class="btn btn-secondary" onclick="ExportHelper.exportExcel(table, '영업계획')">Excel</button>
              <button class="btn btn-secondary" onclick="ExportHelper.exportPDF(table, '영업계획')">PDF</button>
            </div>

            <div class="table-wrapper">
              <!-- 메인 목록 테이블 -->
              <div id="sales-table"></div>
            </div>
          </div>
        </div>

		<!-- 유의사항 영역 -->
		<div class="col-12 col-md-4 col-lg-3 order-2">
		  <div class="side-card">
		
		    <div class="mb-4">
		      <strong class="d-block mb-2 text-danger">미수금 상위5 거래처</strong>
		      <table class="table table-borderless mb-0">
		        <tbody id="top-ar-body">
		          <tr><td colspan="2">로딩중...</td></tr>
		        </tbody>
		      </table>
		    </div>
		
		    <div>
		      <strong class="d-block mb-2 text-danger">여신초과 상위5 거래처</strong>
		      <table class="table table-borderless mb-0">
		        <tbody id="credit-exceed-body">
		          <tr><td colspan="2">로딩중...</td></tr>
		        </tbody>
		      </table>
		    </div>
		  </div>
		</div>

      <!-- 등록 모달 -->
      <div class="modal fade" id="insertSalesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">영업계획 등록</h5>
              <div class="ms-auto d-flex gap-2">
                <button type="button" class="btn btn-primary" id="btn-save-sales">저장</button>
                <button type="button" class="btn btn-outline-dark" id="btn-reset-sales">초기화</button>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
            </div>

            <!-- ▼ position-relative 추가 (오버레이 기준) -->
            <div class="modal-body position-relative">
              <!-- ✅ 상단 한 줄 헤더(좌: 작년, 우: 올해+드롭박스) -->
              <div class="row g-2 align-items-center mb-2">
                <div class="col-12 col-lg-6">
                  <div class="section-header">
                    <h5 class="mb-0">작년 영업매출</h5>
                    <div class="ms-auto"></div>
                  </div>
                </div>

                <div class="col-12 col-lg-6">
                  <div class="section-header">
                    <h5 class="mb-0">올해 영업계획 등록</h5>
                    <div class="ms-auto">
                      <select id="combo-option" class="form-select form-select-sm" style="width:120px;">
                        <option value="">선택</option>
                        <option>5%</option>
                        <option>10%</option>
                        <option>15%</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ✅ 테이블 2개 (헤더 아래에서 시작 라인 일치) -->
              <div class="row g-3">
                <div class="col-12 col-lg-6">
                  <div id="lastYearTable"></div>
                </div>
                <div class="col-12 col-lg-6">
                  <div id="thisYearTable"></div>
                </div>
              </div>

              <!-- 등록 진행중 오버레이 -->
              <div id="save-loading" class="loading-overlay d-none">
                <div class="text-center">
                  <div class="spinner-border" role="status" aria-hidden="true"></div>
                  <div class="mt-2 fw-semibold">로딩 중…</div>
                </div>
              </div>
            </div><!-- /modal-body -->

          </div><!-- /modal-content -->
        </div><!-- /modal-dialog -->
      </div><!-- /insertSalesModal -->

      <!-- 수정 모달 -->
      <div class="modal fade" id="modifySalesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">영업계획 수정</h5>
              <div class="ms-auto d-flex gap-2">
                <button type="button" class="btn btn-primary" id="btn-update-sales">저장</button>
                <button type="button" class="btn btn-outline-dark" id="btn-cancel-update">초기화</button>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
            </div>

            <!-- ▼▼▼ position-relative + 오버레이 추가 ▼▼▼ -->
            <div class="modal-body position-relative">
              <div id="editYearTable"></div>

              <!-- 수정 진행중 오버레이 -->
              <div id="update-loading" class="loading-overlay d-none">
                <div class="text-center">
                  <div class="spinner-border" role="status" aria-hidden="true"></div>
                  <div class="mt-2 fw-semibold">로딩 중…</div>
                </div>
              </div>
            </div>
            <!-- ▲▲▲ 여기까지 추가 ▲▲▲ -->

          </div>
        </div>
      </div>

    </div>
  </main>
</div>

<!-- 외부 스크립트 include만 유지 -->
<script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
<script th:src="@{/sales2/js/salesList.js}"></script>
</body>
</html>
