<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/main}">
<head>
<meta charset="utf-8" />
<title>권한 관리</title>
<style>
:root {
	--line: #e5e7eb;
	--muted: #8a8f98;
	--bg: #f5f7fb;
	--card: #fff;
	--text: #111827;
	--accent: #eef4ff;
	--accent-line: #bfd3ff;
	--thead: #fafbff
}

body {
	margin: 0;
	background: var(--bg);
	color: var(--text);
	font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
		Arial, 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif
}

.rp .layout {
	display: flex;
	gap: 16px;
	min-width: 0;
	padding: 16px;
	height: calc(100vh - 160px)
}

.rp .left {
	flex: 0 0 260px;
	min-width: 260px;
	background: #fff;
	border: 1px solid var(--line);
	border-radius: 12px;
	overflow: auto;
	max-height: 100%
}

.rp .left-head {
	padding: 12px 14px;
	border-bottom: 1px solid #eee;
	font-weight: 700
}

.rp .role-list {
	padding: 6px
}

.rp .role-item {
	padding: 10px 12px;
	border-radius: 8px;
	cursor: pointer
}

.rp .role-item:hover {
	background: #f7f9ff
}

.rp .role-item.active {
	background: var(--accent);
	border: 1px solid var(--accent-line)
}

.rp .right {
	flex: 1 1 auto;
	min-width: 0;
	min-height: 0;
	display: flex;
	flex-direction: column
}

.rp .toolbar {
	display: flex;
	gap: 8px;
	align-items: center;
	margin: 0 0 10px
}

.rp .toolbar .spacer {
	flex: 1
}

.rp .input {
	height: 36px;
	padding: 0 10px;
	border: 1px solid #c8c8c8;
	border-radius: 6px;
	background: #fff
}

.rp .btn {
	height: 36px;
	padding: 0 14px;
	border: 1px solid #d0d5dd;
	border-radius: 8px;
	background: #fff;
	cursor: pointer
}

.rp .btn-primary {
	background: #4f46e5;
	border-color: #4f46e5;
	color: #fff
}

.rp .btn-primary:hover {
	opacity: .95
}

.rp .card {
	border: 1px solid var(--line);
	border-radius: 12px;
	background: #fff;
	flex: 1 1 auto;
	min-height: 0;
	display: flex;
	flex-direction: column
}

.rp .table-wrap {
	flex: 1 1 auto;
	min-height: 0;
	overflow: auto;
	max-width: 100%
}

.rp table {
	width: 100%;
	border-collapse: separate;
	border-spacing: 0
}

.rp thead th {
	position: sticky;
	top: 0;
	z-index: 1;
	background: var(--thead);
	border-bottom: 1px solid var(--line);
	font-weight: 700
}

.rp th, .rp td {
	padding: 10px 8px;
	text-align: center;
	border-bottom: 1px solid #f0f0f0;
	white-space: nowrap
}

.rp td:first-child, .rp th:first-child {
	text-align: center
}

.rp .empty {
	padding: 28px;
	color: var(--muted);
	text-align: center
}

.rp .mod-row td {
	background: #f8fafc;
	font-weight: 700;
	text-align: left;
	border-top: 2px solid var(--line)
}

@media ( max-width :960px) {
	.rp .layout {
		flex-direction: column;
		height: auto
	}
	.rp .left {
		max-height: none
	}
}
</style>
</head>
<body layout:fragment="content">
	<div id="layoutSidenav_content">
		<main>
			<div class="container-fluid px-4">
				<h1 class="mt-4">권한 관리</h1>

				<div id="rolePermApp" class="rp">
					<div class="layout">
						<!-- 왼쪽: 역할 리스트 -->
						<aside class="left" aria-label="역할 목록">
							<div class="left-head">권한(ROLE)</div>
							<div id="roleList" class="role-list"></div>
						</aside>

						<!-- 오른쪽: 필터 + 표 -->
						<section class="right" aria-label="권한 편집">
							<div class="toolbar">
								<label for="selModule" class="sr-only"
									style="position: absolute; left: -10000px;">모듈</label> <select
									id="selModule" class="input">
									<option value="">모듈 전체</option>
								</select> <label for="qScreen" class="sr-only"
									style="position: absolute; left: -10000px;">화면 검색</label> <input
									id="qScreen" class="input" placeholder="화면명 검색" />

								<div class="spacer"></div>

								<button id="btnSave" class="btn btn-primary" type="button">변경
									저장</button>
							</div>

							<div class="card table-wrap">
								<table id="permTable" aria-label="권한 테이블">
									<thead>
										<tr>
											<th style="width: 44px"></th>
											<th style="text-align: left">화면</th>
											<th><input type="checkbox" id="colRead" title="조회 전체선택">
												조회</th>
											<th><input type="checkbox" id="colCreate"
												title="등록 전체선택"> 등록</th>
											<th><input type="checkbox" id="colUpdate"
												title="수정 전체선택"> 수정</th>
											<th><input type="checkbox" id="colDelete"
												title="삭제 전체선택"> 삭제</th>
										</tr>
									</thead>
									<tbody id="tbody"></tbody>
								</table>
								<div id="empty" class="empty" style="display: none">데이터가
									없습니다.</div>
							</div>
						</section>
					</div>
				</div>
			</div>
		</main>
	</div>

	<script>
/* ------------------------------
   상태
--------------------------------*/
let state = {
  roles: [],               // [{roleCode, roleName}]
  currentRoleCode: null,
  modules: [],             // [{code, name}]
  rows: [],                // [{moduleCode, moduleName, screenCode, screenName, r,c,u,d}]
  dirty: new Map(),        // key=screenCode, val={r,c,u,d}
  onlyY: true
};

/* ------------------------------
   초기화
--------------------------------*/
document.addEventListener('DOMContentLoaded', () => init());

async function init(){
  try {
    await Promise.all([loadRoles(), loadModules()]);
    bindEvents();
  } catch (e) {
    console.error(e);
    alert('초기화 중 오류가 발생했습니다.');
  }
}

/* ------------------------------
   공통 Fetch 유틸
--------------------------------*/
async function jget(url){
  const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
  if(!res.ok) throw new Error(await res.text());
  return res.json();
}
async function jput(url, body){
  const res = await fetch(url, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  if(!res.ok) throw new Error(await res.text());
  return res.text().catch(()=> '');
}

/* ------------------------------
   데이터 로딩
--------------------------------*/
async function loadRoles(){
  // 기존에 사용하던 역할 목록 API 유지
  // 예) GET /api/role-perms → [{roleCode, roleName}]
  const roles = await jget('/api/role-perms');
  state.roles = roles ?? [];

  const wrap = document.getElementById('roleList');
  wrap.innerHTML = '';
  state.roles.forEach(r=>{
    const li = document.createElement('div');
    li.className = 'role-item';
    li.textContent = r.roleName || r.roleCode;
    li.onclick = ()=> selectRole(r.roleCode, li);
    wrap.appendChild(li);
  });
}

async function loadModules(){
  // GET /api/screens/modules?onlyY=true  → [{code, name}]
  state.modules = await jget(`/api/screens/modules?onlyY=${state.onlyY}`);
  const sel = document.getElementById('selModule');
  sel.innerHTML = '<option value="">모듈 전체</option>';
  (state.modules || []).forEach(m=>{
    const opt = document.createElement('option');
    opt.value = m.code; opt.textContent = m.name || m.code;
    sel.appendChild(opt);
  });
}

async function selectRole(roleCode, el){
  state.currentRoleCode = roleCode;
  document.querySelectorAll('.role-item').forEach(x=>x.classList.remove('active'));
  el?.classList.add('active');
  await loadPerms(roleCode);
  renderTable();
}

/**
 * 화면+권한 묶음 조회 (조인 결과를 바로 받음)
 * 컨트롤러 기준: GET /api/roles/{roleCode}/screens?onlyY=true
 * (companyCode는 서버에서 SecurityContext로 해결)
 * 응답: [{moduleCode, screenCode, screenName, readYn, createYn, updateYn, deleteYn}]
 */
async function loadPerms(roleCode){
  const kw = document.getElementById('qScreen').value.trim().toLowerCase();
  const module = document.getElementById('selModule').value;

  const list = await jget(`/api/roles/${encodeURIComponent(roleCode)}/screens?onlyY=${state.onlyY}`);

  // moduleCode → moduleName 매핑
  const modMap = new Map((state.modules||[]).map(m=>[m.code, m.name]));
  let rows = (list||[]).map(x=>({
    moduleCode : x.moduleCode,
    moduleName : modMap.get(x.moduleCode) || x.moduleCode,
    screenCode : x.screenCode,
    screenName : x.screenName,
    r: (x.readYn   || 'N') === 'Y',
    c: (x.createYn || 'N') === 'Y',
    u: (x.updateYn || 'N') === 'Y',
    d: (x.deleteYn || 'N') === 'Y',
  }));

  // 클라이언트 필터(모듈/검색어)
  if(module) rows = rows.filter(r=>r.moduleCode === module);
  if(kw) rows = rows.filter(r=> r.screenName.toLowerCase().includes(kw));

  state.rows = rows;
  state.dirty.clear();
}

/* ------------------------------
   렌더링
--------------------------------*/
function bindEvents(){
  document.getElementById('selModule').addEventListener('change', renderOrReload);
  document.getElementById('qScreen').addEventListener('input', debounce(renderOrReload, 250));

  const head = document.querySelector('#permTable thead');
  head.querySelector('#colRead')  .onchange = e => toggleAll('r', e.target.checked);
  head.querySelector('#colCreate').onchange = e => toggleAll('c', e.target.checked);
  head.querySelector('#colUpdate').onchange = e => toggleAll('u', e.target.checked);
  head.querySelector('#colDelete').onchange = e => toggleAll('d', e.target.checked);

  document.getElementById('btnSave').addEventListener('click', saveChanges);
}

async function renderOrReload(){
  if(!state.currentRoleCode){ renderTable(); return; }
  await loadPerms(state.currentRoleCode);
  renderTable();
}

function renderTable(){
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';

  const list = state.rows.slice().sort((a,b)=>
    (a.moduleName||'').localeCompare(b.moduleName||'') ||
    a.screenName.localeCompare(b.screenName)
  );

  if(list.length === 0){
    document.getElementById('empty').style.display = 'block';
    // 헤더도 초기화
    recalcHeaderToggles();
    return;
  }
  document.getElementById('empty').style.display = 'none';

  let curModule = null;
  list.forEach(row=>{
    if(row.moduleName !== curModule){
      curModule = row.moduleName;
      const trM = document.createElement('tr'); trM.className='mod-row';
      const td  = document.createElement('td'); td.colSpan=6; td.textContent = curModule || '(모듈 미정)';
      trM.appendChild(td);
      tbody.appendChild(trM);
    }
    tbody.appendChild(buildRow(row));
  });

  recalcHeaderToggles();
}


function buildRow(row){
  const tr = document.createElement('tr');

  const tdSel = document.createElement('td'); tdSel.textContent = '';

  const tdName = document.createElement('td');
  tdName.textContent = row.screenName;
  tdName.style.textAlign = 'left';

  const inputs = {};

  const mk = (key) => {
    const td = document.createElement('td');
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.dataset.col = key; // 헤더 상태 재계산용
    cb.checked = !!(state.dirty.get(row.screenCode)?.[key] ?? row[key]);
    inputs[key] = cb;

    cb.onchange = (e)=>{
      const checked = e.target.checked;
      const cur = state.dirty.get(row.screenCode) || {r:row.r,c:row.c,u:row.u,d:row.d};
      cur[key] = checked;

      // C/U/D 켜면 R도 자동 켜기
      if ((key === 'c' || key === 'u' || key === 'd') && checked) {
        cur.r = true;
        if (inputs.r && !inputs.r.checked) inputs.r.checked = true;
      }
      // R 끄면 C/U/D 자동 끄기
      if (key === 'r' && !checked) {
        cur.c = false; cur.u = false; cur.d = false;
        if (inputs.c) inputs.c.checked = false;
        if (inputs.u) inputs.u.checked = false;
        if (inputs.d) inputs.d.checked = false;
      }

      state.dirty.set(row.screenCode, cur);

      // 헤더 전체선택 체크박스 상태 재계산
      recalcHeaderToggles();
    };

    td.appendChild(cb);
    return td;
  };

  tr.append(tdSel, tdName, mk('r'), mk('c'), mk('u'), mk('d'));
  return tr;
}

function toggleAll(key, checked){
  const tbody = document.getElementById('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'))
    .filter(tr => !tr.classList.contains('mod-row'));

  rows.forEach(tr=>{
    const nameTd = tr.children[1];
    if(!nameTd) return;
    const screenName = nameTd.textContent.trim();

    const row = state.rows.find(r => r.screenName === screenName);
    if(!row) return;
    const cur = state.dirty.get(row.screenCode) || {r:row.r,c:row.c,u:row.u,d:row.d};
    
    cur[key] = checked;
    
    if ((key === 'c' || key === 'u' || key === 'd') && checked) {
        cur.r = true;
    }
    
    if (key === 'r' && !checked) {
        cur.c = false;
        cur.u = false;
        cur.d = false;
    }
    
    state.dirty.set(row.screenCode, cur);
  });

  renderTable();
}

function recalcHeaderToggles(){
  const tbody = document.getElementById('tbody');
  const head = document.querySelector('#permTable thead');

  const headMap = {
    r: head.querySelector('#colRead'),
    c: head.querySelector('#colCreate'),
    u: head.querySelector('#colUpdate'),
    d: head.querySelector('#colDelete'),
  };

  for (const [key, headCb] of Object.entries(headMap)) {
    if (!headCb) continue;
    const boxes = tbody.querySelectorAll(`input[type="checkbox"][data-col="${key}"]`);
    const total = boxes.length;
    if (total === 0){
      headCb.checked = false;
      headCb.indeterminate = false;
      continue;
    }
    let checked = 0;
    boxes.forEach(b => { if (b.checked) checked++; });

    headCb.checked = (checked === total);
    headCb.indeterminate = (checked > 0 && checked < total);
  }
}

/* ------------------------------
   저장 (백엔드 PUT 연결 필요)
--------------------------------*/
async function saveChanges(){
	  if(!state.currentRoleCode){ alert('역할을 먼저 선택하세요.'); return; }

	  // 1) 현재 렌더된 행에서 실제 체크박스 상태 읽기
	  const tbody = document.getElementById('tbody');
	  const trs = Array.from(tbody.querySelectorAll('tr'))
	    .filter(tr => !tr.classList.contains('mod-row'));

	  const payload = [];
	  trs.forEach(tr => {
	    const tds = tr.querySelectorAll('td');
	    if (tds.length < 6) return;

	    const screenName = tds[1].textContent.trim();
	    const row = state.rows.find(r => r.screenName === screenName);
	    if (!row) return;

	    const cbRead   = tds[2].querySelector('input[type="checkbox"]');
	    const cbCreate = tds[3].querySelector('input[type="checkbox"]');
	    const cbUpdate = tds[4].querySelector('input[type="checkbox"]');
	    const cbDelete = tds[5].querySelector('input[type="checkbox"]');

	    payload.push({
	      roleCode  : state.currentRoleCode,
	      screenCode: row.screenCode,
	      canRead   : !!(cbRead?.checked),
	      canCreate : !!(cbCreate?.checked),
	      canUpdate : !!(cbUpdate?.checked),
	      canDelete : !!(cbDelete?.checked),
	    });
	  });

	  // 바뀐 것만 보내고 싶다면 이전값과 비교해서 필터링
	  // (원하면 이 블록을 주석 해제)
	  // const changed = payload.filter(p => {
	  //   const r = state.rows.find(x => x.screenCode === p.screenCode);
	  //   return r && (r.r!==p.canRead || r.c!==p.canCreate || r.u!==p.canUpdate || r.d!==p.canDelete);
	  // });
	  // if (changed.length === 0) { alert('변경된 내용이 없습니다.'); return; }

	  try{
	    console.log('PUT /api/role-save payload = ', payload); // 디버깅용
	    await jput('/api/role-save', payload);

	    // 성공 시 state 갱신
	    payload.forEach(ch => {
	      const r = state.rows.find(x => x.screenCode === ch.screenCode);
	      if (r){ r.r = ch.canRead; r.c = ch.canCreate; r.u = ch.canUpdate; r.d = ch.canDelete; }
	    });
	    state.dirty.clear();
	    alert('저장되었습니다.');
	  }catch(err){
	    console.error(err);
	    alert('저장 중 오류가 발생했습니다.');
	  }
	}

/* ------------------------------
   유틸
--------------------------------*/
function debounce(fn, ms){
  let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), ms); };
}
</script>
</body>
</html>
