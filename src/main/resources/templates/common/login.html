<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Login - SB Admin</title>
    <link th:href="@{/erp/css/styles.css}" rel="stylesheet" />
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<body class="bg-primary">
    <div id="layoutAuthentication" class="mt-5">
        <div id="layoutAuthentication_content" class="mt-5">
            <main>
                <div class="container">
                    <div class="row justify-content-center">
                        <div class="col-lg-5">
                            <div class="card shadow-lg border-0 rounded-lg mt-5">
                                <div class="card-header"><h3 class="text-center font-weight-light my-4">로그인</h3></div>
                                <div class="card-body">
                                    <form th:action="@{/doLogin}" method="post" onsubmit="return validateCaptcha();">
                                        <div class="form-floating mb-3">
                                            <input class="form-control" id="inputCompanyCode" type="text"
                                                   placeholder="회사코드" required />
                                            <label for="inputCompanyCode">회사코드</label>
                                        </div>
                                        <div class="form-floating mb-3">
                                            <input class="form-control" id="inputId" type="text" placeholder="ID" required />
                                            <label for="inputId">ID</label>
                                        </div>
                                        <div class="form-floating mb-3">
                                            <input class="form-control" id="inputPassword"
                                                   type="password" name="password" placeholder="PW" required />
                                            <label for="inputPassword">PW</label>
                                        </div>

                                        <!-- 실제 Spring Security에서 인식하는 username -->
                                        <input type="hidden" id="username" name="username" />

                                        <!-- 로그인 reCAPTCHA -->
                                        <div class="d-flex justify-content-center mb-3">
                                            <div id="recaptcha-login"></div>
                                        </div>

                                        <div class="d-flex align-items-center justify-content-between mt-4 mb-0">
                                            <a class="small" href="#" data-bs-toggle="modal" data-bs-target="#passwordModal">
                                                비밀번호 찾기
                                            </a>
                                            <button class="btn btn-primary" type="submit">Login</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 비밀번호 찾기 모달 -->
    <div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="passwordModalLabel">비밀번호 찾기</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
          </div>
          <div class="modal-body">
            <form id="passwordFindForm">
              <div class="mb-3">
                <label for="findCompany" class="form-label">회사코드</label>
                <input type="text" class="form-control" id="findCompany" name="companyCode" required>
              </div>
              <div class="mb-3">
                <label for="findUserId" class="form-label">아이디</label>
                <input type="text" class="form-control" id="findUserId" name="userId" required>
              </div>
              <div class="mb-3">
                <label for="findEmail" class="form-label">이메일</label>
                <input type="email" class="form-control" id="findEmail" name="email" 
                       placeholder="입력한 이메일로 임시 비밀번호가 발송됩니다." required>
              </div>

              <!-- 모달 reCAPTCHA -->
              <div class="d-flex justify-content-center mb-3">
                <div id="recaptcha-modal"></div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            <button type="button" class="btn btn-primary" onclick="submitPasswordFind()">확인</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap & Script -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script th:src="@{/erp/js/scripts.js}"></script>

    <script>
      let recaptchaLogin, recaptchaModal;

      function onloadCallback() {
        // 로그인용
        recaptchaLogin = grecaptcha.render('recaptcha-login', {
          'sitekey': '6LdsS9MrAAAAAOThzNK1m8wInDgEN9UVephRaG6y'
        });

        // 모달용
        recaptchaModal = grecaptcha.render('recaptcha-modal', {
          'sitekey': '6LdsS9MrAAAAAOThzNK1m8wInDgEN9UVephRaG6y'
        });
      }

      function mergeUserId() {
        const company = document.getElementById("inputCompanyCode").value.trim();
        const userId = document.getElementById("inputId").value.trim();
        document.getElementById("username").value = company + ":" + userId;
      }

      function validateCaptcha() {
        mergeUserId();
        const response = grecaptcha.getResponse(recaptchaLogin);
        if (response.length === 0) {
          alert("캡챠 인증을 완료해주세요.");
          return false;
        }
        return true;
      }

      function submitPasswordFind() {
    	    const company = document.getElementById("findCompany").value.trim();
    	    const userId = document.getElementById("findUserId").value.trim();
    	    const email = document.getElementById("findEmail").value.trim();
    	    const captcha = grecaptcha.getResponse(recaptchaModal);

    	    if (!company || !userId || !email) {
    	        alert("모든 값을 입력해주세요.");
    	        return;
    	    }
    	    if (captcha.length === 0) {
    	        alert("캡챠 인증을 완료해주세요.");
    	        return;
    	    }

    	    // CSRF 토큰 읽기
    	    const csrfToken = document.querySelector("meta[name='_csrf']").getAttribute("content");
    	    const csrfHeader = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

    	    fetch("/common/findPassword", {
    	        method: "POST",
    	        headers: {
    	            "Content-Type": "application/json",
    	            [csrfHeader]: csrfToken   // CSRF 헤더 추가
    	        },
    	        body: JSON.stringify({companyCode: company, userId: userId, email: email, recaptcha: captcha})
    	    })
    	    .then(res => res.json())
    	    .then(data => {
    	        alert(data.message);
    	        grecaptcha.reset(recaptchaModal);
    	        document.getElementById("passwordFindForm").reset();

    	        if (data.success) {
    	            const modal = bootstrap.Modal.getInstance(document.getElementById("passwordModal"));
    	            modal.hide();
    	        }
    	    })
    	    .catch(err => {
    	        console.error(err);
    	        alert("오류가 발생했습니다.");
    	    });
    	}
    </script>

    <!-- 구글 reCAPTCHA API (명시적 렌더링 모드) -->
    <script src="https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit" async defer></script>
</body>
</html>
