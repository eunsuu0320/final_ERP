<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">

<head>
  <meta charset="utf-8" />
  <title>구독 관리 - Tabulator 전환</title>
  <!-- Tabulator CSS -->
  <link href="https://unpkg.com/tabulator-tables@5.6.2/dist/css/tabulator.min.css" rel="stylesheet" />
  <style>
    /* 안정적인 레이아웃 */
    *, *::before, *::after { box-sizing: border-box; }

    /* 공통 패널 */
    .panel { background:#fff; border:1px solid #cfcfd4; border-radius:4px; }
    .panel-title {
      display:flex; justify-content:space-between; align-items:center;
      height:48px; padding:0 12px; border-bottom:1px solid #dcdcdc;
      background:#f5f5f5; font-weight:700;
    }
    .panel-title .title { font-size:16px; }
    .panel-title .actions { display:flex; align-items:center; gap:8px; }
    .panel-title .actions .btn { height:32px; padding:0 12px; line-height:32px; margin:0; }

    /* 컨트롤 바 */
    .toolbar { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:10px; }
    .toolbar .filters { display:flex; gap:8px; align-items:center; }
    .toolbar .filters .form-control, .toolbar .filters .form-select { height:36px; }

    /* Tabulator 공통 높이 */
    .table-wrap { height: 320px; }
    /* 구독내역만 살짝 낮게 */
    .table-wrap--subs { height: 320px; }

    /* 구독 양식 */
    .subs-form { padding:12px; }
    .fg { display:flex; flex-direction:column; margin-bottom:10px; }
    .fg label { font-size:14px; margin-bottom:6px; font-weight:700; }
    .fg input { height:38px; border:1px solid #c8c8c8; border-radius:4px; padding:6px 10px; }
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:12px 20px; }

    /* Tabulator 헤더 정렬 개선 */
    .tabulator .tabulator-header .tabulator-col .tabulator-col-title { white-space:nowrap; }
      /* 구독 정보 살짝 키우기 */
    .panel--info .subs-form{ min-height: 340px; }
      /* 좌우 영역 배치: 오른쪽(구독내역)을 내용 너비만큼만 */
    .split { display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:stretch; }
    .panel--subs { align-self:start; }
    .panel--subs .tabulator { width: fit-content !important; }
    /* 구독 정보 살짝 키우기 */
    .panel--info .subs-form{ min-height: 360px; }
      .toolbar .actions { display:flex; gap:8px; align-items:center; }
  .panel--info .subs-form{ min-height: 320px !important; }
  </style>
</head>

<body layout:fragment="content">
<div id="layoutSidenav_content">
  <main>
    <div class="container-fluid px-4">
      <h1 class="mt-4">구독 관리</h1>

      <!-- 상단 검색 + 신규 -->
      <div class="toolbar toolbar--swap">
        <div class="filters">
          <input type="hidden" id="employeeId" name="employeeId" class="form-control">
          <input type="text" id="employeeName" class="form-control" placeholder="사원" style="width:180px;">
          <button id="btnFindEmp" class="btn btn-outline-secondary" onclick="openModal('employee', function(selected) {
                    document.getElementById('employeeId').value = selected.empCode;
                    document.getElementById('employeeName').value = selected.name;
                })"><i class="fa fa-search"></i></button>
          <select id="selDept" class="form-select" style="width:180px;">
            <option value="">부서(전체)</option>
            <option value="222">회계팀</option>
            <option value="333">영업팀</option>
            <option value="111">인사팀</option>
          </select>
          <select id="selUseYn" class="form-select" style="width:180px;">
            <option value="">사용여부(전체)</option>
            <option value="Y">Y</option>
            <option value="N">N</option>
          </select>
          <button id="btnSearch" class="btn btn-warning">검색</button>
          <button id="btnReset" class="btn btn-light">초기화</button>
        </div>
        <div class="actions">
          <button id="btnNew" class="btn btn-primary">신규</button>
        </div>
      </div>

      </div>

      <!-- 사용자 목록 테이블 (Tabulator) -->
      <section class="panel mb-3">
        <div class="panel-title">
          <span class="title">사용자 목록</span>
        </div>
        <div id="userTable" class="table-wrap"></div>
      </section>

      <!-- 구독 정보 + 구독 내역 -->
      <div class="split mt-3">
        <!-- 구독 정보 -->
        <section class="panel panel--info flex-fill">
          <div class="panel-title">
            <span class="title">구독 정보</span>
            <div class="actions"></div>
          </div>
          <div class="subs-form">
            <div class="fg">
              <label>회사코드</label>
              <input type="text" id="compCode" value="123-001" readonly>
            </div>

            <div class="grid-2">
              <div class="fg">
                <label>사업자 등록번호</label>
                <input type="text" id="bizNo" value="123-45-67890">
              </div>
              <div class="fg">
                <label>회사명</label>
                <input type="text" id="compName" value="OO주식회사">
              </div>
            </div>

            <div class="grid-2">
              <div class="fg">
                <label>주소</label>
                <input type="text" id="addr" value="대구광역시 북구">
              </div>
              <div class="fg">
                <label>담당자명</label>
                <input type="text" id="picName" value="박효준">
              </div>
            </div>

            <div class="grid-2">
              <div class="fg">
                <label>담당자 연락처</label>
                <input type="text" id="picTel" value="010-1234-5678">
              </div>
              <div class="fg">
                <label>담당자 이메일</label>
                <input type="text" id="picEmail" value="example@company.com">
              </div>
            </div>
          </div>
        </section>

        <!-- 구독 내역 -->
        <section class="panel panel--subs">
          <div class="panel-title">
            <span class="title">구독 내역</span>
            <div class="actions">
              <button type="button" id="btnSubsPrint" class="btn btn-secondary">인쇄</button>
              <button type="button" id="btnSubsExcel" class="btn btn-outline-secondary">엑셀</button>
            </div>
          </div>
          <div id="subsTable" class="table-wrap table-wrap--subs"></div>
        </section>
      </div>
    </div>
  </main>
</div>

<!-- 공통 모달 -->
<div th:replace="common/modal :: commonModal"></div>

<!-- Tabulator JS -->
<script src="https://unpkg.com/tabulator-tables@5.6.2/dist/js/tabulator.min.js"></script>
<script>
  // ===== 사용자 목록 Tabulator =====
  const userTable = new Tabulator("#userTable", {
    layout: "fitColumns",
    height: "291px",
    selectable: true,
    reactiveData: true,
    pagination: true,
    paginationMode: "local",
    paginationSize: 7,
    columnDefaults: { headerSort: true, vertAlign: "middle" },
    columns: [
      { formatter: "rowSelection", titleFormatter: "rowSelection", hozAlign: "center", headerSort: false, width: 80 },
      { title: "사원번호", field: "empNo", width: 120, widthShrink: 0 },
      { title: "성명", field: "name", minWidth: 180, widthGrow: 1 },
      { title: "아이디", field: "loginId", minWidth: 180, widthGrow: 1 },
      { title: "부서명", field: "dept", width: 180 },
      { title: "권한", field: "role", minWidth: 180, widthGrow: 1 },
      { title: "사용", field: "useYn", width: 120, hozAlign: "center" },
    ],
    ajaxURL: "/api/common/users",
    ajaxResponse: function (url, params, response) {
      const list = Array.isArray(response) ? response : [];
      return list.map(r => ({
        empNo:   r.empCode,                            // SystemUser.empCode
        name:    r.employee?.name ?? "",               // Employee.name
        loginId: r.userId,                             // SystemUser.userId
        dept:    r.employee?.deptCode?.codeName        // CommonCode.codeName
                 ?? r.employee?.dept ?? "",            // fallback: 코드값
        role:    r.remk ?? "",                         // 적당히 비고/권한명 대체
        useYn:   r.usageStatus                         // 'Y'/'N'
      }));
    }
  });

  function applyUserFilters() {
    const kw    = document.getElementById('employeeId').value; // 사번/이름/아이디 통합
    const dept  = document.getElementById('selDept').value;
    const useYn = document.getElementById('selUseYn').value;

    // 서버에 파라미터 전달해서 다시 로드
    userTable.setData("/api/common/users", { kw, dept, useYn });
  }

  // 초기화 버튼: 입력 초기화 후 전체 목록 재조회
  document.getElementById('btnReset').addEventListener('click', () => {
    document.getElementById('employeeName').value = '';
    document.getElementById('selDept').value = '';
    document.getElementById('selUseYn').value = '';
    userTable.setData("/api/common/users");
  });

  // 검색 버튼 클릭
  document.getElementById('btnSearch').addEventListener('click', applyUserFilters);

  // 엔터키로 검색
  document.getElementById('employeeName').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') applyUserFilters();
  });
	
  function toDateStr(v){
	    if (!v) return '';
	    const d = typeof v === 'number' ? new Date(v) : new Date(v);
	    if (Number.isNaN(d.getTime())) return '';
	    const y = d.getFullYear();
	    const m = String(d.getMonth()+1).padStart(2,'0');
	    const day = String(d.getDate()).padStart(2,'0');
	    return `${y}-${m}-${day}`;
  }
  
  // ===== 구독 내역 Tabulator =====
  const subsTable = new Tabulator("#subsTable", {
    layout: "fitData", // 컬럼 너비만큼만 테이블 가로 생성
    height: 320,   // 고정 높이(좌측과 동일)
    selectable: true,
    pagination: true,
    paginationMode: "local",
    paginationSize: 8,
    columns: [
      { formatter: "rowSelection", titleFormatter: "rowSelection", hozAlign: "center", headerSort: false, width: 80 },
      { title: "구독기간", field: "term", width: 120, widthShrink: 0 },
      { title: "시작일자", field: "startDate", width: 180, sorter: "date", sorterParams: { format: "YYYY-MM-DD" } },
      { title: "만기일자", field: "endDate", width: 180, sorter: "date", sorterParams: { format: "YYYY-MM-DD" } },
      { title: "가격 (원)", field: "price", hozAlign: "right", width: 180,
        formatter: "money", formatterParams: { symbol: "", thousand: ",", precision: 0 } },
    ],
    ajaxURL: "/api/common/subs",
    ajaxResponse: function(url, params, resp){
      const list = Array.isArray(resp) ? resp : [];
      return list.map(r => ({
        term: r.periodMonth != null
          ? (String(r.periodMonth).match(/개월|month/i) ? String(r.periodMonth) : `${r.periodMonth}개월`)
          : '',
        startDate: toDateStr(r.subscriptionStartDate),
        endDate:   toDateStr(r.subscriptionEndDate),
        price:     r.price ?? 0,
      }));
    },
  });

  // 인쇄/엑셀 버튼
  document.getElementById('btnSubsPrint').addEventListener('click', () => {
    subsTable.print(false, {
      columnHeaders: true,
      rowGroups: false,
      columnCalcs: true,
    });
  });
  document.getElementById('btnSubsExcel').addEventListener('click', () => {
    subsTable.download("xlsx", "구독내역.xlsx", { sheetName: "Subscriptions" });
  });

  // ===== AJAX 연동 예시 (필요 시 주석 해제해서 사용) =====
  userTable.setData("/api/common/users");
  // subsTable.setData("/api/subscriptions", { companyCode: document.getElementById('compCode').value });

  // 모달(사원 검색) 버튼 예시 훅
  document.getElementById('btnFindEmp').addEventListener('click', () => {
    // TODO: 공통 모달 띄우고 선택 결과를 Tabulator 필터나 폼에 반영
  });

  // 신규 버튼 예시
  document.getElementById('btnNew').addEventListener('click', () => {
    // TODO: 신규 사용자 추가/모달/화면 이동 등
  });
</script>
</body>
</html>
