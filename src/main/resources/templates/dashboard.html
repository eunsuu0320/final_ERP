<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}"
      th:inline="none">
<head>
  <meta charset="UTF-8" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --text:#0f172a; --muted:#64748b; --line:#e5e7eb; --card:#ffffff;
      --shadow:0 10px 28px rgba(2,6,23,.08);
      --chip:#f8fafc; --chip-border:#e2e8f0;
      --accent:#2563eb; --accent-dark:#1e40af;
      --up:#16a34a; --down:#dc2626;
    }
    #layoutSidenav_content>main{ background:#fff; min-height:100%; padding-top:16px; }

    /* ===== 상단 타이틀 ===== */
    .page-title-wrap{
      position:relative;
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      margin:8px 0 14px; padding:14px 16px; border:1px solid var(--line);
      border-radius:14px; background:linear-gradient(180deg,#ffffff,#fafcff);
      box-shadow:var(--shadow);
    }
    .page-title-wrap.loading::after{
      content:""; position:absolute; left:12px; right:12px; bottom:-1px; height:3px;
      background:linear-gradient(90deg,var(--accent),#22d3ee,#60a5fa);
      background-size:200% 100%; border-radius:999px;
      animation:bar-scan 1.2s linear infinite;
    }
    @keyframes bar-scan{ 0%{background-position:0% 0;} 100%{background-position:200% 0;} }

    .page-title{ display:flex; align-items:center; gap:12px; color:var(--text); }
    .page-title h1{ margin:0; font-size:28px; font-weight:800; letter-spacing:.2px; }

    .badge-live{
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px; padding:8px 14px; line-height:1; border-radius:999px;
      background:rgba(37,99,235,.08); color:var(--accent-dark);
      font-weight:700; border:1px solid rgba(37,99,235,.18);
      box-shadow:inset 0 -1px 0 rgba(37,99,235,.08);
    }
    .badge-live .dot{ width:8px;height:8px;border-radius:50%; background:#16a34a; box-shadow:0 0 0 4px rgba(22,163,74,.2); }

    .crumbs{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .chip{
      display:inline-flex; align-items:center; gap:8px; background:var(--chip);
      border:1px solid var(--chip-border); color:var(--text);
      padding:8px 12px; border-radius:999px; font-weight:600; line-height:1;
    }
    .chip i{ color:var(--muted); }
    .chip.loading{ display:none; }
    .mini-spinner{
      width:14px; height:14px; border-radius:50%;
      border:2px solid rgba(37,99,235,.2); border-top-color:var(--accent);
      animation:spin 0.8s linear infinite;
    }
    @keyframes spin{ to{ transform:rotate(360deg);} }

    /* ===== KPI 카드 ===== */
    .kpi-grid{ display:grid; gap:16px; grid-template-columns:repeat(12,1fr); }
    .kpi{ grid-column:span 12; position:relative; overflow:hidden; border-radius:16px; padding:16px; color:#fff; box-shadow:var(--shadow); display:flex; align-items:center; gap:14px; }
    @media (min-width:576px){ .kpi{ grid-column:span 6; } }
    @media (min-width:1200px){ .kpi{ grid-column:span 4; } }
    .kpi .icon{ width:56px;height:120px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:26px;background:rgba(255,255,255,.22);backdrop-filter:blur(2px);flex:none; }
    .kpi .meta{ flex:1 1 auto; min-width:0; }
    .kpi .label{ font-weight:700; opacity:.95; }
    .kpi .value{ font-size:28px; font-weight:900; letter-spacing:.3px; }
    .kpi small{ opacity:.95; font-weight:600; display:block; }

    .delta{
      margin-top:6px;
      display:inline-flex; align-items:center; gap:6px;
      font-weight:800; padding:4px 10px; border-radius:999px;
      background:rgba(255,255,255,.22); backdrop-filter:blur(2px);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.25);
    }
    .delta.up{ color:#ecfdf5; background:rgba(22,163,74,.28); box-shadow:inset 0 0 0 1px rgba(22,163,74,.35); }
    .delta.down{ color:#fef2f2; background:rgba(220,38,38,.28); box-shadow:inset 0 0 0 1px rgba(220,38,38,.35); }
    .delta.flat{ color:#111827; background:rgba(255,255,255,.35); }

    .kpi canvas{ position:absolute; right:-8px; bottom:-8px; width:140px!important; height:60px!important; opacity:.35; }
    .kpi.sales{ background:linear-gradient(135deg,#60a5fa 0%,#22d3ee 100%); }
    .kpi.buy  { background:linear-gradient(135deg,#f59e0b 0%,#ef4444 100%); }
    .kpi.emp  { background:linear-gradient(135deg,#34d399 0%,#22c55e 100%); }
    .kpi.ar   { background:linear-gradient(135deg,#6366f1 0%,#06b6d4 100%); }
    .kpi.cnt  { background:linear-gradient(135deg,#14b8a6 0%,#06b6d4 100%); }
    .kpi.att  { background:linear-gradient(135deg,#a78bfa 0%,#22d3ee 100%); }

    .skeleton{ position:relative; overflow:hidden; }
    .skeleton .value, .skeleton small, .skeleton .label, .skeleton .delta{ color:transparent!important; }
    .skeleton::after{
      content:""; position:absolute; inset:0;
      background:linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.35) 50%, rgba(255,255,255,0) 100%);
      transform:translateX(-100%); animation:shimmer 1.4s infinite;
    }
    @keyframes shimmer{ 100%{ transform:translateX(100%);} }

    .panel{ background:var(--card); border:1px solid var(--line); border-radius:14px; box-shadow:var(--shadow); color:var(--text); }
    .panel .card-header{ border-bottom:1px solid var(--line); background:linear-gradient(180deg,#ffffff,#fbfcff); color:var(--text); font-weight:700; }
    .panel .card-body canvas{ width:100% !important; height:260px !important; display:block; }

    .toast-wrap{ position:fixed; right:20px; bottom:20px; display:flex; flex-direction:column; gap:8px; z-index:9999; }
    .toast{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#ffffff; box-shadow:var(--shadow); color:var(--text); font-weight:600; }
    .toast.error{ border-color:#fecaca; background:#fff1f2; color:#991b1b; }
    .toast.info{ border-color:#bfdbfe; background:#eff6ff; color:#1e3a8a; }
    .toast i{ opacity:.8; }
  </style>
</head>

<body layout:fragment="content">
<div id="layoutSidenav_content">
  <main>
    <div class="container-fluid px-4">

      <!-- 상단 타이틀 -->
      <div class="page-title-wrap" id="page-title-wrap">
        <div class="page-title">
          <h1>Dashboard</h1>
          <span class="badge-live"><span class="dot" aria-hidden="true"></span><span>실시간 요약</span></span>
        </div>
        <div class="crumbs">
          <span class="chip"><i class="fa-regular fa-calendar"></i>기준일 <strong id="as-of-date">—</strong></span>
          <span class="chip"><i class="fa-solid fa-rotate"></i>동기화 <strong id="sync-time">—</strong></span>
          <span class="chip loading" id="loading-chip"><span class="mini-spinner" aria-hidden="true"></span><span>불러오는 중…</span></span>
        </div>
      </div>

      <!-- KPI 1열 -->
      <div class="kpi-grid mb-3">
        <div class="kpi sales skeleton" id="kpi-card-sales">
          <div class="icon"><i class="fa-solid fa-won-sign"></i></div>
          <div class="meta">
            <div class="label">이번 달 매출</div>
            <div class="value" id="kpi-sales">0</div>
            <small id="kpi-sales-note">—</small>
            <span id="kpi-sales-delta" class="delta flat">—</span>
          </div>
          <canvas id="spark-sales"></canvas>
        </div>
        <div class="kpi buy skeleton" id="kpi-card-buy">
          <div class="icon"><i class="fa-solid fa-cart-shopping"></i></div>
          <div class="meta">
            <div class="label">이번 달 지출</div>
            <div class="value" id="kpi-buy">0</div>
            <small id="kpi-buy-note">—</small>
            <span id="kpi-buy-delta" class="delta flat">—</span>
          </div>
          <canvas id="spark-buy"></canvas>
        </div>
        <div class="kpi emp skeleton" id="kpi-card-emp">
          <div class="icon"><i class="fa-solid fa-users"></i></div>
          <div class="meta">
            <div class="label">사원수</div>
            <div class="value" id="kpi-emp">0</div>
            <small id="kpi-emp-note">—</small>
          </div>
          <canvas id="spark-emp"></canvas>
        </div>
      </div>

      <!-- KPI 2열 -->
      <div class="kpi-grid mb-4">
        <div class="kpi ar skeleton" id="kpi-card-ar">
          <div class="icon"><i class="fa-solid fa-file-invoice-dollar"></i></div>
          <div class="meta">
            <div class="label">미수금</div>
            <div class="value" id="kpi-ar">0</div>
            <small id="kpi-ar-note">전체 합계</small>
          </div>
          <canvas id="spark-ar"></canvas>
        </div>

        <div class="kpi cnt skeleton" id="kpi-card-cnt">
          <div class="icon"><i class="fa-solid fa-receipt"></i></div>
          <div class="meta">
            <div class="label">매출 전표 건수</div>
            <div class="value" id="kpi-sales-cnt">0</div>
            <small id="kpi-sales-cnt-note">—</small>
          </div>
          <canvas id="spark-sales-cnt"></canvas>
        </div>

        <div class="kpi att skeleton" id="kpi-card-att">
          <div class="icon"><i class="fa-solid fa-user-check"></i></div>
          <div class="meta">
            <div class="label">금일 출근</div>
            <div class="value" id="kpi-attend">0</div>
            <small id="kpi-attend-note">금일 기준</small>
          </div>
          <canvas id="spark-attend"></canvas>
        </div>
      </div>

      <div class="row">
        <div class="col-xl-6">
          <div class="card panel mb-4">
            <div class="card-header"><i class="fas fa-chart-line me-2"></i>월별 매출·매입 추이</div>
            <div class="card-body"><canvas id="chart-line"></canvas></div>
          </div>
        </div>
        <div class="col-xl-6">
          <div class="card panel mb-4">
            <div class="card-header"><i class="fas fa-chart-bar me-2"></i>부서별 인원</div>
            <div class="card-body"><canvas id="chart-bar"></canvas></div>
          </div>
        </div>
      </div>

      <div class="toast-wrap" id="toast-wrap" aria-live="polite" aria-atomic="true"></div>
    </div>
  </main>
</div>

<script>
console.info('[dashboard] v2 (Chart.js v2 mode)');

const won = n => Number(n||0).toLocaleString('ko-KR');
const nf  = new Intl.NumberFormat('ko-KR');

/* ===== 축/툴팁 옵션 (Chart.js v2) ===== */
function moneyChartOptions(){
  return {
    responsive:true, maintainAspectRatio:false,
    legend:{ labels:{ fontColor:'#334155' } },
    tooltips:{ callbacks:{ label:(item,data)=>{
      const ds  = data.datasets[item.datasetIndex];
      const val = item.yLabel;
      return `${ds.label}: ${nf.format(Number(val||0))}`;
    }}},
    scales:{
      xAxes:[{ ticks:{ fontColor:'#64748b' }, gridLines:{ color:'rgba(148,163,184,.25)' } }],
      yAxes:[{ ticks:{
        beginAtZero:true,
        callback:(v)=> nf.format(Math.round(Number(v||0))),
        fontColor:'#64748b'
      }, gridLines:{ color:'rgba(148,163,184,.25)' } }]
    }
  };
}

function peopleChartOptions(yMax){
	  return {
	    responsive:true, maintainAspectRatio:false,
	    legend:{ labels:{ fontColor:'#334155', boxWidth:14 } },
	    tooltips:{ callbacks:{ label:(item,data)=>{
	      const ds = data.datasets[item.datasetIndex];
	      return `${ds.label}: ${Math.round(Number(item.yLabel||0))}`;
	    }}},
	    scales:{
	      xAxes:[{
	        // ⬇️ 막대가 차지하는 영역을 스케일에도 명시 (v2에서 확실)
	        categoryPercentage: 0.45,   // 카테고리 폭 대비 영역
	        barPercentage: 0.55,        // 데이터셋 폭 대비 막대 폭
	        ticks:{ fontColor:'#64748b' },
	        gridLines:{ display:false }
	      }],
	      yAxes:[{
	        ticks:{
	          min:0, max:yMax, beginAtZero:true, stepSize:1,
	          callback:(v)=> Number.isInteger(v)? String(v) : '',
	          fontColor:'#64748b',
	          padding:6
	        },
	        gridLines:{
	          color:'rgba(148,163,184,.18)',
	          zeroLineColor:'rgba(148,163,184,.22)',
	          drawBorder:false
	        }
	      }]
	    },
	    layout:{ padding:{ left:0, right:6, top:4, bottom:0 } }
	  };
	}

/* ===== 스파크라인 (Chart.js v2) ===== */
function sparkline(canvas, data, color){
  new Chart(canvas.getContext('2d'), {
    type:'line',
    data:{ labels:data.map((_,i)=>i+1), datasets:[{
      data,
      borderColor: color || 'rgba(37,99,235,1)',
      backgroundColor: (color||'rgba(37,99,235,1)').replace('1)', '.15)'),
      tension:0.35,
      pointRadius:0,
      borderWidth:2,
      fill:true
    }]},
    options:{
      responsive:true, maintainAspectRatio:false,
      legend:{ display:false }, tooltips:{ enabled:false },
      scales:{ xAxes:[{display:false}], yAxes:[{display:false}] }
    }
  });
}

/* ===== 보조 함수 ===== */
function niceMax(n){
  const max = Math.max(0, Number(n)||0);
  if (max <= 5) return 5;
  const base = max < 50 ? 5 : 10;
  return Math.ceil(max / base) * base;
}

let lineChart, barChart;

/* ===== 차트 생성 ===== */
function buildCharts(months, salesTrend, buyTrend, deptNames, deptCounts){
  // 월별 매출·매입 (그룹 막대)
  const ctx1 = document.getElementById('chart-line').getContext('2d');
  if(lineChart) lineChart.destroy();
  lineChart = new Chart(ctx1,{
    type:'bar',
    data:{
      labels: months,
      datasets:[
        {label:'매출', data:(salesTrend||[]).map(Number), backgroundColor:'rgba(37,99,235,.35)', borderColor:'#2563eb', borderWidth:2, maxBarThickness:36},
        {label:'매입', data:(buyTrend  ||[]).map(Number), backgroundColor:'rgba(245,158,11,.35)', borderColor:'#f59e0b', borderWidth:2, maxBarThickness:36}
      ]
    },
    options: moneyChartOptions()
  });

  // 부서별 인원
  const counts = (deptCounts || []).map(v => Math.max(0, Math.round(Number(v) || 0)));
  const yMax   = niceMax(Math.max(0, ...counts));

  const ctx2 = document.getElementById('chart-bar').getContext('2d');
  if(barChart) barChart.destroy();
  barChart = new Chart(ctx2,{
	  type:'bar',
	  data:{
	    labels: deptNames,
	    datasets:[{
	      label:'사원수',
	      data: counts,
	      backgroundColor:'rgba(16,185,129,.18)',
	      hoverBackgroundColor:'rgba(16,185,129,.28)',
	      borderColor:'#10b981',
	      borderWidth:2,

	      // ⬇️ v2에서 확실히 적용되도록 고정 두께 + 최대 두께
	      barThickness: 14,
	      maxBarThickness: 18,

	      // (참고) 데이터셋에도 보조적으로 넣어 둡니다
	      categoryPercentage: 0.45,
	      barPercentage: 0.55
	    }]
	  },
	  options: peopleChartOptions(yMax)
	});
}

/* ===== 전월 대비 ===== */
function monthLabelToMM(label){
  const digits = String(label).replace(/[^\d]/g,'');
  return digits.padStart(2,'0');
}
function setDeltaBadge(el, cur, prev){
  if(prev == null || prev === 0){
    el.className = 'delta flat';
    el.innerHTML = '<i class="fa-regular fa-circle-question"></i> 전월 데이터 없음';
    return;
  }
  const diff = cur - prev;
  const pct  = (diff / prev) * 100;
  const sign = pct > 0 ? '+' : '';
  const cls  = pct > 0 ? 'up' : (pct < 0 ? 'down' : 'flat');
  const icon = pct > 0 ? 'fa-arrow-trend-up' : (pct < 0 ? 'fa-arrow-trend-down' : 'fa-minus');
  el.className = `delta ${cls}`;
  el.innerHTML = `<i class="fa-solid ${icon}"></i> ${sign}${pct.toFixed(1)}% 전월 대비`;
}
function applyMomBadges(months, salesTrend, buyTrend){
  const now = new Date();
  const mm = String(now.getMonth()+1).padStart(2,'0');
  let idx = months?.findIndex(m => monthLabelToMM(m) === mm);
  if(idx === -1) idx = (months?.length ?? 1) - 1;

  const curSales = Number(salesTrend?.[idx] ?? 0);
  const prevSales = idx>0 ? Number(salesTrend?.[idx-1] ?? 0) : null;
  const curBuy   = Number(buyTrend?.[idx] ?? 0);
  const prevBuy  = idx>0 ? Number(buyTrend?.[idx-1] ?? 0) : null;

  setDeltaBadge(document.getElementById('kpi-sales-delta'), curSales, prevSales);
  setDeltaBadge(document.getElementById('kpi-buy-delta'),   curBuy,   prevBuy);
}

/* ===== 날짜/토스트/로딩 ===== */
function updateHeaderDates(){
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth()+1).padStart(2,'0');
  const dd = String(now.getDate()).padStart(2,'0');
  const hh = String(now.getHours()).padStart(2,'0');
  const mi = String(now.getMinutes()).padStart(2,'0');
  document.getElementById('as-of-date').textContent = `${yyyy}-${mm}-${dd}`;
  document.getElementById('sync-time').textContent = `${yyyy}.${mm}.${dd} ${hh}:${mi}`;
}
function showToast(message, type='info', timeout=3000){
  const wrap = document.getElementById('toast-wrap');
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `<i class="fa-solid ${type==='error'?'fa-circle-exclamation':'fa-circle-info'}"></i> <span>${message}</span>`;
  wrap.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(6px)'; }, timeout);
  setTimeout(()=> wrap.removeChild(el), timeout+300);
}
const titleWrap   = document.getElementById('page-title-wrap');
const loadingChip = document.getElementById('loading-chip');
function startLoading(){ titleWrap.classList.add('loading'); loadingChip.style.display = 'inline-flex'; }
function stopLoading(){  titleWrap.classList.remove('loading'); loadingChip.style.display = 'none'; }
let inFlightController = null;

/* ===== 데이터 로드 ===== */
async function fetchSummaryWithRetry(url, options={}, retries=2){
  try{
    const res = await fetch(url, options);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  }catch(err){
    if (err.name === 'AbortError') throw err;
    if(retries > 0){
      const backoff = 400 * Math.pow(1.5, (2-retries));
      await new Promise(r => setTimeout(r, backoff));
      return fetchSummaryWithRetry(url, options, retries-1);
    }
    throw err;
  }
}
function clearSkeleton(){ document.querySelectorAll('.kpi.skeleton').forEach(el => el.classList.remove('skeleton')); }

async function load(){
  updateHeaderDates();

  if(inFlightController) inFlightController.abort();
  inFlightController = new AbortController();

  startLoading();
  try{
    const d = await fetchSummaryWithRetry('/api/dashboard/summary', {
      headers:{'Accept':'application/json'},
      signal: inFlightController.signal
    }, 2);

    // KPI
    document.getElementById('kpi-sales').textContent = won(d.salesThisMonth||0);
    document.getElementById('kpi-buy').textContent   = won(d.buyThisMonth||0);
    document.getElementById('kpi-emp').textContent   = won(d.employees||0);
    document.getElementById('kpi-ar').textContent    = won(d.arAmount||0);
    document.getElementById('kpi-sales-cnt').textContent = won(d.salesCount||0);
    document.getElementById('kpi-attend').textContent    = won(d.commuteToday||0);

    document.getElementById('kpi-sales-note').textContent = `이번 달: ₩${won(d.salesThisMonth||0)}`;
    document.getElementById('kpi-buy-note').textContent   = `이번 달: ₩${won(d.buyThisMonth||0)}`;
    document.getElementById('kpi-emp-note').textContent   = `총 인원: ${won(d.employees||0)}명`;
    document.getElementById('kpi-sales-cnt-note').textContent = `이번 달 전표`;
    document.getElementById('kpi-attend-note').textContent = '금일 기준';

    // Sparklines
    
    
    sparkline(document.getElementById('spark-emp'),   (d.deptCounts||[]), 'rgba(16,185,129,1)');
    sparkline(document.getElementById('spark-ar'),    (d.arTrend||[]),    'rgba(20,184,166,1)');
    sparkline(document.getElementById('spark-sales-cnt'), (d.salesCntTrend||[]), 'rgba(6,182,212,1)');
    sparkline(document.getElementById('spark-attend'), [(d.commuteToday||0)], 'rgba(139,92,246,1)');

    // Charts
    buildCharts(d.months||[], d.salesTrend||[], d.buyTrend||[], d.deptNames||[], d.deptCounts||[]);

    // 전월 대비
    applyMomBadges(d.months||[], d.salesTrend||[], d.buyTrend||[]);

    clearSkeleton();
    showToast('대시보드가 최신 상태로 동기화되었습니다.', 'info', 2200);
  }catch(e){
    if(e.name !== 'AbortError'){
      clearSkeleton();
      showToast('데이터 불러오기에 실패했어요. 잠시 후 다시 시도됩니다.', 'error', 3500);
      setTimeout(load, 1500);
    }
  }finally{
    stopLoading();
    inFlightController = null;
  }
}

/* ===== 이벤트 ===== */
document.addEventListener('visibilitychange', () => {
  if(document.visibilityState === 'visible') updateHeaderDates();
});
document.addEventListener('DOMContentLoaded', load);
</script>

</body>
</html>
