<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/main}">
<head>
<meta charset="UTF-8">
<title>출퇴근 기록부</title>

<!-- FullCalendar -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/locales/ko.global.min.js"></script>

<!-- Flatpickr (달력 아이콘 눌러서 특정 월 바로 이동) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
 <link href="/hr/css/employee.css" rel="stylesheet" />
</head>
<body layout:fragment="content">
  <div id="layoutSidenav_content">
    <main>
      <div class="container-fluid px-4">
        <h1 class="mt-4">출/퇴근 기록부</h1>

        <input type="hidden" id="companyCode" th:value="${#authentication.name.split(':')[0]}">

    	 <!-- 이동/타이틀 줄 -->
		<div id="cal-header" class="d-flex align-items-center gap-2 position-relative mb-2">
		  <!-- 좌측: 이동 버튼 -->
		  <div class="d-flex gap-2">
		    <button class="btn btn-outline-secondary" id="btn-prev">이전</button>
		    <button class="btn btn-warning" id="btn-today">오늘</button>
		    <button class="btn btn-outline-secondary" id="btn-next">다음</button>
		    <button class="btn btn-outline-secondary" id="btn-datepick" title="날짜 이동">
		      <span class="cal-icon">📅</span>
		    </button>
		  </div>

		  <!-- 중앙: 타이틀 -->
		  <div id="titleBar" class="fw-semibold text-muted"></div>

		  <!-- 우측: 신규/조회 버튼 -->
		  <div class="ms-auto d-flex gap-2">
		    <button id="btn-empOnOff-new" class="btn btn-primary">신규</button>
		    <button id="btn-empOnOff-list" class="btn btn-success">출근 기록 조회</button>
		  </div>
		</div>

        <!-- ✅ 달력만 cal-wrap로 감싸서 높이 자동맞춤 -->
        <div class="cal-wrap">
          <div id="calendar"></div>
        </div>
      </div>
    </main>
  </div>

  <!-- 신규 버튼 -> 사원 출퇴근 기록 모달  -->
<div th:replace="~{hr/empOnOff :: OnOffModal}"></div>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  const calendarEl = document.getElementById('calendar');
  const COMPANY_CODE = document.getElementById('companyCode')?.value || '';

  // ===== 유틸 =====
  const dateKey = d => {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  };
  const dateKeyFromISO = iso => dateKey(new Date(iso));

  // ===== FullCalendar =====
  const calendar = new FullCalendar.Calendar(calendarEl, {
    locale: 'ko',
    initialView: 'dayGridMonth',
    firstDay: 0,
    height: '100%',
    expandRows: true,
    dayMaxEventRows: 3,
    headerToolbar: false,
    titleFormat: { year: 'numeric', month: '2-digit' },
    dayCellContent(info) { return String(info.date.getDate()); }, // 숫자만
    events: loadEvents,
    dateClick: () => {},                 // ✅ 날짜 클릭 무반응
    eventClick(info) {}
  });

  calendar.render();
  updateTitleBar();
  fitCalendarHeight();

  // ===== 툴바 =====
  document.getElementById('btn-prev').onclick  = () => { calendar.prev();  updateTitleBar(); fitCalendarHeight(); };
  document.getElementById('btn-next').onclick  = () => { calendar.next();  updateTitleBar(); fitCalendarHeight(); };
  document.getElementById('btn-today').onclick = () => { calendar.today(); updateTitleBar(); fitCalendarHeight(); };

  const btnMonth = document.getElementById('btn-month');
  const btnList  = document.getElementById('btn-list');
  if (btnMonth) btnMonth.onclick = () => { calendar.changeView('dayGridMonth'); updateTitleBar(); fitCalendarHeight(); };
  if (btnList)  btnList.onclick  = () => { calendar.changeView('listMonth');    updateTitleBar(); fitCalendarHeight(); };

  // 신규 버튼 → 모달 열기
  const OnOffModal = () => new bootstrap.Modal(document.getElementById('OnOffModal'));
  document.getElementById('btn-empOnOff-new').onclick = () => { OnOffModal().show(); };

  // 출근 기록 조회
  document.getElementById('btn-empOnOff-list').onclick = () => { window.location.href = "/onOffListPage"; };

  // 📅 버튼: 월 바로 이동
  document.getElementById('btn-datepick').onclick = () => {
    const picker = flatpickr(document.getElementById('btn-datepick'), {
      locale: 'ko',
      plugins: [new monthSelectPlugin({ shorthand: true, dateFormat: "Y-m", altFormat: "Y년 m월" })]
    });
    picker.open();
  };

  // ===== 높이 자동 =====
  function fitCalendarHeight() {
    const wrap = document.querySelector('.cal-wrap');
    if (!wrap) return;
    const top = wrap.getBoundingClientRect().top;
    const gap = 16;
    wrap.style.height = (window.innerHeight - top - gap) + 'px';
    calendar.updateSize();
  }
  window.addEventListener('resize', fitCalendarHeight);

  // 월 선택 플러그인
  function monthSelectPlugin(cfg) {
    return function(fp) {
      return {
        onReady() {
          fp.set('dateFormat', cfg?.dateFormat || 'Y-m');
          fp.set('altFormat',  cfg?.altFormat  || 'Y년 m월');
        },
        onChange(selectedDates) {
          if (!selectedDates?.[0]) return;
          const d = selectedDates[0];
          calendar.gotoDate(new Date(d.getFullYear(), d.getMonth(), 1));
          updateTitleBar();
          fitCalendarHeight();
          fp.close();
        }
      }
    }
  }

  function updateTitleBar(){
    const d = calendar.getDate();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    document.getElementById('titleBar').textContent = `${y}/${m}`;
  }

//===== 이벤트 로더: "출근 인원수" =====
  async function loadEvents(fetchInfo, success) {
    try {
      const res = await fetch(`/onoff?companyCode=${encodeURIComponent(COMPANY_CODE)}`);
      if (!res.ok) throw new Error('근태 목록을 불러오지 못했습니다.');
      const all = await res.json();

      const startMs = fetchInfo.start.getTime();
      const endMs   = fetchInfo.end.getTime();

      // 화면에 보이는 기간만 필터
      const rowsInRange = all.filter(r => {
        const t = new Date(r.onTime).getTime();
        return t >= startMs && t < endMs;
      });

      // 날짜별 출근 사원(중복 제거)
      const byDate = {};
      for (const r of rowsInRange) {
        const key = dateKeyFromISO(r.onTime);
        if (!byDate[key]) byDate[key] = new Set();
        byDate[key].add(r.empCode); // 같은 날 같은 사원 여러 건이어도 1회로 집계
      }

      // 이벤트 생성: "출근 N명"
      const events = Object.keys(byDate).map(k => {
        const total = byDate[k].size;
        return {
          start: k,
          title: `출근 ${total}명`,
          backgroundColor: '#e05239',
          borderColor: '#e05239'
        };
      });

      success(events);
    } catch (e) {
      console.error(e);
      success([]);
    }
  }
});
</script>

</body>
</html>
