<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/main}">
<head>
<meta charset="UTF-8">
<title>ì¶œí‡´ê·¼ ê¸°ë¡ë¶€</title>

<!-- FullCalendar -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/locales/ko.global.min.js"></script>

<!-- Flatpickr (ë‹¬ë ¥ ì•„ì´ì½˜ ëˆŒëŸ¬ì„œ íŠ¹ì • ì›” ë°”ë¡œ ì´ë™) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
 <link href="/hr/css/employee.css" rel="stylesheet" />
</head>
<body layout:fragment="content">
  <div id="layoutSidenav_content">
    <main>
      <div class="container-fluid px-4">
        <h1 class="mt-4">ì¶œ/í‡´ê·¼ ê¸°ë¡ë¶€</h1>

        <input type="hidden" id="companyCode" th:value="${#authentication.name.split(':')[0]}">

    	 <!-- ì´ë™/íƒ€ì´í‹€ ì¤„ -->
		<div id="cal-header" class="d-flex align-items-center gap-2 position-relative mb-2">
		  <!-- ì¢Œì¸¡: ì´ë™ ë²„íŠ¼ -->
		  <div class="d-flex gap-2">
		    <button class="btn btn-outline-secondary" id="btn-prev">ì´ì „</button>
		    <button class="btn btn-warning" id="btn-today">ì˜¤ëŠ˜</button>
		    <button class="btn btn-outline-secondary" id="btn-next">ë‹¤ìŒ</button>
		    <button class="btn btn-outline-secondary" id="btn-datepick" title="ë‚ ì§œ ì´ë™">
		      <span class="cal-icon">ğŸ“…</span>
		    </button>
		  </div>

		  <!-- ì¤‘ì•™: íƒ€ì´í‹€ -->
		  <div id="titleBar" class="fw-semibold text-muted"></div>

		  <!-- ìš°ì¸¡: ì‹ ê·œ/ì¡°íšŒ ë²„íŠ¼ -->
		  <div class="ms-auto d-flex gap-2">
		    <button id="btn-empOnOff-new" class="btn btn-primary">ì‹ ê·œ</button>
		    <button id="btn-empOnOff-list" class="btn btn-success">ì¶œê·¼ ê¸°ë¡ ì¡°íšŒ</button>
		  </div>
		</div>

        <!-- âœ… ë‹¬ë ¥ë§Œ cal-wrapë¡œ ê°ì‹¸ì„œ ë†’ì´ ìë™ë§ì¶¤ -->
        <div class="cal-wrap">
          <div id="calendar"></div>
        </div>
      </div>
    </main>
  </div>

  <!-- ì‹ ê·œ ë²„íŠ¼ -> ì‚¬ì› ì¶œí‡´ê·¼ ê¸°ë¡ ëª¨ë‹¬  -->
<div th:replace="~{hr/empOnOff :: OnOffModal}"></div>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  const calendarEl = document.getElementById('calendar');
  const COMPANY_CODE = document.getElementById('companyCode')?.value || '';

  // ===== ìœ í‹¸ =====
  const dateKey = d => {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  };
  const dateKeyFromISO = iso => dateKey(new Date(iso));

  // ===== FullCalendar =====
  const calendar = new FullCalendar.Calendar(calendarEl, {
    locale: 'ko',
    initialView: 'dayGridMonth',
    firstDay: 0,
    height: '100%',
    expandRows: true,
    dayMaxEventRows: 3,
    headerToolbar: false,
    titleFormat: { year: 'numeric', month: '2-digit' },
    dayCellContent(info) { return String(info.date.getDate()); }, // ìˆ«ìë§Œ
    events: loadEvents,
    dateClick: () => {},                 // âœ… ë‚ ì§œ í´ë¦­ ë¬´ë°˜ì‘
    eventClick(info) {}
  });

  calendar.render();
  updateTitleBar();
  fitCalendarHeight();

  // ===== íˆ´ë°” =====
  document.getElementById('btn-prev').onclick  = () => { calendar.prev();  updateTitleBar(); fitCalendarHeight(); };
  document.getElementById('btn-next').onclick  = () => { calendar.next();  updateTitleBar(); fitCalendarHeight(); };
  document.getElementById('btn-today').onclick = () => { calendar.today(); updateTitleBar(); fitCalendarHeight(); };

  const btnMonth = document.getElementById('btn-month');
  const btnList  = document.getElementById('btn-list');
  if (btnMonth) btnMonth.onclick = () => { calendar.changeView('dayGridMonth'); updateTitleBar(); fitCalendarHeight(); };
  if (btnList)  btnList.onclick  = () => { calendar.changeView('listMonth');    updateTitleBar(); fitCalendarHeight(); };

  // ì‹ ê·œ ë²„íŠ¼ â†’ ëª¨ë‹¬ ì—´ê¸°
  const OnOffModal = () => new bootstrap.Modal(document.getElementById('OnOffModal'));
  document.getElementById('btn-empOnOff-new').onclick = () => { OnOffModal().show(); };

  // ì¶œê·¼ ê¸°ë¡ ì¡°íšŒ
  document.getElementById('btn-empOnOff-list').onclick = () => { window.location.href = "/onOffListPage"; };

  // ğŸ“… ë²„íŠ¼: ì›” ë°”ë¡œ ì´ë™
  document.getElementById('btn-datepick').onclick = () => {
    const picker = flatpickr(document.getElementById('btn-datepick'), {
      locale: 'ko',
      plugins: [new monthSelectPlugin({ shorthand: true, dateFormat: "Y-m", altFormat: "Yë…„ mì›”" })]
    });
    picker.open();
  };

  // ===== ë†’ì´ ìë™ =====
  function fitCalendarHeight() {
    const wrap = document.querySelector('.cal-wrap');
    if (!wrap) return;
    const top = wrap.getBoundingClientRect().top;
    const gap = 16;
    wrap.style.height = (window.innerHeight - top - gap) + 'px';
    calendar.updateSize();
  }
  window.addEventListener('resize', fitCalendarHeight);

  // ì›” ì„ íƒ í”ŒëŸ¬ê·¸ì¸
  function monthSelectPlugin(cfg) {
    return function(fp) {
      return {
        onReady() {
          fp.set('dateFormat', cfg?.dateFormat || 'Y-m');
          fp.set('altFormat',  cfg?.altFormat  || 'Yë…„ mì›”');
        },
        onChange(selectedDates) {
          if (!selectedDates?.[0]) return;
          const d = selectedDates[0];
          calendar.gotoDate(new Date(d.getFullYear(), d.getMonth(), 1));
          updateTitleBar();
          fitCalendarHeight();
          fp.close();
        }
      }
    }
  }

  function updateTitleBar(){
    const d = calendar.getDate();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    document.getElementById('titleBar').textContent = `${y}/${m}`;
  }

//===== ì´ë²¤íŠ¸ ë¡œë”: "ì¶œê·¼ ì¸ì›ìˆ˜" =====
  async function loadEvents(fetchInfo, success) {
    try {
      const res = await fetch(`/onoff?companyCode=${encodeURIComponent(COMPANY_CODE)}`);
      if (!res.ok) throw new Error('ê·¼íƒœ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      const all = await res.json();

      const startMs = fetchInfo.start.getTime();
      const endMs   = fetchInfo.end.getTime();

      // í™”ë©´ì— ë³´ì´ëŠ” ê¸°ê°„ë§Œ í•„í„°
      const rowsInRange = all.filter(r => {
        const t = new Date(r.onTime).getTime();
        return t >= startMs && t < endMs;
      });

      // ë‚ ì§œë³„ ì¶œê·¼ ì‚¬ì›(ì¤‘ë³µ ì œê±°)
      const byDate = {};
      for (const r of rowsInRange) {
        const key = dateKeyFromISO(r.onTime);
        if (!byDate[key]) byDate[key] = new Set();
        byDate[key].add(r.empCode); // ê°™ì€ ë‚  ê°™ì€ ì‚¬ì› ì—¬ëŸ¬ ê±´ì´ì–´ë„ 1íšŒë¡œ ì§‘ê³„
      }

      // ì´ë²¤íŠ¸ ìƒì„±: "ì¶œê·¼ Nëª…"
      const events = Object.keys(byDate).map(k => {
        const total = byDate[k].size;
        return {
          start: k,
          title: `ì¶œê·¼ ${total}ëª…`,
          backgroundColor: '#e05239',
          borderColor: '#e05239'
        };
      });

      success(events);
    } catch (e) {
      console.error(e);
      success([]);
    }
  }
});
</script>

</body>
</html>
