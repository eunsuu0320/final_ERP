<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/main}">
<head>
<meta charset="UTF-8">
<title>ì¶œí‡´ê·¼ ê¸°ë¡ë¶€</title>

<!-- FullCalendar -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/locales/ko.global.min.js"></script>

<!-- Flatpickr (ë‹¬ë ¥ ì•„ì´ì½˜ ëˆŒëŸ¬ì„œ íŠ¹ì • ì›” ë°”ë¡œ ì´ë™) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
 <link href="/hr/css/employee.css" rel="stylesheet" />
</head>
<body layout:fragment="content">
  <div id="layoutSidenav_content">
    <main>
      <div class="container-fluid px-4">
        <h1 class="mt-4">ì¶œ/í‡´ê·¼ ê¸°ë¡ë¶€</h1>

        <input type="hidden" id="companyCode" th:value="${#authentication.name.split(':')[0]}">

    	 <!-- ì´ë™/íƒ€ì´í‹€ ì¤„ -->
		<div id="cal-header" class="d-flex align-items-center gap-2 position-relative mb-2">
		  <!-- ì¢Œì¸¡: ì´ë™ ë²„íŠ¼ -->
		  <div class="d-flex gap-2">
		    <button class="btn btn-outline-secondary" id="btn-prev">ì´ì „</button>
		    <button class="btn btn-warning" id="btn-today">ì˜¤ëŠ˜</button>
		    <button class="btn btn-outline-secondary" id="btn-next">ë‹¤ìŒ</button>
		    <button class="btn btn-outline-secondary" id="btn-datepick" title="ë‚ ì§œ ì´ë™">
		      <span class="cal-icon">ğŸ“…</span>
		    </button>
		  </div>

		  <!-- ì¤‘ì•™: íƒ€ì´í‹€ -->
		  <div id="titleBar" class="fw-semibold text-muted"></div>

		  <!-- ìš°ì¸¡: ì‹ ê·œ/ì¡°íšŒ ë²„íŠ¼ -->
		  <div class="ms-auto d-flex gap-2">
		    <button id="btn-empOnOff-new" class="btn btn-primary">ì‹ ê·œ</button>
		    <button id="btn-empOnOff-list" class="btn btn-success">ì¶œê·¼ ê¸°ë¡ ì¡°íšŒ</button>
		  </div>
		</div>

        <!-- âœ… ë‹¬ë ¥ë§Œ cal-wrapë¡œ ê°ì‹¸ì„œ ë†’ì´ ìë™ë§ì¶¤ -->
        <div class="cal-wrap">
          <div id="calendar"></div>
        </div>
      </div>
    </main>
  </div>

  <!-- ì‹ ê·œ ë²„íŠ¼ -> ì‚¬ì› ì¶œí‡´ê·¼ ê¸°ë¡ ëª¨ë‹¬  -->
<div th:replace="~{hr/empOnOff :: OnOffModal}"></div>
<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const calendarEl = document.getElementById('calendar');

    // FullCalendar ìƒì„±
    const calendar = new FullCalendar.Calendar(calendarEl, {
      locale: 'ko',
      initialView: 'dayGridMonth',
      firstDay: 0,
      height: '100%',

      dayCellContent(info) {
    	    return String(info.date.getDate()); // ìˆ«ìë§Œ
    	  },

      expandRows: true,
      dayMaxEventRows: 3,
      headerToolbar: false,
      titleFormat: { year: 'numeric', month: '2-digit' },
      events: loadEvents,
      dateClick(info) { openCreateModal(info.dateStr); },
      eventClick(info) { alert(`[ìƒì„¸]\në‚ ì§œ: ${info.event.startStr}\nì œëª©: ${info.event.title}`); }
    });

    calendar.render();
    updateTitleBar();

    // ===== íˆ´ë°” ë™ì‘ =====
    document.getElementById('btn-prev').onclick = () => { calendar.prev(); updateTitleBar(); fitCalendarHeight(); };
    document.getElementById('btn-next').onclick = () => { calendar.next(); updateTitleBar(); fitCalendarHeight(); };
    document.getElementById('btn-today').onclick = () => { calendar.today(); updateTitleBar(); fitCalendarHeight(); };

    // ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë²„íŠ¼ ì•ˆì „ ì²˜ë¦¬(ìˆì„ ê²½ìš°ë§Œ ë°”ì¸ë”©)
    const btnMonth = document.getElementById('btn-month');
    const btnList  = document.getElementById('btn-list');
    if (btnMonth) btnMonth.onclick = () => { calendar.changeView('dayGridMonth'); updateTitleBar(); fitCalendarHeight(); };
    if (btnList)  btnList.onclick  = () => { calendar.changeView('listMonth');    updateTitleBar(); fitCalendarHeight(); };

 // DOMContentLoaded ë‚´ë¶€
    const OnOffModal = () => new bootstrap.Modal(document.getElementById('OnOffModal'));

    document.getElementById('btn-empOnOff-new').onclick = () => {
      // í•„ìš”í•œ ê°’ ì„¸íŒ… í›„
      OnOffModal().show();
    };

    function openCreateModal(dateStr){
      // í•„ìš”í•œ ê°’ ì„¸íŒ… í›„
      OnOffModal().show();
    }

    // ì¶œê·¼ ê¸°ë¡ ì¡°íšŒ ë²„íŠ¼
    document.getElementById("btn-empOnOff-list").onclick = () => {
    	 window.location.href = "/onOffListPage";
    }

    // ğŸ“… ì•„ì´ì½˜: ì›”/ì—°ë„ ë°”ë¡œ ì´ë™
    document.getElementById('btn-datepick').onclick = () => {
      const picker = flatpickr(document.getElementById('btn-datepick'), {
        locale: 'ko',
        plugins: [new monthSelectPlugin({ shorthand: true, dateFormat: "Y-m", altFormat: "Yë…„ mì›”" })]
      });
      picker.open();
    };

    // âœ… í™”ë©´ ë†’ì´ì— ë§ì¶° cal-wrap ë†’ì´ë¥¼ ê³„ì‚°/ì ìš©
    function fitCalendarHeight() {
      const wrap = document.querySelector('.cal-wrap');
      if (!wrap) return;
      const top = wrap.getBoundingClientRect().top; // ë˜í¼ì˜ í™”ë©´ìƒ Y
      const gap = 16;                                // í•˜ë‹¨ ì—¬ë°±
      wrap.style.height = (window.innerHeight - top - gap) + 'px';
      calendar.updateSize();                         // FullCalendar ì¬ê³„ì‚°
    }
    window.addEventListener('resize', fitCalendarHeight);
    // ì´ˆê¸° 1íšŒ ì ìš©
    fitCalendarHeight();

    // Flatpickr ì›” ì„ íƒ í”ŒëŸ¬ê·¸ì¸(ê°„ë‹¨ êµ¬í˜„)
    function monthSelectPlugin(cfg) {
      return function(fp) {
        return {
          onReady() {
            fp.set('dateFormat', cfg?.dateFormat || 'Y-m');
            fp.set('altFormat',  cfg?.altFormat  || 'Yë…„ mì›”');
          },
          onChange(selectedDates) {
            if (!selectedDates?.[0]) return;
            // í•´ë‹¹ ì›”ì˜ 1ì¼ë¡œ ì´ë™
            const d = selectedDates[0];
            calendar.gotoDate(new Date(d.getFullYear(), d.getMonth(), 1));
            updateTitleBar();
            fitCalendarHeight();
            fp.close();
          }
        }
      }
    }

    function updateTitleBar(){
      const d = calendar.getDate();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      document.getElementById('titleBar').textContent = `${y}/${m}`;
    }

    // ===== ì˜ˆì‹œ: ì´ë²¤íŠ¸ ë¡œë”© =====
    async function loadEvents(fetchInfo, success) {
      const y = fetchInfo.start.getFullYear();
      const m = String(fetchInfo.start.getMonth()+1).padStart(2,'0');
      const events = [
        { start: `${y}-${m}-09`, title: '10(7 + 3)', color: '#e05239' },
      ];
      success(events);
    }

    function openCreateModal(dateStr){
      alert(`[ì‹ ê·œ ë“±ë¡]\nê¸°ì¤€ì¼: ${dateStr}`);
    }
  });
</script>
</body>
</html>
