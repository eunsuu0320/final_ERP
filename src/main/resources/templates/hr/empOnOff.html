<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
	<!-- templates/hr/empOnOffModal.html -->
	<div th:fragment="OnOffModal">
		<div class="modal fade" id="OnOffModal" tabindex="-1"
			aria-hidden="true">
			<div class="modal-dialog modal-lg modal-dialog-centered">
				<div class="modal-content">

				<input type="hidden" id="companyCode" th:value="${#authentication.name.split(':')[0]}">

					<!-- ë°”ë”” -->
					<div class="modal-body">
						<!-- ìƒë‹¨ í˜„ì¬ ì‹œê°(ë°°ì§€ ì œê±°) -->
						<div class="text-center mb-3">
							<span id="onoff-now"
								class="fs-4 fw-bold text-primary align-middle">--:--:--</span>
						</div>

						<form id="onoff-form" class="needs-validation" novalidate>
							<!-- ì‚¬ì› -->
							<div class="row g-3 align-items-center mb-2">
								<label class="col-12 col-sm-2 col-form-label"> ì‚¬ì›</label>
								<div class="col-12 col-sm-10">
									<div class="input-group">
										<input id="onoff-emp" type="text" class="form-control"
											placeholder="ì‚¬ì›ëª…/ì‚¬ë²ˆ" required>
										<button class="btn btn-outline-secondary" type="button"
											id="onoff-emp-search" title="ì‚¬ì› ê²€ìƒ‰">ğŸ”</button>
									</div>
									<input type="hidden" id="onoff-empCode" name="empCode">
									<div class="invalid-feedback">ì‚¬ì›ì„ ì…ë ¥í•˜ì„¸ìš”.</div>
								</div>
							</div>

							<!-- ì¥ì†Œ + ì™¸ê·¼ -->
							<div class="row g-3 align-items-center mb-2">
								<label class="col-12 col-sm-2 col-form-label"> ì¥ì†Œ</label>
								<div class="col-12 col-sm-7">
									<input id="onoff-place" type="text" class="form-control"
										placeholder="ê·¼ë¬´ ì¥ì†Œ">
								</div>
								<div class="col-12 col-sm-3">
									<div class="form-check">
										<input class="form-check-input" type="checkbox"
											id="onoff-outside"> <label class="form-check-label"
											for="onoff-outside">ì™¸ê·¼</label>
									</div>
								</div>
							</div>

							<!-- ë‚ ì§œ/ì‹œê°„ (ì»´íŒ©íŠ¸ + ì˜¤ë¥¸ìª½ â€˜ì˜¤ì „ ë°˜ì°¨â€™ ë“¤ì–´ê°€ê²Œ) -->
							<div class="row g-2 align-items-center mb-2">
								<label class="col-12 col-sm-2 col-form-label">ì‹œê°„</label>

								<div class="col-auto">
									<input id="onoff-yy" type="text" inputmode="numeric"
										class="form-control text-center" placeholder="ë…„"
										style="width: 88px;">
								</div>
								<div class="col-auto">
									<input id="onoff-mm" type="text" inputmode="numeric"
										class="form-control text-center" placeholder="ì›”"
										style="width: 60px;">
								</div>
								<div class="col-auto">
									<input id="onoff-dd" type="text" inputmode="numeric"
										class="form-control text-center" placeholder="ì¼"
										style="width: 60px;">
								</div>

								<div class="col-auto">
									<button type="button" class="btn btn-outline-secondary"
										id="btn-onoff-datepick" title="ë‚ ì§œ ì´ë™">ğŸ“…</button>
									<input type="text" id="onoff-month-anchor" class="d-none">
								</div>

								<div class="col-auto">
									<input id="onoff-hh" type="text" inputmode="numeric"
										class="form-control text-center" placeholder="ì‹œê°„"
										style="width: 72px;">
								</div>
								<div class="col-auto">
									<input id="onoff-mi" type="text" inputmode="numeric"
										class="form-control text-center" placeholder="ë¶„"
										style="width: 60px;">
								</div>

								<div class="col-auto ms-2">
									<div class="form-check">
										<input class="form-check-input" type="checkbox"
											id="onoff-amhalf"> <label class="form-check-label"
											for="onoff-amhalf">ì˜¤ì „ ë°˜ì°¨</label>
									</div>
								</div>
							</div>

							<!-- ì‚¬ìœ  -->
							<div class="row g-3 align-items-center mb-3">
								<label class="col-12 col-sm-2 col-form-label">ì‚¬ìœ </label>
								<div class="col-12 col-sm-10">
									<input id="onoff-reason" type="text" class="form-control"
										placeholder="ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
								</div>
							</div>

							<!-- ì•¡ì…˜ -->
							<div class="d-grid d-sm-flex justify-content-sm-center">
								<button type="button" id="btn-on" class="btn btn-primary px-4" style="margin-right: 0.2rem;">ì¶œê·¼</button>
								<button type="button" id="btn-off" class="btn btn-danger px-4">í‡´ê·¼</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>

		<div th:replace="common/modal :: commonModal"></div>

		<!-- ëª¨ë‹¬ ë‚´ë¶€ ìŠ¤í¬ë¦½íŠ¸ -->
		<script th:inline="javascript">
(() => {
  const modalEl = document.getElementById('OnOffModal');
  if (!modalEl) return;

  // ===== ì„±ê³µ ì‹œ: ëª¨ë‹¬ ë‹«ê³  ìƒˆë¡œê³ ì¹¨ =====
  function closeModalAndReload() {
    const inst = bootstrap.Modal.getOrCreateInstance(modalEl);
    modalEl.addEventListener('hidden.bs.modal', () => { location.reload(); }, { once: true });
    inst.hide();
  }

  // ì‹œê³„
  let clockTimer = null;
  function startClock() {
    const tick = () => {
      const nowEl = document.getElementById('onoff-now');
      if (!nowEl) return;
      const d = new Date();
      let h = d.getHours();
      const ampm = h < 12 ? 'ì˜¤ì „' : 'ì˜¤í›„';
      h = (h % 12) || 12;
      const mm = String(d.getMinutes()).padStart(2, '0');
      const ss = String(d.getSeconds()).padStart(2, '0');
      nowEl.textContent = `${ampm} ${String(h).padStart(2,'0')}:${mm}:${ss}`;
    };
    tick();
    clockTimer = setInterval(tick, 1000);
  }
  function stopClock(){ if (clockTimer) clearInterval(clockTimer); }

  // í˜„ì¬ ì‹œê° ì…ë ¥ ì±„ìš°ê¸°
  function fillNow() {
    const d = new Date();
    const pad2 = n => String(n).padStart(2,'0');
    const set = (id,val)=>{ const el=document.getElementById(id); if(el) el.value=val; };
    set('onoff-yy', d.getFullYear());
    set('onoff-mm', pad2(d.getMonth()+1));
    set('onoff-dd', pad2(d.getDate()));
    set('onoff-hh', pad2(d.getHours()));
    set('onoff-mi', pad2(d.getMinutes()));
  }

  // ì›” ì„ íƒ(Flatpickr)
  let monthPicker = null;
  function openMonthPicker() {
    const dateBtnEl = modalEl.querySelector('#btn-onoff-datepick');
    if (!dateBtnEl) return;

    let anchorEl = modalEl.querySelector('#onoff-month-anchor');
    if (!anchorEl) {
      anchorEl = document.createElement('input');
      anchorEl.type = 'text';
      anchorEl.id = 'onoff-month-anchor';
      anchorEl.className = 'd-none';
      modalEl.appendChild(anchorEl);
    }

    if (!monthPicker) {
      monthPicker = flatpickr(anchorEl, {
        locale: 'ko',
        clickOpens: false,
        appendTo: modalEl,
        positionElement: dateBtnEl,
        onChange([d]) {
          if (!d) return;
          const set = (id,val)=>{ const el=document.getElementById(id); if(el) el.value=val; };
          set('onoff-yy', d.getFullYear());
          set('onoff-mm', String(d.getMonth() + 1).padStart(2,'0'));
          set('onoff-dd', '01');
          monthPicker.close();
        },
      });
    } else {
      monthPicker.set('positionElement', dateBtnEl);
    }

    const base = new Date(
      Number(document.getElementById('onoff-yy')?.value) || new Date().getFullYear(),
      ((Number(document.getElementById('onoff-mm')?.value) || (new Date().getMonth()+1)) - 1),
      Number(document.getElementById('onoff-dd')?.value) || 1
    );
    monthPicker.setDate(base, false);
    monthPicker.open();
  }

  // ëª¨ë‹¬ í‘œì‹œ/ìˆ¨ê¹€
  modalEl.addEventListener('shown.bs.modal', () => { startClock(); fillNow(); });
  modalEl.addEventListener('hidden.bs.modal', () => { stopClock(); });

  // ë‚ ì§œ ë²„íŠ¼
  modalEl.addEventListener('click', (e) => {
    if (e.target.closest('#btn-onoff-datepick')) openMonthPicker();
  });

  // ì‚¬ì› ì„ íƒ(ë‹ë³´ê¸°)
  document.getElementById('onoff-emp-search').addEventListener('click', () => {
    openModal("employee", (selected) => {
      if (!selected) return;
      const empInput = document.getElementById('onoff-emp');
      const empCodeHidden = document.getElementById('onoff-empCode');
      if (empInput) empInput.value = selected.name;              // í‘œì‹œìš©
      if (empCodeHidden) empCodeHidden.value = selected.empCode; // ì „ì†¡ìš©
    });
  });

  // CSRF
  const token = document.querySelector('meta[name="_csrf"]').content;

  // ===== ì¶œê·¼ ë²„íŠ¼ =====
  document.getElementById('btn-on').addEventListener('click', async () => {
    try {
      const companyCode = document.getElementById('companyCode')?.value;
      const empCode     = document.getElementById('onoff-empCode')?.value;
      const place       = document.getElementById('onoff-place')?.value?.trim();
      const isOutside   = document.getElementById('onoff-outside')?.checked;

      if (!empCode) throw new Error('ì‚¬ì›ì„ ì„ íƒí•˜ì„¸ìš”.');
      if (!place)   throw new Error('ì¥ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

      const yy = document.getElementById('onoff-yy')?.value?.trim();
      const mm = String(document.getElementById('onoff-mm')?.value || '').padStart(2,'0');
      const dd = String(document.getElementById('onoff-dd')?.value || '').padStart(2,'0');
      const hh = String(document.getElementById('onoff-hh')?.value || '').padStart(2,'0');
      const mi = String(document.getElementById('onoff-mi')?.value || '').padStart(2,'0');
      if (!yy || !mm || !dd || !hh || !mi) throw new Error('ì‹œê°„(ë…„/ì›”/ì¼/ì‹œ/ë¶„)ì„ í™•ì¸í•˜ì„¸ìš”.');

      const onTime = `${yy}-${mm}-${dd}T${hh}:${mi}:00`;
      const payload = {
        companyCode,
        empCode,
        place,
        comIs: isOutside ? 'OUT' : 'IN',
        onTime,
        note: document.getElementById('onoff-reason')?.value || ''
      };

      const res = await fetch('/onoff/on', {
        method: 'POST',
        headers: { "Content-Type": "application/json", "X-CSRF-Token": token },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error((await res.text()) || 'ì¶œê·¼ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

      alert('ì¶œê·¼í•˜ì˜€ìŠµë‹ˆë‹¤.');
      closeModalAndReload();
    } catch (err) {
      console.error(err);
      alert(err.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  });

  // ===== í‡´ê·¼ ë²„íŠ¼ =====
  document.getElementById('btn-off').addEventListener('click', async () => {
    try {
      const companyCode = document.getElementById('companyCode')?.value;
      const empCode     = document.getElementById('onoff-empCode')?.value;
      if (!empCode) throw new Error('ì‚¬ì›ì„ ì„ íƒí•˜ì„¸ìš”.');

      const yy = document.getElementById('onoff-yy')?.value?.trim();
      const mm = String(document.getElementById('onoff-mm')?.value || '').padStart(2,'0');
      const dd = String(document.getElementById('onoff-dd')?.value || '').padStart(2,'0');
      const hh = String(document.getElementById('onoff-hh')?.value || '').padStart(2,'0');
      const mi = String(document.getElementById('onoff-mi')?.value || '').padStart(2,'0');
      if (!yy || !mm || !dd || !hh || !mi) throw new Error('ì‹œê°„(ë…„/ì›”/ì¼/ì‹œ/ë¶„)ì„ í™•ì¸í•˜ì„¸ìš”.');

      const offTime = `${yy}-${mm}-${dd}T${hh}:${mi}:00`;

      const res = await fetch('/onoff/off', {
        method: 'POST',
        headers: { "Content-Type": "application/json", "X-CSRF-Token": token },
        body: JSON.stringify({ companyCode, empCode, offTime })
      });

      const text = await res.text();
      let payload; try { payload = JSON.parse(text); } catch { payload = { message: text }; }
      if (!res.ok) throw new Error(payload?.message || 'í‡´ê·¼ ë“±ë¡ ì‹¤íŒ¨');

      alert('í‡´ê·¼í•˜ì˜€ìŠµë‹ˆë‹¤.');
      closeModalAndReload();
    } catch (err) {
      console.error(err);
      alert(err.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  });

  // ì´ˆê¸° 1íšŒ
  fillNow();
})();
</script>
	</div>
</body>
</html>