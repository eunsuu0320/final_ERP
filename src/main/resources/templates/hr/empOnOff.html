<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
	<!-- templates/hr/empOnOffModal.html -->
	<div th:fragment="OnOffModal">
		<div class="modal fade" id="OnOffModal" tabindex="-1"
			aria-hidden="true">
			<div class="modal-dialog modal-lg modal-dialog-centered">
				<div class="modal-content">

				<input type="hidden" id="companyCode" th:value="${#authentication.name.split(':')[0]}">

					<!-- 바디 -->
					<div class="modal-body">
						<!-- 상단 현재 시각(배지 제거) -->
						<div class="text-center mb-3">
							<span id="onoff-now"
								class="fs-4 fw-bold text-primary align-middle">--:--:--</span>
						</div>

						<form id="onoff-form" class="needs-validation" novalidate>
							<!-- 사원 -->
							<div class="row g-3 align-items-center mb-2">
								<label class="col-12 col-sm-2 col-form-label"> 사원</label>
								<div class="col-12 col-sm-10">
									<div class="input-group">
										<input id="onoff-emp" type="text" class="form-control"
											placeholder="사원명/사번" required>
										<button class="btn btn-outline-secondary" type="button"
											id="onoff-emp-search" title="사원 검색">🔍</button>
									</div>
									<input type="hidden" id="onoff-empCode" name="empCode">
									<div class="invalid-feedback">사원을 입력하세요.</div>
								</div>
							</div>

							<!-- 장소 + 외근 -->
							<div class="row g-3 align-items-center mb-2">
								<label class="col-12 col-sm-2 col-form-label"> 장소</label>
								<div class="col-12 col-sm-7">
									<input id="onoff-place" type="text" class="form-control"
										placeholder="근무 장소">
								</div>
								<div class="col-12 col-sm-3">
									<div class="form-check">
										<input class="form-check-input" type="checkbox"
											id="onoff-outside"> <label class="form-check-label"
											for="onoff-outside">외근</label>
									</div>
								</div>
							</div>

							<!-- 날짜/시간 (컴팩트 + 오른쪽 ‘오전 반차’ 들어가게) -->
							<div class="row g-2 align-items-center mb-2">
								<label class="col-12 col-sm-2 col-form-label">시간</label>

								<div class="col-auto">
									<input id="onoff-yy" type="text" inputmode="numeric"
										class="form-control text-center" placeholder="년"
										style="width: 88px;">
								</div>
								<div class="col-auto">
									<input id="onoff-mm" type="text" inputmode="numeric"
										class="form-control text-center" placeholder="월"
										style="width: 60px;">
								</div>
								<div class="col-auto">
									<input id="onoff-dd" type="text" inputmode="numeric"
										class="form-control text-center" placeholder="일"
										style="width: 60px;">
								</div>

								<div class="col-auto">
									<button type="button" class="btn btn-outline-secondary"
										id="btn-onoff-datepick" title="날짜 이동">📅</button>
									<input type="text" id="onoff-month-anchor" class="d-none">
								</div>

								<div class="col-auto">
									<input id="onoff-hh" type="text" inputmode="numeric"
										class="form-control text-center" placeholder="시간"
										style="width: 72px;">
								</div>
								<div class="col-auto">
									<input id="onoff-mi" type="text" inputmode="numeric"
										class="form-control text-center" placeholder="분"
										style="width: 60px;">
								</div>

								<div class="col-auto ms-2">
									<div class="form-check">
										<input class="form-check-input" type="checkbox"
											id="onoff-amhalf"> <label class="form-check-label"
											for="onoff-amhalf">오전 반차</label>
									</div>
								</div>
							</div>

							<!-- 사유 -->
							<div class="row g-3 align-items-center mb-3">
								<label class="col-12 col-sm-2 col-form-label">사유</label>
								<div class="col-12 col-sm-10">
									<input id="onoff-reason" type="text" class="form-control"
										placeholder="사유를 입력하세요">
								</div>
							</div>

							<!-- 액션 -->
							<div class="d-grid d-sm-flex justify-content-sm-center">
								<button type="button" id="btn-on" class="btn btn-primary px-4" style="margin-right: 0.2rem;">출근</button>
								<button type="button" id="btn-off" class="btn btn-danger px-4">퇴근</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>

		<div th:replace="common/modal :: commonModal"></div>

		<!-- 모달 내부 스크립트 -->
		<script th:inline="javascript">
(() => {
  const modalEl = document.getElementById('OnOffModal');
  if (!modalEl) return;

  // ===== 성공 시: 모달 닫고 새로고침 =====
  function closeModalAndReload() {
    const inst = bootstrap.Modal.getOrCreateInstance(modalEl);
    modalEl.addEventListener('hidden.bs.modal', () => { location.reload(); }, { once: true });
    inst.hide();
  }

  // 시계
  let clockTimer = null;
  function startClock() {
    const tick = () => {
      const nowEl = document.getElementById('onoff-now');
      if (!nowEl) return;
      const d = new Date();
      let h = d.getHours();
      const ampm = h < 12 ? '오전' : '오후';
      h = (h % 12) || 12;
      const mm = String(d.getMinutes()).padStart(2, '0');
      const ss = String(d.getSeconds()).padStart(2, '0');
      nowEl.textContent = `${ampm} ${String(h).padStart(2,'0')}:${mm}:${ss}`;
    };
    tick();
    clockTimer = setInterval(tick, 1000);
  }
  function stopClock(){ if (clockTimer) clearInterval(clockTimer); }

  // 현재 시각 입력 채우기
  function fillNow() {
    const d = new Date();
    const pad2 = n => String(n).padStart(2,'0');
    const set = (id,val)=>{ const el=document.getElementById(id); if(el) el.value=val; };
    set('onoff-yy', d.getFullYear());
    set('onoff-mm', pad2(d.getMonth()+1));
    set('onoff-dd', pad2(d.getDate()));
    set('onoff-hh', pad2(d.getHours()));
    set('onoff-mi', pad2(d.getMinutes()));
  }

  // 월 선택(Flatpickr)
  let monthPicker = null;
  function openMonthPicker() {
    const dateBtnEl = modalEl.querySelector('#btn-onoff-datepick');
    if (!dateBtnEl) return;

    let anchorEl = modalEl.querySelector('#onoff-month-anchor');
    if (!anchorEl) {
      anchorEl = document.createElement('input');
      anchorEl.type = 'text';
      anchorEl.id = 'onoff-month-anchor';
      anchorEl.className = 'd-none';
      modalEl.appendChild(anchorEl);
    }

    if (!monthPicker) {
      monthPicker = flatpickr(anchorEl, {
        locale: 'ko',
        clickOpens: false,
        appendTo: modalEl,
        positionElement: dateBtnEl,
        onChange([d]) {
          if (!d) return;
          const set = (id,val)=>{ const el=document.getElementById(id); if(el) el.value=val; };
          set('onoff-yy', d.getFullYear());
          set('onoff-mm', String(d.getMonth() + 1).padStart(2,'0'));
          set('onoff-dd', '01');
          monthPicker.close();
        },
      });
    } else {
      monthPicker.set('positionElement', dateBtnEl);
    }

    const base = new Date(
      Number(document.getElementById('onoff-yy')?.value) || new Date().getFullYear(),
      ((Number(document.getElementById('onoff-mm')?.value) || (new Date().getMonth()+1)) - 1),
      Number(document.getElementById('onoff-dd')?.value) || 1
    );
    monthPicker.setDate(base, false);
    monthPicker.open();
  }

  // 모달 표시/숨김
  modalEl.addEventListener('shown.bs.modal', () => { startClock(); fillNow(); });
  modalEl.addEventListener('hidden.bs.modal', () => { stopClock(); });

  // 날짜 버튼
  modalEl.addEventListener('click', (e) => {
    if (e.target.closest('#btn-onoff-datepick')) openMonthPicker();
  });

  // 사원 선택(돋보기)
  document.getElementById('onoff-emp-search').addEventListener('click', () => {
    openModal("employee", (selected) => {
      if (!selected) return;
      const empInput = document.getElementById('onoff-emp');
      const empCodeHidden = document.getElementById('onoff-empCode');
      if (empInput) empInput.value = selected.name;              // 표시용
      if (empCodeHidden) empCodeHidden.value = selected.empCode; // 전송용
    });
  });

  // CSRF
  const token = document.querySelector('meta[name="_csrf"]').content;

  // ===== 출근 버튼 =====
  document.getElementById('btn-on').addEventListener('click', async () => {
    try {
      const companyCode = document.getElementById('companyCode')?.value;
      const empCode     = document.getElementById('onoff-empCode')?.value;
      const place       = document.getElementById('onoff-place')?.value?.trim();
      const isOutside   = document.getElementById('onoff-outside')?.checked;

      if (!empCode) throw new Error('사원을 선택하세요.');
      if (!place)   throw new Error('장소를 입력하세요.');

      const yy = document.getElementById('onoff-yy')?.value?.trim();
      const mm = String(document.getElementById('onoff-mm')?.value || '').padStart(2,'0');
      const dd = String(document.getElementById('onoff-dd')?.value || '').padStart(2,'0');
      const hh = String(document.getElementById('onoff-hh')?.value || '').padStart(2,'0');
      const mi = String(document.getElementById('onoff-mi')?.value || '').padStart(2,'0');
      if (!yy || !mm || !dd || !hh || !mi) throw new Error('시간(년/월/일/시/분)을 확인하세요.');

      const onTime = `${yy}-${mm}-${dd}T${hh}:${mi}:00`;
      const payload = {
        companyCode,
        empCode,
        place,
        comIs: isOutside ? 'OUT' : 'IN',
        onTime,
        note: document.getElementById('onoff-reason')?.value || ''
      };

      const res = await fetch('/onoff/on', {
        method: 'POST',
        headers: { "Content-Type": "application/json", "X-CSRF-Token": token },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error((await res.text()) || '출근 등록에 실패했습니다.');

      alert('출근하였습니다.');
      closeModalAndReload();
    } catch (err) {
      console.error(err);
      alert(err.message || '오류가 발생했습니다.');
    }
  });

  // ===== 퇴근 버튼 =====
  document.getElementById('btn-off').addEventListener('click', async () => {
    try {
      const companyCode = document.getElementById('companyCode')?.value;
      const empCode     = document.getElementById('onoff-empCode')?.value;
      if (!empCode) throw new Error('사원을 선택하세요.');

      const yy = document.getElementById('onoff-yy')?.value?.trim();
      const mm = String(document.getElementById('onoff-mm')?.value || '').padStart(2,'0');
      const dd = String(document.getElementById('onoff-dd')?.value || '').padStart(2,'0');
      const hh = String(document.getElementById('onoff-hh')?.value || '').padStart(2,'0');
      const mi = String(document.getElementById('onoff-mi')?.value || '').padStart(2,'0');
      if (!yy || !mm || !dd || !hh || !mi) throw new Error('시간(년/월/일/시/분)을 확인하세요.');

      const offTime = `${yy}-${mm}-${dd}T${hh}:${mi}:00`;

      const res = await fetch('/onoff/off', {
        method: 'POST',
        headers: { "Content-Type": "application/json", "X-CSRF-Token": token },
        body: JSON.stringify({ companyCode, empCode, offTime })
      });

      const text = await res.text();
      let payload; try { payload = JSON.parse(text); } catch { payload = { message: text }; }
      if (!res.ok) throw new Error(payload?.message || '퇴근 등록 실패');

      alert('퇴근하였습니다.');
      closeModalAndReload();
    } catch (err) {
      console.error(err);
      alert(err.message || '오류가 발생했습니다.');
    }
  });

  // 초기 1회
  fillNow();
})();
</script>
	</div>
</body>
</html>