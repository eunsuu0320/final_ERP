<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/main}">
<head>
<meta charset="UTF-8">
<title>사원 관리</title>
</head>
<body layout:fragment="content">
	<div id="layoutSidenav_content">
		<main>
			<div class="container-fluid px-4">
				<h1 class="mt-4">사원 관리</h1>
				<div class="d-flex align-items-center mb-3">
					<button id="btn-new" class="btn btn-primary me-2">신규</button>
					<select id="sel-field" class="form-select w-auto me-2">
						<option value="emp_no">사원번호</option>
						<option value="name">성명</option>
						<option value="dept">부서명</option>
					</select> <input id="txt-search" type="text"
						class="form-control w-auto me-2" placeholder="검색어 입력">
					<button id="btn-search" class="btn btn-warning me-2">검색</button>
					<button class="btn btn-secondary me-2">인쇄</button>
					<button class="btn btn-dark">이력조회</button>
				</div>

				<!-- 테이블 -->
				<div id="employee-table"></div>

			</div>
		</main>
	</div>

	<script>
	const table = new Tabulator("#employee-table", {
		layout : "fitColumns",
		pagination : "local",
		paginationSize : 50,
		selectable: true,
		columns : [ {
			  title: "선택",
			  formatter: "rowSelection",  // 체크박스
			  titleFormatter: "rowSelection", // 헤더에도 전체선택 체크박스
			  hozAlign: "center",
			  headerSort: false,
			  width: 44,                 // 기본 폭
			  hozAlign: "center",        // 바디 셀 가로 정렬
			  headerHozAlign: "center",  // 헤더 가로 정렬
			  cellClick: function(e, cell){
			    cell.getRow().toggleSelect();
			  }
			}, {
			title : "사원번호",
			field : "empNo",   // 엔티티 필드명과 매칭
		}, {
			title : "성명",
			field : "name",
		}, {
			title : "부서명",
			field : "dept"
		}, {
			title : "직급",
			field : "grade"
		}, {
			title : "직책",
			field : "position"
		}, {
			title : "전화번호",
			field : "phone"
		}, {
			title : "Email",
			field : "email"
		}, {
			title : "입사일자",
			field : "hireDate",
			sorter : "date",
			hozAlign : "center"
		}, ],
	});

	// 서버에서 전체 사원 조회 (fetch)
	fetch("/selectAllEmp")
		.then(res => res.json())
		.then(data => {
			table.setData(data);
		})
		.catch(err => console.error("데이터 불러오기 실패:", err));

	// 검색 버튼
	document.getElementById("btn-search").addEventListener("click", function() {
		const field = document.getElementById("sel-field").value;
		const keyword = document.getElementById("txt-search").value;

		if (keyword.trim() === "") {
			table.clearFilter();
		} else {
			table.setFilter(field, "like", keyword);
		}
	});

	// 신규 버튼 예시
	document.getElementById("btn-new").addEventListener("click", function() {
		alert("신규 등록 모달 띄우는 기능");
	});

	// 인쇄 버튼
	document.querySelector(".btn-secondary").addEventListener("click", function() {
	    const selected = table.getSelectedData();

	    if (selected.length === 0) {
	        alert("인쇄할 사원을 선택하세요.");
	        return;
	    }

	    // HTML 테이블 문자열로 출력 데이터 만들기
	    let printContents = `
	        <h3>선택된 사원 목록</h3>
	        <table border="1" cellspacing="0" cellpadding="5">
	          <thead>
	            <tr>
	              <th>사원번호</th>
	              <th>성명</th>
	              <th>부서명</th>
	              <th>직급</th>
	              <th>직책</th>
	              <th>전화번호</th>
	              <th>Email</th>
	              <th>입사일자</th>
	            </tr>
	          </thead>
	          <tbody>
	    `;

	    selected.forEach(emp => {
	        printContents += `
	          <tr>
	            <td>${emp.empNo}</td>
	            <td>${emp.name}</td>
	            <td>${emp.dept}</td>
	            <td>${emp.grade}</td>
	            <td>${emp.position}</td>
	            <td>${emp.phone}</td>
	            <td>${emp.email}</td>
	            <td>${emp.hireDate}</td>
	          </tr>
	        `;
	    });

	    printContents += `</tbody></table>`;

	    // 새 창 열고 인쇄 실행
	    const printWindow = window.open("", "_blank");
	    printWindow.document.write(printContents);
	    printWindow.document.close();
	    printWindow.print();
	});

</script>

</body>
</html>