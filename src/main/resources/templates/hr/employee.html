<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/main}">
<head>
<meta charset="UTF-8">
<title>사원 관리</title>
<link href="/hr/css/employee.css" rel="stylesheet" />
</head>
<body layout:fragment="content">
	<div id="layoutSidenav_content">
		<main>
			<div class="container-fluid px-4">
				<h1 class="mt-4">사원 관리</h1>

				<!-- ✅ companyCode는 한 번만 -->
				<input type="hidden" id="companyCode"
					th:value="${#authentication.name.split(':')[0]}">

				<div class="d-flex align-items-center mb-3">
					<select id="sel-field" class="form-select w-auto me-2">
						<option value="empCode">사원번호</option>
						<option value="name">성명</option>
						<option value="dept">부서명</option>
					</select> <input id="txt-search" type="text"
						class="form-control w-auto me-2" placeholder="검색어 입력">
					<button id="btn-search" class="btn btn-warning me-2">검색</button>

					<div class="ms-auto d-flex">
						<button id="btn-new" class="btn btn-primary me-2">신규</button>
						<button id="btn-update" class="btn btn-success me-2">수정</button>
						<button class="btn btn-secondary me-2">인쇄</button>
						<!-- ❌ 중복된 companyCode input 제거 -->
						<button id="btn-history" class="btn btn-dark">이력조회</button>
					</div>
				</div>

				<!-- 사원등록 모달 include -->
				<div th:replace="hr/employeeModal :: empModal"></div>

				<!-- 사원 테이블 -->
				<div id="employee-table"></div>

				<!-- 이력조회 모달 -->
				<div class="modal fade" id="historyModal"
					tabindex="-1" aria-hidden="true">
					<div class="modal-dialog modal-xl modal-dialog-centered">
						<div class="modal-content shadow-lg">
							<div class="modal-header">
								<h5 class="modal-title">사원 이력 조회</h5>
								<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
							</div>
							<div class="modal-body">
								<div id="history-table"></div>
							</div>
						</div>
					</div>
				</div>

			</div>
		</main>
	</div>

	<div th:replace="common/modal :: commonModal"></div>
	<script
		src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
	<script src="/hr/js/employee.js"></script>

	<script>
    // 우편번호 검색 전역 노출
    window.execDaumPostcode = function() {
      new daum.Postcode({
        oncomplete: function(data) {
          document.getElementById("postalCode").value = data.zonecode;
          document.getElementById("address").value = data.address;
        }
      }).open();
    };

    // ===== 이력조회 Tabulator =====
    const historyTable = new Tabulator("#history-table", {
      layout: "fitColumns",
      pagination: "local",
      paginationSize: 10,
      placeholder: "이력 데이터가 없습니다.",
      movableColumns: true,
      columns: [
        { title: "이력", field: "eventType", hozAlign: "center", width: 120 },
        { title: "사원", field: "name", hozAlign: "center", width: 120 },
        { title: "상세내용", field: "eventDetail" },
        { title: "담당자", field: "manager", hozAlign: "center", width: 120 },
        {
          title: "작업 일시",
          field: "createdAt",
          hozAlign: "center",
          width: 180,
          formatter: (cell) => {
            const v = cell.getValue();
            const d = v ? new Date(v) : null;
            return d && !isNaN(d.getTime()) ? d.toLocaleString() : "";
          }
        }
      ],
    });

    // 모달 표시 시 리사이즈/리렌더
    document.getElementById("historyModal")
      .addEventListener("shown.bs.modal", () => historyTable.redraw(true));

    // 공통: companyCode 읽기
    function getCompanyCode() {
      return document.getElementById("companyCode")?.value || "";
    }

    async function openHistoryModal(companyCode) {
    	  const url = `/api/history/${encodeURIComponent(companyCode)}`;
    	  const historyModalEl = document.getElementById("historyModal");
    	  const modal = bootstrap.Modal.getOrCreateInstance(historyModalEl);

    	  if (!historyModalEl.classList.contains("show")) modal.show();
    	  setTimeout(() => modal.handleUpdate && modal.handleUpdate(), 0);

    	  // 전역 로딩 표시
    	  showGlobalLoading("이력 불러오는 중...");

    	  try {
    	    const res = await fetch(url, { headers: { "Accept": "application/json" } });
    	    if (!res.ok) {
    	      const text = await res.text().catch(() => "");
    	      console.error("[history] HTTP", res.status, text?.slice(0, 300));
    	      alert("이력 조회 실패: 서버 오류가 발생했습니다.");
    	      await historyTable.setData([]);
    	      return;
    	    }

    	    const raw = await res.text();
    	    let payload;
    	    try { payload = JSON.parse(raw); } catch {
    	      alert("이력 조회 실패: 응답 형식이 올바르지 않습니다.");
    	      await historyTable.setData([]);
    	      return;
    	    }

    	    const rows = Array.isArray(payload) ? payload
    	               : Array.isArray(payload?.data) ? payload.data
    	               : Array.isArray(payload?.list) ? payload.list
    	               : Array.isArray(payload?.content) ? payload.content
    	               : null;

    	    if (!Array.isArray(rows)) {
    	      alert("이력 조회 실패: 응답이 목록 형식이 아닙니다.");
    	      await historyTable.setData([]);
    	      return;
    	    }

    	    await historyTable.setData(rows);
    	  } catch (err) {
    	    console.error("[history] 예외:", err);
    	    alert("이력 조회 중 오류가 발생했습니다.");
    	    await historyTable.setData([]);
    	  } finally {
    	    hideGlobalLoading();
    	    modal.handleUpdate && modal.handleUpdate();
    	  }
    	}

    // 버튼 클릭 → 이력조회
    document.getElementById("btn-history")?.addEventListener("click", () => {
      const cc = getCompanyCode();
      if (!cc) {
        alert("회사코드를 찾을 수 없습니다.");
        return;
      }
      openHistoryModal(cc);
    });
  </script>
</body>
</html>
