<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/main}">
<head>
<meta charset="UTF-8">
<title>사원 관리</title>
 <link href="/hr/css/employee.css" rel="stylesheet" />
</head>
<body layout:fragment="content">
	<div id="layoutSidenav_content">
		<main>
			<div class="container-fluid px-4">
				<h1 class="mt-4">사원 관리</h1>

				<input type="hidden" id="companyCode" th:value="${#authentication.name.split(':')[0]}">

				<div class="d-flex align-items-center mb-3">
					<select id="sel-field" class="form-select w-auto me-2">
						<option value="empCode">사원번호</option>
						<option value="name">성명</option>
						<option value="dept">부서명</option>
					</select> <input id="txt-search" type="text"
						class="form-control w-auto me-2" placeholder="검색어 입력">
					<button id="btn-search" class="btn btn-warning me-2">검색</button>
					 <div class="ms-auto d-flex">
					 	<button id="btn-new" class="btn btn-primary me-2">신규</button>
						<button id="btn-update" class="btn btn-success me-2">수정</button>
					    <button class="btn btn-secondary me-2">인쇄</button>
					    <input type="hidden" id="companyCode" th:value="${#authentication.name.split(':')[0]}">
					    <button class="btn btn-dark" onclick="openHistoryModal(document.getElementById('companyCode').value)">이력조회</button>
					 </div>
				</div>

				<!-- 모달 include -->
				<div th:replace="hr/employeeModal :: empModal"></div>

				<!-- 테이블 -->
				<div id="employee-table"></div>

				<!-- 이력조회 모달 -->
				<div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
				  <div class="modal-dialog modal-xl modal-dialog-centered">
				    <div class="modal-content shadow-lg">
				      <div class="modal-header">
				        <h5 class="modal-title">사원 이력 조회</h5>
				        <button type="button" class="btn-close btn-close" data-bs-dismiss="modal"></button>
				      </div>
				      <div class="modal-body">

				        <!-- Tabulator 테이블 영역 -->
				        <div id="history-table"></div>
				      </div>

				    </div>
				  </div>
				</div>

			</div>
		</main>
	</div>

	<div th:replace="common/modal :: commonModal"></div>
	<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
	<script src="/hr/js/employee.js"></script>
	<script>
	  // 전역에서 호출 가능하도록 window에 등록
	  window.execDaumPostcode = function() {
	    new daum.Postcode({
	      oncomplete: function(data) {
	        // 우편번호와 주소 세팅
	        document.getElementById("postalCode").value = data.zonecode; // 우편번호
	        document.getElementById("address").value = data.address;     // 기본 주소
	      }
	    }).open();
	  }

	  const modalEl = document.getElementById("historyModal");
	  modalEl.addEventListener("shown.bs.modal", () => {
	    historyTable.redraw(true); // ✅ 강제로 리사이즈/리렌더
	  });

	  // 이력조회 테이블
	  let historyTable = new Tabulator("#history-table", {
		  layout: "fitColumns",
		  pagination: "local",
		  paginationSize: 10,
		  movableColumns: true,
		  columns: [
		    { title: "이력", field: "eventType", hozAlign: "center" },
		    { title: "사원", field: "name", hozAlign: "center" },
		    { title: "상세내용", field: "eventDetail" },
		    { title: "담당자", field: "manager", hozAlign: "center" },
		    {
		      title: "작업 일시",
		      field: "createdAt",
		      hozAlign: "center",
		      formatter: function(cell) {
		        const val = cell.getValue();
		        return val ? new Date(val).toLocaleString() : "";
		      }
		    }
		  ]
		});

	  function openHistoryModal(companyCode) {
		  fetch(`/api/history/${companyCode}`)
		    .then(res => res.json())
		    .then(data => {
		      historyTable.setData(data).then(() => {
		        // ✅ 데이터 로딩 끝난 후 모달 열기
		        const modal = new bootstrap.Modal(document.getElementById("historyModal"));
		        modal.show();
		      });
		    })
		    .catch(err => {
		      console.error("이력 조회 실패:", err);
		      alert("이력 조회 중 오류가 발생했습니다.");
		    });
		}



	</script>

</body>
</html>