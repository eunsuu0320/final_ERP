<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
	<!-- 사원 신규등록 모달 -->
	<div th:fragment="empModal">
		<div class="modal fade" id="empModal" tabindex="-1" aria-hidden="true">
			<div class="modal-dialog modal-xl">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="empModalTitle">사원 등록</h5>

						<div>
							<button type="button" class="btn btn-primary me-2" id="btn-save-emp">저장</button>
							<button type="button" class="btn btn-outline-dark me-2" id="btn-save-reset">초기화</button>
							<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
						</div>
					</div>

					<div class="modal-body">
						<!-- 탭 -->
						<ul class="nav nav-tabs" id="empTab" role="tablist">
							<li class="nav-item">
								<button class="nav-link active" id="basic-tab"
									data-bs-toggle="tab" data-bs-target="#basicInfo" type="button">기본정보</button>
							</li>
							<li class="nav-item">
								<button class="nav-link" id="contract-tab" data-bs-toggle="tab"
									data-bs-target="#contractInfo" type="button">근로계약서</button>
							</li>
						</ul>

						<!-- 탭 콘텐츠 -->
						<div class="tab-content mt-3">
							<!-- 기본정보 탭 -->
							<div class="tab-pane fade show active" id="basicInfo">
								<form id="empForm">
									<div class="row mb-3">
										<div class="col-md-4">
											<label class="form-label required">사원번호</label>
											<input readonly type="text" id="empCode" name="empCode" class="form-control" placeholder="등록 시 자동 입력 됩니다.">
											<!-- <input type="text" name="empCode" id="empCode" class="form-control" required readonly placeholder="자동으로 입력됩니다.">-->
										</div>
										<div class="col-md-4">
											<label class="form-label required">성명</label>
											<input required type="text" name="name" id="name" class="form-control">
										</div>
										<div class="col-md-4">
											<label class="form-label required">전화번호</label>
											<input required type="text" name="phone" id="phone" class="form-control">
										</div>
									</div>

									<div class="row mb-3">
										<div class="col-md-6">
											<label class="form-label required">생년월일</label>
											<input required type="date" name="birth" id="birth" class="form-control">
										</div>
										<div class="col-md-6">
											<label class="form-label required">이메일</label>
											<input required type="email" name="email" id="email" class="form-control">
										</div>
									</div>

									<div class="row mb-3">
										<div class="col-md-4">
											<label class="form-label required">부서</label>
											<select id="dept" name="dept" class="form-control"></select>
										</div>
										<div class="col-md-4">
											<label class="form-label required">직급</label>
											<select id="grade" name="grade" class="form-control"></select>
										</div>
										<div class="col-md-4">
											<label class="form-label required">직책</label>
											<select id="position" name="position" class="form-control"></select>
										</div>
									</div>

									<div class="row mb-3">
										<div class="col-md-6">
											<label class="form-label required">기본급</label>
											<input required type="number" name="salary" id="salary" class="form-control">
										</div>
										<div class="col-md-6">
											<label class="form-label required">휴가일수</label>
											<input required type="number" name="holyDays" id="holyDays" class="form-control">
										</div>
									</div>

									<div class="row mb-3">
										<div class="col-md-6">
											<label class="form-label required">입사일자</label>
											<input required type="date" name="hireDate" id="hireDate" class="form-control">
										</div>
										<div class="col-md-6">
											<label class="form-label">퇴사일자</label>
											<input type="date" name="resignDate" id="resignDate" class="form-control">
										</div>
									</div>

									<div class="row mb-3">
										<div class="col-md-6">
											<label class="form-label required">부양가족수</label>
											<input required type="number" name="depCnt" id="depCnt" class="form-control">
										</div>
										<div class="col-md-6">
											<label class="form-label">퇴사사유</label>
											<input type="text" name="resignReason" id="resignReason" class="form-control">
										</div>
									</div>

									<div class="row mb-3">
										<div class="col-md-4">
											<label class="form-label required">은행</label>
											<input type="hidden" id="bankCode" name="bankCode">
											<input type="text" id="bankCodeName" class="form-control" onclick="openModal(
										      'commonCode',
										      function(selected) {
										        document.getElementById('bankCodeName').value = selected.codeName;
										        document.getElementById('bankCode').value = selected.codeId;
										      }, 'GRP015')">
										</div>
										<div class="col-md-4">
											<label class="form-label required">예금주</label>
											<input required type="text" name="accHolder" id="accHolder" class="form-control">
										</div>
										<div class="col-md-4">
											<label class="form-label required">계좌번호</label>
											<input required type="text" name="accNo" id="accNo" class="form-control">
										</div>
									</div>

									<div class="row mb-3">
										<div class="col-md-3">
											<label class="form-label required">우편번호</label>
											<input required type="number" name="postalCode" id="postalCode" class="form-control" readonly onclick="execDaumPostcode()">
										</div>
										<div class="col-md-9">
											<label class="form-label required">주소</label>
											<input required type="text" name="address" id="address" class="form-control">
										</div>
									</div>
								</form>
							</div>

							<!-- 근로계약서 탭 -->
							<div class="tab-pane fade" id="contractInfo">
								<form id="contractForm" method="post"
									enctype="multipart/form-data">

									<!-- PDF 보기 + 불러오기 -->
									<div
										class="d-flex justify-content-between align-items-center mb-2">
										<small class="text-muted"> * 뷰어에서 작성 후 “다운로드/저장” → 아래
											버튼으로 파일을 불러오세요. </small>
										<div>
											<button type="button" id="btn-pdf-pick"
												class="btn btn-outline-secondary btn-sm">PDF 불러오기</button>
										</div>
									</div>

									<div class="mb-3" style="height: 32.55rem;">
										<iframe src="/hr/pdf/contract.pdf"
											style="width: 100%; height: 100%; border: 1px solid #ddd;"
											frameborder="0"></iframe>
									</div>

									<!-- 사용자가 저장한 PDF 업로드 -->
									<input type="file" id="pdfFile" name="pdfFile"
										accept="application/pdf" style="display: none;" />
									<div id="pdfFileName" class="small text-success"
										style="min-height: 1.25rem;"></div>

									<!-- 사원 서명 -->
									<div class="row mb-3" style="margin-top: 1rem; width: 100%;">
										<label class="form-label">사원 서명</label>
										<canvas id="signature-pad"
											style="width: 100%; height: 10rem; margin-left: 0.8rem; border: 1px solid #000;"></canvas>
										<input type="hidden" name="cSign" id="cSign">
										<div
											class="mt-2 d-flex justify-content-between align-items-center">
											<div>
												<button type="button" id="clear-sign"
													class="btn btn-secondary btn-sm">지우기</button>
											</div>
											<div class="form-check">
												<input class="form-check-input me-2" type="checkbox"
													id="agreeContract" name="agreeContract"> <label
													class="form-check-label" for="agreeContract">계약 내용에
													동의합니다.</label>
											</div>
										</div>
									</div>
								</form>
							</div>
						</div>
						</form>
					</div>
				</div>
			</div>
		</div>
		<script
			src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>
		<script type="text/javascript">
	const canvas = document.getElementById("signature-pad");
	const signaturePad = new SignaturePad(canvas);

	function resizeCanvas() {
		  const ratio = Math.max(window.devicePixelRatio || 1, 1);
		  canvas.width = canvas.offsetWidth * ratio;
		  canvas.height = canvas.offsetHeight * ratio;
		  canvas.getContext("2d").scale(ratio, ratio);
		}

	// ✅ 모달 열릴 때: 'create' 에서만 초기화/코드조회 실행
	document.getElementById("empModal").addEventListener("shown.bs.modal", function (e) {
	  // 모드 판별: 버튼 data-mode → 모달 data-mode → 기본 'edit'
	  const trigger = e.relatedTarget;
	  const mode =
	    trigger?.getAttribute("data-mode") ||
	    this.getAttribute("data-mode") ||
	    "edit";

	  // 공통(필요하면 캔버스 크기만 갱신)
	  resizeCanvas();

	  if (mode !== "create") {
	    // 조회/수정 모드에서는 초기화/코드조회 금지 (이미 setModalMode()/getCode()에서 세팅함)
	    return;
	  }

	  // ↓↓↓ 신규 모드에서만 실행
	  document.getElementById("dept").innerHTML = '';
	  document.getElementById("position").innerHTML = '';
	  document.getElementById("grade").innerHTML = '';
	  signaturePad.clear();
	  // 코드 로딩(신규이므로 선택값 없음)
	  getCode('GRP013', 'position'); // 직책
	  getCode('GRP010', 'grade');    // 직급
	  getCode('GRP011', 'dept');     // 부서
	});


	// 탭 전환될 때 (근로계약서 탭 들어갈 때)
	document.getElementById("contract-tab").addEventListener("shown.bs.tab", function () {
	  resizeCanvas();
	  signaturePad.clear();
	});

	// 지우기 버튼
	document.getElementById("clear-sign").addEventListener("click", function () {
	  signaturePad.clear();
	});

	 // PDF 불러오기 버튼 → 파일 선택
	  document.getElementById("btn-pdf-pick").addEventListener("click", function () {
	    document.getElementById("pdfFile").click();
	  });

	  // 파일 선택되면 파일명 표시
	  document.getElementById("pdfFile").addEventListener("change", function (e) {
	    const file = e.target.files && e.target.files[0];
	    const label = document.getElementById("pdfFileName");
	    label.textContent = file ? `선택됨: ${file.name}` : "";
	  });

	  const header = document.querySelector('meta[name="_csrf_header"]').content;
	  const token = document.querySelector('meta[name="_csrf"]').content;

	// 저장
	  document.getElementById("btn-save-emp").addEventListener("click", function () {
		const modalEl = document.getElementById("empModal");
	 	const mode = modalEl?.dataset.mode;
		console.log("현재 모드:", mode); // ← 확인용

	    const empForm = document.getElementById("empForm");
	    const contractForm = document.getElementById("contractForm");
	    const pdfInput = document.getElementById("pdfFile");

	 // 신규 등록일 때만 PDF/서명 필수
	    if (mode === "create") {
	      if (!pdfInput.files || pdfInput.files.length === 0) {
	        alert("계약서 PDF를 먼저 뷰어에서 저장한 뒤, [PDF 불러오기]로 선택해 주세요.");
	        return;
	      }
	      if (!document.getElementById("agreeContract").checked) {
	        alert("계약 내용 동의에 체크해 주세요.");
	        return;
	      }
	    }

	    // 3) 사인 이미지 Base64 → Blob
	    const formData = new FormData(empForm);
	    new FormData(contractForm).forEach((value, key) => formData.append(key, value));

	 	// PDF/서명 선택했을 때만 append
	    if (pdfInput.files && pdfInput.files.length > 0) {
	      formData.append("pdfFile", pdfInput.files[0]);
	    }

	    const dataURL = signaturePad.toDataURL("image/png");
	    document.getElementById("cSign").value = dataURL;
	    if (dataURL) {
	      const byteString = atob(dataURL.split(',')[1]);
	      const mimeString = dataURL.split(',')[0].split(':')[1].split(';')[0];
	      const ab = new ArrayBuffer(byteString.length);
	      const ia = new Uint8Array(ab);
	      for (let i = 0; i < byteString.length; i++) ia[i] = byteString.charCodeAt(i);
	      const blob = new Blob([ab], { type: mimeString });
	      formData.append("signImg", blob, "signature.png");
	    }

	    // 엔드포인트 분기 url로 나눠서 저장버튼 분리?
	    const url = (mode === "edit") ? "/updateEmployee" : "/saveContract";

	    // 4) 전송
	    fetch(url, {
	      method: "POST",
	      headers: {'X-CSRF-Token': token},
	      body: formData
	    })
	      .then(res => res.text())
	      .then(data => {
	    	  console.log("서버 응답:", data);
	    	  data = data.trim();
	        if (data === "success") {
	          alert(mode === "edit" ? "사원 정보가 수정되었습니다." : "사원이 등록되었습니다.");
	          const modal = bootstrap.Modal.getInstance(document.getElementById("empModal"));
	          modal && modal.hide();
	          refreshEmployeeTable();
	        } else {
	          alert("사원 등록에 실패하였습니다. " + data);
	        }
	      })
	      .catch(err => {
	        console.error("저장 오류:", err);
	        alert("서버에 오류가 생겼습니다. 다시 시도해 주세요.");
	      });
	  });

	  // ✅ 사원 테이블 리로드 (전역 table 또는 window.tabled 사용 모두 대응)
	  async function refreshEmployeeTable() {
	    try {
	      const companyCode = document.getElementById("companyCode")?.value || "";
	      const res = await fetch(`/employees?companyCode=${encodeURIComponent(companyCode)}`);
	      const data = await res.json();

	      // 1) 페이지에서 전역으로 쓰는 이름이 table인 경우
	      if (window.table && typeof window.table.setData === "function") {
	        window.table.setData(data);
	        return;
	      }
	      // 2) window.tabled 로 보관한 경우(이전 코드에서 사용)
	      if (window.tabled && typeof window.tabled.setData === "function") {
	        window.tabled.setData(data);
	        return;
	      }
	      // 3) 혹시라도 두 전역이 없다면 ID로 탐색 시도
	      const t = Tabulator.prototype.findTable?.("#employee-table")?.[0];
	      if (t && typeof t.setData === "function") {
	        t.setData(data);
	      }
	    } catch (e) {
	      console.error("[refreshEmployeeTable] 실패:", e);
	    }
	  }
	</script>
	</div>
</body>
</html>